<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒêƒÉng K√Ω, Ph√¢n Quy·ªÅn, ƒêi·ªÅu ƒê·ªông & Th√¥ng B√°o N·ªôi B·ªô (N√¢ng c·∫•p)</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .scrollable-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
      /* subtle modal animation fallback */
      .fade-scale-enter {
        transform: scale(0.98);
        opacity: 0;
      }
      .fade-scale-enter-active {
        transform: scale(1);
        opacity: 1;
        transition: all 180ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .fade-scale-leave {
        transform: scale(1);
        opacity: 1;
      }
      .fade-scale-leave-active {
        transform: scale(0.98);
        opacity: 0;
        transition: all 120ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
    </style>
  </head>

  <body class="min-h-screen flex items-center justify-center p-4">
    <!-- Container Ch√≠nh -->
    <div
      id="main-container"
      class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-8 transition-all duration-300"
    >
      <!-- Khu v·ª±c Th√¥ng b√°o L·ªói/Th√†nh c√¥ng -->
      <div
        id="message-box"
        class="hidden p-3 mb-4 rounded-lg text-sm font-medium"
        role="alert"
      ></div>

      <!-- 1. Giao di·ªán X√°c th·ª±c (ƒêƒÉng nh·∫≠p) -->
      <div id="auth-view" class="w-full max-w-md mx-auto">
        <h1
          id="auth-title"
          class="text-3xl font-bold text-center text-gray-800 mb-6"
        >
          ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng
        </h1>

        <form id="auth-form" onsubmit="handleAuth(event)">
          <div class="mb-4">
            <label
              for="email"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Email</label
            >
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
              placeholder="your.email@gmail.com"
            />
          </div>
          <div class="mb-6">
            <label
              for="password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >M·∫≠t kh·∫©u</label
            >
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="6"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
              placeholder="M·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±)"
            />
          </div>

          <button
            type="submit"
            id="auth-button"
            class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150"
          >
            ƒêƒÉng Nh·∫≠p
          </button>
        </form>
      </div>

      <!-- 2. Giao di·ªán Ch√≠nh (Sau khi ƒëƒÉng nh·∫≠p) -->
      <div id="main-app-view" class="hidden">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
          <h1 class="text-2xl font-bold text-gray-800">
            Xin Ch√†o, <span id="user-email" class="text-indigo-600"></span>!
          </h1>
          <div class="flex items-center gap-3">
            <button
              onclick="logoutUser()"
              class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 text-sm"
            >
              ƒêƒÉng Xu·∫•t
            </button>
            <!-- N√∫t K·∫ø to√°n (hi·ªÉn th·ªã cho giamdoc + ketoan) -->
            <button
              id="open-accounting-btn"
              onclick="openAccountingView()"
              class="hidden py-2 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-150 text-sm"
            >
              K·∫ø to√°n
            </button>
          </div>
        </div>

        <p class="text-sm text-gray-500 mb-6">
          UID:
          <span
            id="user-uid"
            class="font-mono text-xs bg-gray-100 p-1 rounded"
          ></span>
        </p>

        <!-- KHU V·ª∞C TH√îNG TIN VAI TR√í C√Å NH√ÇN -->
        <div id="user-role-info" class="bg-indigo-50 p-4 rounded-lg mb-6">
          <p class="text-lg font-semibold text-indigo-700">Vai tr√≤ hi·ªán t·∫°i:</p>
          <p
            id="current-role"
            class="text-xl font-extrabold text-indigo-900 mt-1"
          >
            ƒêang t·∫£i...
          </p>
          <p id="current-department" class="text-sm text-indigo-700 mt-1">
            Ph√≤ng ban:
            <span class="font-bold text-indigo-900">ƒêang t·∫£i...</span>
          </p>
        </div>

        <div class="mb-6 mt-6">
          <button
            onclick="openViewNotificationsView()"
            class="py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 w-full"
          >
            Xem Th√¥ng B√°o C√¥ng Ty
          </button>
        </div>
        <button
          id="open-management-btn"
          onclick="openSystemManagementView()"
          class="hidden py-3 px-6 bg-purple-600 text-white font-semibold rounded-lg shadow-xl hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 mt-6 w-full"
        >
          Ch·ª©c nƒÉng Qu·∫£n l√Ω H·ªá th·ªëng
        </button>
      </div>
    </div>

    <!-- 3. GIAO DI·ªÜN QU·∫¢N L√ù H·ªÜ TH·ªêNG -->
    <div
      id="system-management-view"
      class="fixed inset-0 bg-gray-50/95 hidden flex-col p-4 z-40 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-6">
          <h2 class="text-2xl font-bold text-gray-800">
            Giao di·ªán Qu·∫£n L√Ω H·ªá Th·ªëng
          </h2>
          <button
            onclick="closeSystemManagementView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-600 mb-8">
          Vui l√≤ng ch·ªçn ch·ª©c nƒÉng qu·∫£n l√Ω b·∫°n mu·ªën th·ª±c hi·ªán.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <button
            onclick="openUserManagementView()"
            class="flex flex-col items-center justify-center p-6 bg-indigo-600 text-white font-semibold rounded-xl shadow-xl hover:bg-indigo-700 transition duration-150 h-36"
          >
            <!-- icon -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-8 h-8 mb-2"
            >
              <path
                fill-rule="evenodd"
                d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="text-lg">Qu·∫£n L√Ω T√†i Kho·∫£n Ng∆∞·ªùi D√πng</span>
          </button>

          <button
            onclick="openPersonnelDeploymentView()"
            class="flex flex-col items-center justify-center p-6 bg-yellow-600 text-white font-semibold rounded-xl shadow-xl hover:bg-yellow-700 transition duration-150 h-36"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-8 h-8 mb-2"
            >
              <path
                fill-rule="evenodd"
                d="M3 3a1.5 1.5 0 0 0-1.5 1.5v13.5a1.5 1.5 0 0 0 1.5 1.5H18a1.5 1.5 0 0 0 1.5-1.5V10.5a1.5 1.5 0 0 0-1.5-1.5H3.75a.75.75 0 0 1 0-1.5H21a.75.75 0 0 0 0-1.5H3a.75.75 0 0 1 0-1.5ZM12.375 16.5a.75.75 0 0 0 .53-1.28L10.5 13.5l2.405-2.72a.75.75 0 1 0-1.11-1.04l-3 3.375a.75.75 0 0 0 0 1.04l3 3.375a.75.75 0 0 0 .58.28Z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="text-lg">ƒêi·ªÅu ƒê·ªông Nh√¢n s·ª±</span>
          </button>

          <button
            onclick="openNotificationManagementView()"
            class="flex flex-col items-center justify-center p-6 bg-green-600 text-white font-semibold rounded-xl shadow-xl hover:bg-green-700 transition duration-150 h-36"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-8 h8 mb-2"
            >
              <path
                d="M5.566 1.657A41.01 41.01 0 0 0 12 2c2.204 0 4.343.155 6.434.407l-.468-.934a1.2 1.2 0 0 0-1.07-1.11L12 1.011 7.102 1.657a1.2 1.2 0 0 0-1.07 1.11l-.466.931ZM12 4c2.613 0 4.945.727 6.434 1.407L12 23l-6.434-17c1.488-.68 3.821-1.407 6.434-1.407ZM14.062 18.5a.75.75 0 0 0-.847-.075L12 17.587l-1.215.838a.75.75 0 0 0 .141 1.231c.42.155.845.289 1.274.405l.07.02v.005a1.5 1.5 0 0 0 2.25 0 1.498 1.498 0 0 0 .341-1.554l-.499-1.004Z"
              />
            </svg>
            <span class="text-lg">Qu·∫£n L√Ω Th√¥ng B√°o</span>
          </button>
        </div>

        <div class="flex justify-end pt-4 mt-8 border-t">
          <button
            onclick="closeSystemManagementView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay l·∫°i M√†n h√¨nh ch√≠nh
          </button>
        </div>
      </div>
    </div>

    <!-- 4. GIAO DI·ªÜN QU·∫¢N L√ù T√ÄI KHO·∫¢N NG∆Ø·ªúI D√ôNG -->
    <div
      id="user-management-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        id="user-management-content"
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">
            Qu·∫£n L√Ω T√†i Kho·∫£n Ng∆∞·ªùi D√πng
          </h2>
          <button
            onclick="closeUserManagementView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">
            1. T·∫°o T√†i Kho·∫£n M·ªõi
          </h3>
          <form onsubmit="createNewUserByDirector(event)">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <input
                type="email"
                id="new-email"
                required
                placeholder="Email"
                class="p-2 border rounded-lg"
              />
              <input
                type="password"
                id="new-password"
                required
                minlength="6"
                placeholder="M·∫≠t kh·∫©u (>= 6 k√Ω t·ª±)"
                class="p-2 border rounded-lg"
              />
              <select
                id="new-role"
                required
                class="p-2 border rounded-lg bg-white"
              >
                <option value="" disabled selected>Ch·ªçn vai tr√≤</option>
                <option value="nhanvien">Nh√¢n vi√™n</option>
                <option value="quanlynhansu">Qu·∫£n l√Ω nh√¢n s·ª±</option>
                <option value="ketoan">K·∫ø to√°n</option>
                <option value="quanlyhethong">Qu·∫£n l√Ω h·ªá th·ªëng</option>
                <option value="giamdoc">Gi√°m ƒë·ªëc</option>
              </select>
            </div>
            <button
              type="submit"
              class="w-full mt-3 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150"
            >
              T·∫°o T√†i Kho·∫£n
            </button>
          </form>
        </div>

        <h3 class="text-xl font-semibold text-gray-700 mb-3">
          2. Danh S√°ch T√†i Kho·∫£n
        </h3>
        <div id="user-list-container" class="scrollable-list p-2 bg-white">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Email
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Vai tr√≤
                </th>
                <th
                  class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Tr·∫°ng th√°i
                </th>
                <th
                  class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Thao t√°c
                </th>
              </tr>
            </thead>
            <tbody
              id="user-list-body"
              class="bg-white divide-y divide-gray-200 text-sm"
            >
              <tr>
                <td colspan="4" class="text-center py-4 text-gray-500">
                  ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closeUserManagementView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay l·∫°i Giao di·ªán Qu·∫£n l√Ω H·ªá th·ªëng
          </button>
        </div>
      </div>
    </div>

    <!-- sua  -->
    <div
      id="profile-modal"
      class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm hidden items-center justify-center p-4 z-60"
    >
      <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-sm lg:max-w-md p-6 relative transform transition-all"
        style="background: linear-gradient(135deg, #fff0f5 0%, #ffffff 100%)"
      >
        <button
          onclick="closeProfileModal()"
          class="absolute top-4 right-4 text-3xl text-gray-400 hover:text-gray-600 transition-colors"
        >
          &times;
        </button>
        <div id="profile-content" class="flex flex-col items-center gap-6">
          <div class="relative">
            <img
              id="profile-avatar"
              class="w-32 h-32 rounded-full object-cover ring-4 ring-pink-300 shadow-lg hidden"
              src=""
              alt="Avatar"
            />
            <div
              id="profile-status-badge"
              class="absolute bottom-0 right-0 w-5 h-5 bg-green-500 rounded-full border-2 border-white"
            ></div>
          </div>

          <h3 class="text-2xl font-extrabold text-pink-700" id="profile-name">
            H·ªç T√™n: Ch·ªù c·∫≠p nh·∫≠t
          </h3>

          <div class="w-full text-sm space-y-3">
            <div class="grid grid-cols-2 gap-x-4 gap-y-3">
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>M√£ NS</b>
                <div id="profile-mans" class="font-medium text-gray-800">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>Ch·ª©c v·ª•</b>
                <div id="profile-role" class="font-medium text-gray-800">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>Ph√≤ng ban</b>
                <div id="profile-dept" class="font-medium text-gray-800">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>D·ª± √°n</b>
                <div id="profile-project" class="font-medium text-gray-800">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-3 pt-2 border-t border-pink-100">
              <div class="text-xs">
                <b>Ng√†y sinh</b>
                <div id="profile-dob" class="text-gray-600 mt-1">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
              <div class="text-xs">
                <b>Gi·ªõi t√≠nh</b>
                <div id="profile-gender" class="text-gray-600 mt-1">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
              <div class="text-xs">
                <b>Ng√†y v√†o l√†m</b>
                <div id="profile-join" class="text-gray-600 mt-1">
                  Ch·ªù c·∫≠p nh·∫≠t
                </div>
              </div>
            </div>
          </div>

          <div class="w-full text-right pt-4 border-t border-pink-100">
            <div
              class="inline-flex items-center text-sm font-semibold text-pink-600 bg-pink-100 px-3 py-1 rounded-full mr-4"
            >
              Quy·ªÅn: <span id="profile-perm" class="ml-1">Ch·ªù c·∫≠p nh·∫≠t</span>
            </div>
            <button
              onclick="closeProfileModal()"
              class="py-2 px-5 bg-pink-600 text-white rounded-xl shadow-md hover:bg-pink-700 transition-colors"
            >
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="hr-management-view"
      class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex-col p-4 z-60 overflow-y-auto"
    >
      <div
        class="w-full max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl p-8 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-start border-b pb-4 mb-6">
          <div>
            <h2 class="text-3xl font-extrabold text-gray-800">
              Qu·∫£n l√Ω Nh√¢n s·ª±
            </h2>
            <p class="text-gray-500 mt-1">
              Ph√¢n h·ªá qu·∫£n l√Ω th√¥ng tin, duy·ªát ƒë∆°n v√† theo d√µi tr·∫°ng th√°i nh√¢n
              vi√™n.
            </p>
          </div>
          <button
            onclick="closeHRManagementView()"
            class="text-gray-400 hover:text-gray-600 text-4xl font-light leading-none transition-colors"
          >
            &times;
          </button>
        </div>

        <div class="mb-6 flex gap-3 border-b border-gray-200">
          <button
            id="hr-tab-update"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-indigo-600 text-white"
            onclick="showHRTab('update')"
          >
            üë• C·∫≠p nh·∫≠t th√¥ng tin
          </button>
          <button
            id="hr-tab-requests"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            onclick="showHRTab('requests')"
          >
            üìù Duy·ªát ƒë∆°n
          </button>
          <button
            id="hr-tab-status"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            onclick="showHRTab('status')"
          >
            üö¶ Theo d√µi tr·∫°ng th√°i
          </button>
          <button
            id="hr-tab-report"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            onclick="showHRTab('report')"
          >
            üìà Xu·∫•t b√°o c√°o
          </button>
        </div>

        <div id="hr-tab-update-panel">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Danh s√°ch t√†i kho·∫£n (C·∫≠p nh·∫≠t)
          </h3>
          <div class="scrollable-list rounded-lg border overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Email
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    M√£ NS
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    H·ªç t√™n
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Ph√≤ng ban
                  </th>
                  <th
                    class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Thao t√°c
                  </th>
                </tr>
              </thead>
              <tbody
                id="hr-user-list-body"
                class="bg-white divide-y divide-gray-100 text-sm"
              >
                <tr>
                  <td colspan="5" class="text-center py-8 text-gray-400">
                    ƒêang t·∫£i d·ªØ li·ªáu nh√¢n s·ª±...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="hr-tab-requests-panel" class="hidden">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Duy·ªát ƒê∆°n Xin ngh·ªâ & TƒÉng ca (Ch·ªù duy·ªát)
          </h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="border rounded-xl p-4 bg-red-50">
              <h4 class="font-bold text-lg mb-3 text-red-700 border-b pb-2">
                ƒê∆°n xin ngh·ªâ
              </h4>
              <div
                id="hr-leave-list"
                class="space-y-3 max-h-96 overflow-y-auto text-sm"
              >
                <p class="text-center py-10 text-gray-500">
                  Ch∆∞a c√≥ ƒë∆°n xin ngh·ªâ ƒëang ch·ªù duy·ªát.
                </p>
              </div>
            </div>
            <div class="border rounded-xl p-4 bg-blue-50">
              <h4 class="font-bold text-lg mb-3 text-blue-700 border-b pb-2">
                ƒê∆°n tƒÉng ca
              </h4>
              <div
                id="hr-ot-list"
                class="space-y-3 max-h-96 overflow-y-auto text-sm"
              >
                <p class="text-center py-10 text-gray-500">
                  Ch∆∞a c√≥ ƒë∆°n tƒÉng ca ƒëang ch·ªù duy·ªát.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div id="hr-tab-status-panel" class="hidden">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Theo d√µi t√¨nh tr·∫°ng nh√¢n vi√™n hi·ªán t·∫°i
          </h3>
          <div class="scrollable-list rounded-lg border overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Email
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    M√£ NS
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    H·ªç t√™n
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Tr·∫°ng th√°i
                  </th>
                </tr>
              </thead>
              <tbody
                id="hr-status-body"
                class="bg-white divide-y divide-gray-100 text-sm"
              >
                <tr>
                  <td colspan="4" class="text-center py-8 text-gray-400">
                    ƒêang t·∫£i tr·∫°ng th√°i...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="hr-tab-report-panel" class="hidden">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Xu·∫•t b√°o c√°o nh√¢n s·ª± t·ªïng h·ª£p
          </h3>
          <div class="p-6 bg-gray-50 border rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
              <div class="space-y-1">
                <label
                  for="hr-report-date"
                  class="block text-sm font-medium text-gray-700"
                  >Ng√†y b√°o c√°o</label
                >
                <input
                  type="date"
                  id="hr-report-date"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div class="space-y-1 md:col-span-2">
                <label
                  for="hr-report-title"
                  class="block text-sm font-medium text-gray-700"
                  >Ti√™u ƒë·ªÅ / N·ªôi dung ng·∫Øn</label
                >
                <input
                  type="text"
                  id="hr-report-title"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="B√°o c√°o t·ªïng h·ª£p th√°ng..."
                />
              </div>
            </div>
            <button
              id="hr-generate-report-btn"
              class="py-2 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
              onclick="hrGenerateReport()"
            >
              <i class="fas fa-file-export"></i> Xu·∫•t b√°o c√°o & G·ª≠i cho Gi√°m ƒë·ªëc
            </button>
          </div>

          <div
            id="hr-report-result"
            class="mt-6 p-4 bg-white rounded-xl shadow-lg border border-gray-200"
          >
            <p class="text-base text-gray-500 font-medium">
              K·∫øt qu·∫£ b√°o c√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi t·∫°o.
            </p>
          </div>
        </div>

        <div class="flex justify-end pt-6 mt-8 border-t border-gray-200">
          <button
            onclick="closeHRManagementView()"
            class="py-2 px-5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
          >
            Quay l·∫°i
          </button>
        </div>
      </div>
    </div>

    <div
      id="employee-register-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-60"
    >
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">
        <button
          onclick="closeEmployeeRegisterModal()"
          class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-gray-600 transition-colors"
        >
          &times;
        </button>
        <h3 class="text-2xl font-bold mb-5 text-indigo-700">
          ƒêƒÉng k√Ω ƒê∆°n t·ª´ (Nh√¢n vi√™n)
        </h3>

        <div class="flex gap-3 mb-6 border-b pb-3">
          <button
            onclick="showEmployeeRegisterForm('leave')"
            class="py-2 px-5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
          >
            ƒêƒÉng k√Ω xin ngh·ªâ
          </button>
          <button
            onclick="showEmployeeRegisterForm('ot')"
            class="py-2 px-5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
          >
            ƒêƒÉng k√Ω tƒÉng ca
          </button>
        </div>

        <form
          id="employee-leave-form"
          class="space-y-4"
          onsubmit="submitLeaveRequest(event)"
        >
          <p class="text-sm text-gray-500 border-b pb-2">
            Vui l√≤ng ƒëi·ªÅn th√¥ng tin xin ngh·ªâ chi ti·∫øt.
          </p>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="leave-mans"
              placeholder="M√£ NS"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
            <input
              id="leave-name"
              placeholder="H·ªç t√™n"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="leave-start"
              type="date"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
            <input
              id="leave-end"
              type="date"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <textarea
            id="leave-reason"
            placeholder="L√Ω do xin ngh·ªâ (T·ªëi ƒëa 250 k√Ω t·ª±)"
            class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none"
            maxlength="250"
            required
          ></textarea>

          <div class="text-right pt-2">
            <button
              class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg shadow-lg hover:bg-red-700 transition-colors"
            >
              G·ª≠i ƒë∆°n xin ngh·ªâ
            </button>
          </div>
        </form>

        <form
          id="employee-ot-form"
          class="hidden space-y-4"
          onsubmit="submitOTRequest(event)"
        >
          <p class="text-sm text-gray-500 border-b pb-2">
            Vui l√≤ng ƒëi·ªÅn th√¥ng tin tƒÉng ca chi ti·∫øt.
          </p>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="ot-name"
              placeholder="H·ªç t√™n"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
            <input
              id="ot-mans"
              placeholder="M√£ NS"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="ot-date"
              type="date"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
            <input
              id="ot-hours"
              type="number"
              min="1"
              max="12"
              placeholder="S·ªë gi·ªù tƒÉng ca"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
          </div>

          <div class="text-right pt-2">
            <button
              class="py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
            >
              G·ª≠i ƒëƒÉng k√Ω tƒÉng ca
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="hr-edit-profile-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-70"
    >
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
        <button
          onclick="closeHREditProfileModal()"
          class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-gray-600 transition-colors"
        >
          &times;
        </button>
        <h3 class="text-xl font-bold mb-5 text-emerald-700 border-b pb-2">
          C·∫≠p nh·∫≠t th√¥ng tin nh√¢n s·ª±
        </h3>

        <div class="grid grid-cols-1 gap-4">
          <input id="edit-uid" type="hidden" />

          <div class="grid grid-cols-2 gap-4">
            <input
              id="edit-mans"
              placeholder="M√£ NS"
              class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
            />
            <input
              id="edit-name"
              placeholder="H·ªç t√™n"
              class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
            />
          </div>

          <select
            id="edit-role"
            class="p-3 border border-gray-300 rounded-lg bg-white focus:border-emerald-500 focus:ring-emerald-500"
          >
            <option value="nhanvien">Nh√¢n vi√™n</option>
            <option value="quanlynhansu">Qu·∫£n l√Ω nh√¢n s·ª±</option>
            <option value="ketoan">K·∫ø to√°n</option>
            <option value="quanlyhethong">Qu·∫£n l√Ω h·ªá th·ªëng</option>
            <option value="giamdoc">Gi√°m ƒë·ªëc</option>
          </select>

          <input
            id="edit-dept"
            placeholder="Ph√≤ng ban"
            class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
          />
          <input
            id="edit-project"
            placeholder="D·ª± √°n"
            class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
          />

          <div class="grid grid-cols-2 gap-4">
            <input
              id="edit-dob"
              type="date"
              class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
            />
            <select
              id="edit-gender"
              class="p-3 border border-gray-300 rounded-lg bg-white focus:border-emerald-500 focus:ring-emerald-500"
            >
              <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
            </select>
          </div>

          <input
            id="edit-join"
            type="date"
            placeholder="Ng√†y v√†o l√†m"
            class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
          />

          <div class="text-right pt-4 border-t mt-2">
            <button
              onclick="saveHREditedProfile()"
              class="py-2 px-6 bg-emerald-600 text-white font-semibold rounded-lg shadow-lg hover:bg-emerald-700 transition-colors"
            >
              C·∫≠p nh·∫≠t h·ªì s∆°
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="extra-main-buttons"
      class="hidden flex gap-3 p-4 bg-white border-b shadow-sm"
    >
      <button
        id="open-profile-btn"
        onclick="openProfileModal()"
        class="py-2 px-4 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors"
      >
        Xem th√¥ng tin c√° nh√¢n
      </button>

      <button
        id="open-employee-register-btn"
        onclick="openEmployeeRegisterModal()"
        class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors"
      >
        ƒêƒÉng k√Ω (Nh√¢n vi√™n)
      </button>
      <button
        id="btn-view-salary"
        onclick="openViewSalaryView()"
        class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors"
      >
        Xem Phi·∫øu L∆∞∆°ng
      </button>
      <button
        id="open-hr-mgmt-btn"
        onclick="openHRManagementView()"
        class="py-2 px-4 bg-rose-600 text-white font-semibold rounded-lg hidden hover:bg-rose-700 transition-colors"
      >
        Qu·∫£n l√Ω nh√¢n s·ª±
      </button>
    </div>
    <!-- 5. GIAO DI·ªÜN QU·∫¢N L√ù TH√îNG B√ÅO -->
    <div
      id="notification-management-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Qu·∫£n L√Ω Th√¥ng B√°o</h2>
          <button
            onclick="closeNotificationManagementView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <div class="mb-8 p-4 bg-green-50 rounded-lg shadow-inner">
          <h3 class="text-xl font-semibold text-green-700 mb-3">
            1. T·∫°o Th√¥ng B√°o M·ªõi
          </h3>
          <form onsubmit="createNotification(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label
                  for="notif-matb"
                  class="block text-sm font-medium text-gray-700"
                  >M√£ Th√¥ng B√°o (MATB)</label
                >
                <input
                  type="text"
                  id="notif-matb"
                  required
                  placeholder="V√≠ d·ª•: TB001"
                  class="w-full p-2 border rounded-lg mt-1"
                />
              </div>
              <div>
                <label
                  for="notif-tieu-de"
                  class="block text-sm font-medium text-gray-700"
                  >Ti√™u ƒê·ªÅ</label
                >
                <input
                  type="text"
                  id="notif-tieu-de"
                  required
                  placeholder="Ti√™u ƒë·ªÅ th√¥ng b√°o"
                  class="w-full p-2 border rounded-lg mt-1"
                />
              </div>
            </div>

            <div class="mb-4">
              <label
                for="notif-noi-dung"
                class="block text-sm font-medium text-gray-700"
                >N·ªôi Dung</label
              >
              <textarea
                id="notif-noi-dung"
                required
                rows="3"
                placeholder="N·ªôi dung chi ti·∫øt c·ªßa th√¥ng b√°o..."
                class="w-full p-2 border rounded-lg mt-1"
              ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label
                  for="notif-ngay-gui"
                  class="block text-sm font-medium text-gray-700"
                  >Ng√†y G·ª≠i</label
                >
                <input
                  type="date"
                  id="notif-ngay-gui"
                  required
                  class="w-full p-2 border rounded-lg mt-1 bg-white"
                />
              </div>
              <div>
                <label
                  for="notif-doi-tuong"
                  class="block text-sm font-medium text-gray-700"
                  >ƒê·ªëi T∆∞·ª£ng Nh·∫≠n</label
                >
                <select
                  id="notif-doi-tuong"
                  required
                  class="w-full p-2 border rounded-lg mt-1 bg-white"
                >
                  <option value="" disabled selected>Ch·ªçn ƒë·ªëi t∆∞·ª£ng</option>
                  <option value="toancongty">To√†n b·ªô c√¥ng ty</option>
                  <option value="quanlynhansu">Qu·∫£n l√Ω nh√¢n s·ª±</option>
                  <option value="ketoan">K·∫ø to√°n</option>
                </select>
              </div>
              <div>
                <label
                  for="notif-loai"
                  class="block text-sm font-medium text-gray-700"
                  >Lo·∫°i Th√¥ng B√°o</label
                >
                <select
                  id="notif-loai"
                  required
                  class="w-full p-2 border rounded-lg mt-1 bg-white"
                >
                  <option value="thuongky">Th∆∞·ªùng k·ª≥</option>
                  <option value="khancap">Kh·∫©n c·∫•p</option>
                </select>
              </div>
            </div>

            <button
              type="submit"
              class="w-full mt-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150"
            >
              T·∫°o Th√¥ng B√°o
            </button>
          </form>
        </div>

        <div class="mb-6">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">
            2. L·ªãch S·ª≠ Th√¥ng B√°o ƒê√£ T·∫°o
          </h3>
          <div
            id="notif-history-container"
            class="scrollable-list p-2 bg-white"
          >
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12"
                  >
                    M√£
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-4/12"
                  >
                    Ti√™u ƒê·ªÅ
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12"
                  >
                    Ng√†y G·ª≠i
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12"
                  >
                    ƒê·ªëi T∆∞·ª£ng
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12"
                  >
                    Lo·∫°i
                  </th>
                </tr>
              </thead>
              <tbody
                id="notif-history-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              >
                <tr>
                  <td colspan="5" class="text-center py-4 text-gray-500">
                    ƒêang t·∫£i l·ªãch s·ª≠ th√¥ng b√°o...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closeNotificationManagementView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay l·∫°i Giao di·ªán Qu·∫£n l√Ω H·ªá th·ªëng
          </button>
        </div>
      </div>
    </div>

    <!-- 6. GIAO DI·ªÜN XEM TH√îNG B√ÅO (All Users) -->
    <div
      id="view-notifications-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Th√¥ng B√°o C√¥ng Ty</h2>
          <button
            onclick="closeViewNotificationsView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <p
          id="notif-role-filter-info"
          class="text-sm text-indigo-600 mb-4 font-semibold"
        ></p>

        <div id="user-notifications-list" class="space-y-4">
          <p class="text-center py-8 text-gray-500">ƒêang t·∫£i th√¥ng b√°o...</p>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closeViewNotificationsView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
    <!-- 7. GIAO DI·ªÜN ƒêI·ªÄU ƒê·ªòNG NH√ÇN S·ª∞ (Director Only) -->
    <div
      id="personnel-deployment-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">
            ƒêi·ªÅu ƒê·ªông Nh√¢n S·ª± C√¥ng Ty
          </h2>
          <button
            onclick="closePersonnelDeploymentView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-600 mb-6">
          Ch·ª©c nƒÉng n√†y d√πng ƒë·ªÉ c·∫≠p nh·∫≠t ph√≤ng ban c√¥ng t√°c v√† g·ª≠i th√¥ng b√°o
          ƒëi·ªÅu ƒë·ªông cho nh√¢n s·ª±.
        </p>

        <h3 class="text-xl font-semibold text-gray-700 mb-3">
          Danh S√°ch Nh√¢n S·ª±
        </h3>
        <div id="personnel-list-container" class="scrollable-list p-2 bg-white">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3"
                >
                  Email
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6"
                >
                  Vai tr√≤
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3"
                >
                  Ph√≤ng ban hi·ªán t·∫°i
                </th>
                <th
                  class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6"
                >
                  Thao t√°c
                </th>
              </tr>
            </thead>
            <tbody
              id="personnel-list-body"
              class="bg-white divide-y divide-gray-200 text-sm"
            >
              <tr>
                <td colspan="4" class="text-center py-4 text-gray-500">
                  ƒêang t·∫£i danh s√°ch nh√¢n s·ª±...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closePersonnelDeploymentView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay l·∫°i Giao di·ªán Qu·∫£n l√Ω H·ªá th·ªëng
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Vai tr√≤ -->
    <div
      id="role-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
        <h3 class="text-lg font-bold mb-4" id="modal-title"></h3>
        <p id="modal-user-info" class="mb-4 text-sm text-gray-600"></p>

        <div id="modal-role-select-container">
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Ch·ªçn Vai tr√≤ m·ªõi</label
          >
          <select
            id="modal-role-select"
            class="w-full p-2 border rounded-lg mb-4 bg-white"
          ></select>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="closeModal()"
            class="py-2 px-4 border rounded-lg text-gray-700 hover:bg-gray-100 transition"
          >
            H·ªßy
          </button>
          <button
            id="modal-confirm-btn"
            class="py-2 px-4 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition"
          >
            X√°c Nh·∫≠n
          </button>
        </div>
      </div>
    </div>

    <!-- Modal ƒêi·ªÅu ƒë·ªông -->
    <div
      id="deployment-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
        <h3 class="text-lg font-bold mb-4 text-indigo-700">
          ƒêi·ªÅu ƒê·ªông Nh√¢n S·ª±
        </h3>
        <p
          id="deployment-user-info"
          class="mb-4 text-sm text-gray-700 font-medium"
        ></p>

        <div id="modal-dept-select-container">
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Ch·ªçn Ph√≤ng Ban m·ªõi</label
          >
          <select
            id="modal-dept-select"
            class="w-full p-2 border rounded-lg mb-4 bg-white"
          ></select>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="closeDeploymentModal()"
            class="py-2 px-4 border rounded-lg text-gray-700 hover:bg-gray-100 transition"
          >
            H·ªßy
          </button>
          <button
            id="deployment-confirm-btn"
            class="py-2 px-4 rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 transition"
          >
            C·∫≠p Nh·∫≠t & Th√¥ng B√°o
          </button>
        </div>
      </div>
    </div>
    <!-- baodzaik. GIAO DI·ªÜN K·∫æ TO√ÅN (M·ªõi th√™m) -->
    <!-- N√öT XEM PHI·∫æU L∆Ø∆†NG C√Å NH√ÇN (D√°n v√†o b√™n trong div id="main-buttons-container") -->
    <div
      id="user-salary-view"
      class="fixed inset-0 z-50 overflow-y-auto hidden"
      style="background-color: rgba(0, 0, 0, 0.6)"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <!-- Card n·ªôi dung -->
        <div
          class="bg-white rounded-xl shadow-2xl w-full max-w-5xl transform transition-all duration-300"
        >
          <!-- Header Modal -->
          <div
            class="p-6 border-b border-gray-200 flex justify-between items-center"
          >
            <h3 class="text-2xl font-bold text-gray-800">
              L·ªãch S·ª≠ Phi·∫øu L∆∞∆°ng C√° Nh√¢n
            </h3>
            <button
              onclick="closeViewSalaryView()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Body Modal (Th√¥ng tin & B·∫£ng) -->
          <div class="p-6">
            <div class="mb-4 text-sm text-gray-600">
              <span class="font-semibold text-gray-800">Ng∆∞·ªùi d√πng:</span>
              <span id="user-salary-email" class="text-indigo-600 font-medium"
                >ƒêang t·∫£i...</span
              >
            </div>

            <!-- B·∫£ng hi·ªÉn th·ªã phi·∫øu l∆∞∆°ng -->
            <div
              class="overflow-x-auto rounded-lg shadow-md border border-gray-100"
            >
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      M√£ Phi·∫øu
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Ng√†y Xu·∫•t
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Gi·ªù C√¥ng
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      L∆∞∆°ng C·ª©ng
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Ph·ª• C·∫•p
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Th∆∞·ªüng
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-bold text-green-700 uppercase tracking-wider"
                    >
                      T·ªïng Thu Nh·∫≠p
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="user-salary-body"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- D·ªØ li·ªáu phi·∫øu l∆∞∆°ng s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                  <tr>
                    <td colspan="7" class="text-center py-6 text-gray-400">
                      ƒêang t·∫£i d·ªØ li·ªáu...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Footer Modal -->
          <div class="p-4 border-t border-gray-200 flex justify-end">
            <button
              onclick="closeViewSalaryView()"
              class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg shadow hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- baodzaik. GIAO DI·ªÜN K·∫æ TO√ÅN (M·ªõi th√™m) -->
    <div
      id="accounting-view"
      class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-5xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-8 mb-8"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Giao di·ªán K·∫ø To√°n</h2>
          <button
            onclick="closeAccountingView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light"
          >
            &times;
          </button>
        </div>

        <div class="mb-6">
          <div class="flex gap-2">
            <button
              id="tab-attendance"
              class="py-2 px-4 bg-indigo-600 text-white rounded"
              onclick="showAccountingTab('attendance')"
            >
              Ch·∫•m c√¥ng
            </button>
            <button
              id="tab-payroll"
              class="py-2 px-4 bg-gray-200 rounded"
              onclick="showAccountingTab('payroll')"
            >
              T√≠nh l∆∞∆°ng
            </button>
            <button
              id="tab-report"
              class="py-2 px-4 bg-gray-200 rounded"
              onclick="showAccountingTab('report')"
            >
              B√°o c√°o k·∫ø to√°n
            </button>
          </div>
        </div>

        <div id="acct-attendance" class="">
          <h3 class="text-lg font-semibold mb-3">
            Danh s√°ch t√†i kho·∫£n (Ch·∫•m c√¥ng)
          </h3>
          <div id="acct-attendance-list" class="scrollable-list p-2 bg-white">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Email
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Vai tr√≤
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Ph√≤ng ban
                  </th>
                  <th class="px-3 py-2 text-center text-xs text-gray-500">
                    T·ªïng gi·ªù
                  </th>
                  <th class="px-3 py-2 text-center text-xs text-gray-500">
                    Thao t√°c
                  </th>
                </tr>
              </thead>
              <tbody
                id="acct-attendance-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              >
                <tr>
                  <td colspan="5" class="text-center py-4 text-gray-500">
                    ƒêang t·∫£i...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="acct-payroll" class="hidden mt-6">
          <h3 class="text-lg font-semibold mb-3">T√≠nh l∆∞∆°ng</h3>
          <div class="mb-4">
            <p class="text-sm text-gray-600">
              Ch·ªçn nh√¢n vi√™n b√™n d∆∞·ªõi ƒë·ªÉ t√≠nh l∆∞∆°ng. 1 gi·ªù = <b>24,000</b> VNƒê.
            </p>
          </div>
          <div id="acct-payroll-list" class="scrollable-list p-2 bg-white">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Email
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    T·ªïng gi·ªù
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    L∆∞∆°ng c·ª©ng
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Thao t√°c
                  </th>
                </tr>
              </thead>
              <tbody
                id="acct-payroll-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              >
                <tr>
                  <td colspan="4" class="text-center py-4 text-gray-500">
                    ƒêang t·∫£i...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="acct-report" class="hidden mt-6">
          <h3 class="text-lg font-semibold mb-3">B√°o c√°o k·∫ø to√°n</h3>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <input type="date" id="report-start" class="p-2 border rounded" />
            <input type="date" id="report-end" class="p-2 border rounded" />
            <button
              id="generate-report-btn"
              class="py-2 px-4 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              onclick="generateAccountingReport()"
            >
              T·∫°o b√°o c√°o
            </button>
          </div>

          <div id="acct-report-result" class="p-4 bg-white rounded shadow-sm">
            <p class="text-sm text-gray-500">
              K·∫øt qu·∫£ b√°o c√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.
            </p>
          </div>

          <div class="flex justify-end mt-4">
            <button
              id="send-report-btn"
              class="py-2 px-4 bg-emerald-600 text-white rounded hidden hover:bg-emerald-700"
              onclick="sendReportToDirector()"
            >
              G·ª≠i b√°o c√°o cho Gi√°m ƒë·ªëc
            </button>
          </div>
        </div>
      </div>
    </div>

    <button
      id="open-salary-btn"
      onclick="openSalaryModal()"
      class="hidden py-2 px-4 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition-colors"
    >
      <i class="fas fa-money-bill-wave mr-1"></i> Xem L∆∞∆°ng
    </button>

    <div
      id="salary-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 relative"
      >
        <h3 class="text-xl font-bold text-teal-700 border-b pb-2 mb-4">
          Phi·∫øu L∆∞∆°ng Chi Ti·∫øt
        </h3>

        <div
          id="salary-content"
          class="max-h-96 overflow-y-auto space-y-3 text-sm"
        >
          <p class="text-center text-gray-500" id="salary-message">
            ƒêang t·∫£i...
          </p>
        </div>

        <div class="mt-6 text-right">
          <button
            onclick="closeSalaryModal()"
            class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <div
      id="baoCaoModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 999;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          width: 400px;
          max-height: 80%;
          overflow-y: auto;
        "
      >
        <h3 style="text-align: center; margin-bottom: 15px">
          üìã B√°o c√°o l∆∞∆°ng
        </h3>

        <div id="dsLuong"></div>

        <textarea
          id="noiDungBaoCao"
          placeholder="Nh·∫≠p n·ªôi dung b√°o c√°o th√™m..."
          style="
            width: 100%;
            height: 80px;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
          "
        ></textarea>

        <div style="text-align: center; margin-top: 15px">
          <button
            id="guiBaoCao"
            style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 8px;
            "
          >
            G·ª≠i
          </button>
          <button
            id="dongModal"
            style="
              margin-left: 10px;
              background: #ccc;
              border: none;
              padding: 8px 16px;
              border-radius: 8px;
            "
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
    <button id="moBaoCao" style="margin-top: 20px"></button>
    <!-- -----------------------------------------------------------------------
         JAVASCRIPT (MODULE) - T·∫§T C·∫¢ LOGIC ƒê√É ƒê∆Ø·ª¢C N√ÇNG C·∫§P, NH∆ØNG GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
         ----------------------------------------------------------------------- -->
    <script type="module">
      import { runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";

      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        addDoc,
        getDocs,
        onSnapshot,
        query,
        where,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
      import {
        getDatabase,
        ref as dbRef, // <-- ƒê√£ ƒë·∫∑t t√™n l·∫°i th√†nh dbRef
        set as dbSet,
        get as dbGet, // <-- ƒê√£ ƒë·∫∑t t√™n l·∫°i th√†nh dbGet
        update as dbUpdate,
        push as dbPush,
        child as dbChild,
        remove as dbRemove,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

      // ---------------------------
      // 1Ô∏è‚É£ C·∫§U H√åNH FIREBASE
      // ---------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyA4d8ntVGva4RgVq8dN1IP56qB4_2Lm2lE",
        authDomain: "user-f441d.firebaseapp.com",
        projectId: "user-f441d",
        databaseURL: "https://user-f441d-default-rtdb.firebaseio.com",
        storageBucket: "user-f441d.firebasestorage.app",
        messagingSenderId: "348854983093",
        appId: "1:348854983093:web:c63954303bd441bb24a1fc",
        measurementId: "G-NNL96JYL4N",
      };

      // ---------------------------
      // 2Ô∏è‚É£ KH·ªûI T·∫†O FIREBASE
      // ---------------------------
      let app, db, rtdb, auth;

      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app); // Firestore
        rtdb = getDatabase(app); // Realtime DB
        auth = getAuth(app);

        console.log(
          "%cüî• Firebase (Firestore + RTDB) kh·ªüi t·∫°o th√†nh c√¥ng!",
          "color: #4caf50; font-weight: bold;"
        );

        // Theo d√µi ƒëƒÉng nh·∫≠p
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("%cüë§ ƒê√£ ƒëƒÉng nh·∫≠p: " + user.email, "color: #2196f3;");
            // Khi c√≥ user, c√≥ th·ªÉ g·ªçi loadUserSalarySlips() t·∫°i ƒë√¢y n·∫øu c·∫ßn
            // Vd: if (document.getElementById('user-salary-view')?.style.display !== 'none') { window.loadUserSalarySlips(); }
          } else {
            console.log(
              "%cüö™ Ch∆∞a c√≥ ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p.",
              "color: #f57c00;"
            );
          }
        });
      } catch (e) {
        console.error("‚ùå L·ªói kh·ªüi t·∫°o Firebase:", e);
        // Thay th·∫ø alert() b·∫±ng UI displayMessage
        if (typeof UI?.displayMessage === "function") {
          UI.displayMessage("L·ªói kh·ªüi t·∫°o Firebase: " + e.message, "error");
        } else {
          console.error(
            "L·ªói: Kh√¥ng th·ªÉ hi·ªÉn th·ªã tin nh·∫Øn do UI.displayMessage kh√¥ng t·ªìn t·∫°i."
          );
        }
      }

      // ---------------------------
      // 3Ô∏è‚É£ FIRESTORE FUNCTIONS
      // ---------------------------
      async function saveUserData(uid, data) {
        try {
          await setDoc(doc(db, "users", uid), data);
          console.log(
            "%c‚úÖ D·ªØ li·ªáu ng∆∞·ªùi d√πng ƒë√£ l∆∞u v√†o Firestore!",
            "color: #00c853;"
          );
        } catch (err) {
          console.error("‚ùå L·ªói l∆∞u d·ªØ li·ªáu:", err);
        }
      }

      async function loadUserData(uid) {
        try {
          const snap = await getDoc(doc(db, "users", uid));
          if (snap.exists()) {
            console.log(
              "%cüìÑ D·ªØ li·ªáu ng∆∞·ªùi d√πng:",
              "color: #4caf50;",
              snap.data()
            );
            return snap.data();
          } else {
            console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng:", uid);
          }
        } catch (err) {
          console.error("‚ùå L·ªói ƒë·ªçc d·ªØ li·ªáu:", err);
        }
      }

      // ---------------------------
      // 4Ô∏è‚É£ REALTIME DATABASE FUNCTIONS (H√†m v√≠ d·ª•)
      // ---------------------------
      async function markAttendance(userId, date, status) {
        try {
          // S·ª¨ D·ª§NG dbRef V√Ä dbSet ƒê√É ƒê∆Ø·ª¢C IMPORT
          const reference = dbRef(rtdb, `attendance/${userId}/${date}`);
          await dbSet(reference, {
            status,
            time: new Date().toISOString(),
          });
          console.log("%cüïì Ch·∫•m c√¥ng th√†nh c√¥ng!", "color: #03a9f4;");
        } catch (err) {
          console.error("‚ùå L·ªói ch·∫•m c√¥ng:", err);
        }
      }

      async function getAttendance(userId) {
        try {
          // S·ª¨ D·ª§NG dbRef V√Ä dbGet ƒê√É ƒê∆Ø·ª¢C IMPORT
          const reference = dbRef(rtdb, `attendance/${userId}`);
          const snap = await dbGet(reference);
          if (snap.exists()) {
            console.log(
              "%cüìä D·ªØ li·ªáu ch·∫•m c√¥ng:",
              "color: #8bc34a;",
              snap.val()
            );
            return snap.val();
          } else {
            console.warn("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng.");
          }
        } catch (err) {
          console.error("‚ùå L·ªói ƒë·ªçc ch·∫•m c√¥ng:", err);
        }
      }

      // Xu·∫•t c√°c h√†m ra ƒë·ªÉ d√πng trong HTML
      window.saveUserData = saveUserData;
      window.loadUserData = loadUserData;
      window.markAttendance = markAttendance;
      window.getAttendance = getAttendance;

      // ---------------------------
      // 2) H√ÄM TI·ªÜN √çCH CHUNG (UI & HELPERS)
      // ---------------------------
      const UI = (() => {
        // cache selectors we use often
        const $ = (id) => document.getElementById(id);

        function displayMessage(message, type = "info", timeout = 4500) {
          const box = $("message-box");
          if (!box) return;
          box.textContent = message;
          box.classList.remove(
            "hidden",
            "bg-red-100",
            "text-red-700",
            "bg-green-100",
            "text-green-700",
            "bg-blue-100",
            "text-blue-700"
          );
          if (type === "error") box.classList.add("bg-red-100", "text-red-700");
          else if (type === "success")
            box.classList.add("bg-green-100", "text-green-700");
          else box.classList.add("bg-blue-100", "text-blue-700");

          // clear timeout if exists
          if (box._hideTimer) clearTimeout(box._hideTimer);
          box._hideTimer = setTimeout(() => {
            box.classList.add("hidden");
          }, timeout);
        }

        function formatDate(isoString) {
          if (!isoString) return "N/A";
          if (/^\d{4}-\d{2}-\d{2}$/.test(isoString)) {
            return new Date(isoString + "T00:00:00").toLocaleDateString(
              "vi-VN",
              { day: "2-digit", month: "2-digit", year: "numeric" }
            );
          }
          const d = new Date(isoString);
          return d.toLocaleDateString("vi-VN", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });
        }

        // render helpers for tables/lists using DocumentFragment
        function renderTableRows(containerId, rowsHtmlArray) {
          const el = $(containerId);
          if (!el) return;
          el.innerHTML = ""; // clear existing
          const frag = document.createDocumentFragment();
          // create wrapper tbody to append rows safely
          rowsHtmlArray.forEach((html) => {
            const tr = document.createElement("tr");
            tr.innerHTML = html;
            frag.appendChild(tr);
          });
          el.appendChild(frag);
        }

        return { displayMessage, formatDate, renderTableRows, $ };
      })();

      // ---------------------------
      // 3) C·∫§U H√åNH ROLE & DEPT (KEEP)
      // ---------------------------
      const roleNames = {
        nhanvien: "Nh√¢n vi√™n",
        quanlynhansu: "Qu·∫£n l√Ω nh√¢n s·ª±",
        ketoan: "K·∫ø to√°n",
        quanlyhethong: "Qu·∫£n l√Ω h·ªá th·ªëng",
        giamdoc: "Gi√°m ƒë·ªëc",
      };

      const departmentNames = {
        kythuat: "K·ª∏ THU·∫¨T",
        marketing: "MARKETING",
        ketoantaichinh: "Ph√≤ng K·∫ø to√°n - T√†i ch√≠nh",
        hanhchinhnhansu: "Ph√≤ng H√†nh ch√≠nh - Nh√¢n s·ª±",
        "N/A": "Ch∆∞a ph√¢n c√¥ng",
      };

      const recipientNames = {
        toancongty: "To√†n b·ªô c√¥ng ty",
        quanlynhansu: "Qu·∫£n l√Ω nh√¢n s·ª±",
        ketoan: "K·∫ø to√°n",
      };

      // prepare select option html strings
      const roleOptionsHtml = Object.entries(roleNames)
        .map(([key, name]) => `<option value="${key}">${name}</option>`)
        .join("");
      const departmentOptionsHtml = Object.entries(departmentNames)
        .filter(([k]) => k !== "N/A")
        .map(([k, n]) => `<option value="${k}">${n}</option>`)
        .join("");

      // ---------------------------
      // 4) GLOBAL STATE (scoped to module)
      // ---------------------------
      let currentUserRole = "nhanvien";
      let unsubscribeRoleListener = null;
      let unsubscribeUserListListener = null;
      let unsubscribeNotifHistoryListener = null;
      let unsubscribeUserNotifsListener = null;
      let unsubscribePersonnelListListener = null;

      // store director session when creating other accounts (existing behavior)
      let directorEmailSession = null;
      let directorPasswordSession = null;

      // ---------------------------
      // 5) DOMContent Loaded init
      // ---------------------------
      document.addEventListener("DOMContentLoaded", () => {
        // set today as default
        const today = new Date().toISOString().split("T")[0];
        const notifDateInput = document.getElementById("notif-ngay-gui");
        if (notifDateInput) notifDateInput.value = today;

        const modalRoleSelect = document.getElementById("modal-role-select");
        if (modalRoleSelect) modalRoleSelect.innerHTML = roleOptionsHtml;

        const deptSelect = document.getElementById("modal-dept-select");
        if (deptSelect) deptSelect.innerHTML = departmentOptionsHtml;

        // accounting tab defaults
        showAccountingTab("attendance");
      });

      // ---------------------------
      // 6) UI OPEN/CLOSE functions (kept original but safer)
      // ---------------------------
      function safeShow(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = "flex";
      }
      function safeHide(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = "none";
      }

      window.openSystemManagementView = function () {
        if (currentUserRole === "giamdoc") {
          safeShow("system-management-view");
          safeHide("user-management-view");
          safeHide("notification-management-view");
          safeHide("personnel-deployment-view");
        } else {
          UI.displayMessage(
            "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng n√†y.",
            "error"
          );
        }
      };
      window.closeSystemManagementView = function () {
        safeHide("system-management-view");
        safeHide("personnel-deployment-view");
      };

      window.openUserManagementView = function () {
        if (currentUserRole === "giamdoc") {
          safeShow("user-management-view");
          listenForUserList();
        } else
          UI.displayMessage(
            "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng n√†y.",
            "error"
          );
      };
      window.closeUserManagementView = function () {
        safeHide("user-management-view");
        if (unsubscribeUserListListener) {
          unsubscribeUserListListener();
          unsubscribeUserListListener = null;
        }
      };

      window.openNotificationManagementView = function () {
        safeShow("notification-management-view");
        if (currentUserRole === "giamdoc") listenForNotificationHistory();
      };
      window.closeNotificationManagementView = function () {
        safeHide("notification-management-view");
        if (unsubscribeNotifHistoryListener) {
          unsubscribeNotifHistoryListener();
          unsubscribeNotifHistoryListener = null;
        }
      };

      window.openViewNotificationsView = function () {
        safeShow("view-notifications-view");
        document.getElementById(
          "notif-role-filter-info"
        ).textContent = `Th√¥ng b√°o d√†nh cho vai tr√≤: ${
          roleNames[currentUserRole] || "ƒêang t·∫£i..."
        }`;
        listenForUserNotifications();
      };
      window.closeViewNotificationsView = function () {
        safeHide("view-notifications-view");
        if (unsubscribeUserNotifsListener) {
          unsubscribeUserNotifsListener();
          unsubscribeUserNotifsListener = null;
        }
      };

      window.openPersonnelDeploymentView = function () {
        if (currentUserRole === "giamdoc") {
          safeShow("personnel-deployment-view");
          listenForPersonnelList();
        } else
          UI.displayMessage(
            "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng n√†y.",
            "error"
          );
      };
      window.closePersonnelDeploymentView = function () {
        safeHide("personnel-deployment-view");
        if (unsubscribePersonnelListListener) {
          unsubscribePersonnelListListener();
          unsubscribePersonnelListListener = null;
        }
      };

      window.closeModal = function () {
        safeHide("role-modal");
        const container = document.getElementById(
          "modal-role-select-container"
        );
        if (container) container.classList.remove("hidden");
        const btn = document.getElementById("modal-confirm-btn");
        if (btn) btn.textContent = "X√°c Nh·∫≠n";
      };
      window.closeDeploymentModal = function () {
        safeHide("deployment-modal");
      };

      // ---------------------------
      // 7) AUTH (login/logout & onAuthState)
      // ---------------------------
      window.handleAuth = async function (event) {
        event.preventDefault();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          UI.displayMessage("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Email v√† M·∫≠t kh·∫©u.", "error");
          return;
        }
        try {
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;
          const userData = await getUserProfile(user.uid);
          if (userData && userData.disabled) {
            await signOut(auth);
            UI.displayMessage(
              "T√†i kho·∫£n n√†y ƒë√£ b·ªã v√¥ hi·ªáu h√≥a. Vui l√≤ng li√™n h·ªá Gi√°m ƒë·ªëc ƒë·ªÉ Kh√¥i ph·ª•c.",
              "error"
            );
            return;
          }
          directorEmailSession = email;
          directorPasswordSession = password;
          UI.displayMessage(
            "ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang t·∫£i d·ªØ li·ªáu...",
            "success"
          );
        } catch (error) {
          console.error("Login error:", error);
          let msg = "ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.";
          if (error.code === "auth/invalid-email")
            msg = "ƒê·ªãa ch·ªâ email kh√¥ng h·ª£p l·ªá.";
          else if (
            ["auth/user-not-found", "auth/wrong-password"].includes(error.code)
          )
            msg = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.";
          UI.displayMessage(`L·ªói: ${msg}`, "error");
        }
      };

      window.logoutUser = async function () {
        try {
          [
            unsubscribeRoleListener,
            unsubscribeUserListListener,
            unsubscribeNotifHistoryListener,
            unsubscribeUserNotifsListener,
            unsubscribePersonnelListListener,
          ].forEach((fn, idx) => {
            if (fn) {
              try {
                fn();
              } catch (e) {
                console.warn("unsubscribe error", e);
              }
            }
          });
          unsubscribeRoleListener =
            unsubscribeUserListListener =
            unsubscribeNotifHistoryListener =
            unsubscribeUserNotifsListener =
            unsubscribePersonnelListListener =
              null;

          await signOut(auth);
          directorEmailSession = directorPasswordSession = null;

          safeHide("system-management-view");
          safeHide("user-management-view");
          safeHide("notification-management-view");
          safeHide("view-notifications-view");
          safeHide("personnel-deployment-view");
          safeHide("accounting-view");

          UI.displayMessage("ƒêƒÉng xu·∫•t th√†nh c√¥ng.", "info");
        } catch (error) {
          console.error("Logout error:", error);
          UI.displayMessage(
            "L·ªói khi ƒëƒÉng xu·∫•t. Vui l√≤ng ki·ªÉm tra console.",
            "error"
          );
        }
      };

      // ---------------------------
      // 8) Firestore helpers (profile save/get)
      // ---------------------------
      async function getUserProfile(uid) {
        try {
          const userDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
          );
          const snap = await getDoc(userDocRef);
          return snap.exists() ? snap.data() : null;
        } catch (e) {
          console.error("getUserProfile error:", e);
          return null;
        }
      }

      async function saveUserProfile(
        uid,
        email,
        role = null,
        disabled = null,
        phongBan = null
      ) {
        try {
          const privateDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
          );
          const publicDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
          );

          // merge strategy: read current profile once to avoid overwriting unintentionally
          const current = (await getUserProfile(uid)) || {};

          const profileData = {
            uid,
            email,
            updatedAt: new Date().toISOString(),
            role: role ?? current.role ?? "nhanvien",
            phongBan: phongBan ?? current.phongBan ?? "N/A",
          };
          // only set disabled field if explicitly provided (to avoid toggling accidentally)
          if (disabled !== null) profileData.disabled = disabled;

          await setDoc(privateDocRef, profileData, { merge: true });
          await setDoc(publicDocRef, profileData, { merge: true });
        } catch (e) {
          console.error("saveUserProfile error:", e);
          throw e;
        }
      }

      // ---------------------------
      // 9) USER MANAGEMENT (list, render, create, toggle status, role update)
      // ---------------------------
      function listenForUserList() {
        if (unsubscribeUserListListener) {
          unsubscribeUserListListener();
          unsubscribeUserListListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const q = query(colRef);
          unsubscribeUserListListener = onSnapshot(
            q,
            (snap) => {
              const users = [];
              snap.forEach((d) => users.push(d.data()));
              renderUserList(users);
            },
            (err) => {
              console.error("listenForUserList error:", err);
              const body = document.getElementById("user-list-body");
              if (body)
                body.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">L·ªói t·∫£i danh s√°ch: ${err.message}</td></tr>`;
            }
          );
        } catch (e) {
          console.error("listenForUserList setup error:", e);
        }
      }

      function renderUserList(users) {
        const tbody = document.getElementById("user-list-body");
        if (!tbody) return;
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t·∫°o.</td></tr>`;
          return;
        }
        const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
        const rows = users.map((user) => {
          const roleDisplay = roleNames[user.role] || user.role;
          const statusDisplay = user.disabled ? "B·ªã kh√≥a" : "Ho·∫°t ƒë·ªông";
          const statusClass = user.disabled
            ? "bg-red-100 text-red-800"
            : "bg-green-100 text-green-800";
          const isCurrentUser = user.uid === currentUserId;

          // action buttons html (keep same functions)
          const actionButtons = `
            <button onclick="openRoleModal('${user.uid}', '${user.email}', '${
            user.role
          }')" class="py-1 px-2 bg-indigo-500 text-white text-xs font-medium rounded-lg hover:bg-indigo-600 transition ${
            isCurrentUser ? "opacity-50 cursor-not-allowed" : ""
          }" ${isCurrentUser ? "disabled" : ""}>Ph√¢n quy·ªÅn</button>
            <button onclick="openPasswordModal('${user.uid}', '${
            user.email
          }')" class="py-1 px-2 bg-yellow-500 text-white text-xs font-medium rounded-lg hover:bg-yellow-600 transition">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
            <button onclick="toggleUserStatus('${user.uid}', '${
            user.email
          }', ${!user.disabled})" class="py-1 px-2 text-white text-xs font-medium rounded-lg transition ${
            user.disabled
              ? "bg-green-500 hover:bg-green-600"
              : "bg-red-500 hover:bg-red-600"
          }" ${isCurrentUser ? "disabled" : ""}>${
            user.disabled ? "Kh√¥i ph·ª•c" : "V√¥ hi·ªáu h√≥a"
          }</button>
          `;

          return `
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email} ${
            isCurrentUser ? "(B·∫°n)" : ""
          }</td>
            <td class="px-3 py-2 text-gray-800">${roleDisplay}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusDisplay}</span></td>
            <td class="px-3 py-2 whitespace-nowrap text-right space-x-1">${actionButtons}</td>
          `;
        });

        // use the render helper to append rows
        UI.renderTableRows("user-list-body", rows);
      }

      window.createNewUserByDirector = async function (event) {
        event.preventDefault();
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o t√†i kho·∫£n.", "error");
          return;
        }
        const email = document.getElementById("new-email").value.trim();
        const password = document.getElementById("new-password").value;
        const role = document.getElementById("new-role").value;
        if (!email || !password || !role) {
          UI.displayMessage("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.", "error");
          return;
        }
        try {
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;
          await saveUserProfile(user.uid, email, role, false, "N/A");
          UI.displayMessage(
            `T√†i kho·∫£n ${email} (${roleNames[role]}) ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.`,
            "success"
          );

          // Re-authenticate director to restore session if needed (existing behavior)
          if (directorEmailSession && directorPasswordSession) {
            try {
              await signInWithEmailAndPassword(
                auth,
                directorEmailSession,
                directorPasswordSession
              );
            } catch (reAuthErr) {
              console.warn("Re-auth director failed:", reAuthErr);
            }
          }

          // reset form inputs
          document.getElementById("new-email").value = "";
          document.getElementById("new-password").value = "";
          document.getElementById("new-role").value = "";
        } catch (e) {
          console.error("createNewUser error:", e);
          UI.displayMessage(`L·ªói t·∫°o t√†i kho·∫£n: ${e.message}`, "error");
        }
      };

      window.toggleUserStatus = async function (uid, email, isDisabled) {
        if (uid === (auth.currentUser ? auth.currentUser.uid : null)) {
          UI.displayMessage(
            "B·∫°n kh√¥ng th·ªÉ v√¥ hi·ªáu h√≥a t√†i kho·∫£n Gi√°m ƒë·ªëc c·ªßa ch√≠nh m√¨nh.",
            "error"
          );
          return;
        }
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage(
            "B·∫°n kh√¥ng c√≥ quy·ªÅn thay ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng.",
            "error"
          );
          return;
        }
        try {
          await saveUserProfile(uid, email, null, isDisabled, null);
          UI.displayMessage(
            `ƒê√£ ${
              isDisabled ? "v√¥ hi·ªáu h√≥a" : "k√≠ch ho·∫°t"
            } t√†i kho·∫£n ${email}.`,
            "success"
          );
        } catch (e) {
          console.error("toggleUserStatus error:", e);
          UI.displayMessage(`L·ªói: ${e.message}`, "error");
        }
      };

      async function updateUserRole(uid, email, newRole) {
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn thay ƒë·ªïi vai tr√≤.", "error");
          return;
        }
        try {
          await saveUserProfile(uid, email, newRole, null, null);
          UI.displayMessage(
            `ƒê√£ c·∫≠p nh·∫≠t vai tr√≤ c·ªßa ${email} th√†nh ${roleNames[newRole]}.`,
            "success"
          );
        } catch (e) {
          console.error("updateUserRole error:", e);
          UI.displayMessage(`L·ªói: ${e.message}`, "error");
        }
      }

      // openPasswordModal, openRoleModal kept but refactored for safety
      window.openPasswordModal = function (uid, email) {
        // will reuse role modal area UI to ask for reset/ send email (original behavior kept)
        // Implementation: send reset email
        if (!confirm(`B·∫°n mu·ªën g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho ${email}?`))
          return;
        sendPasswordResetEmail(auth, email)
          .then(() => {
            UI.displayMessage(
              `Email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ g·ª≠i t·ªõi ${email}`,
              "success"
            );
          })
          .catch((e) => {
            console.error("sendResetEmail error:", e);
            UI.displayMessage(`L·ªói g·ª≠i email: ${e.message}`, "error");
          });
      };

      window.openRoleModal = function (uid, email, currentRole) {
        if (currentUserRole !== "giamdoc") return;
        const modal = document.getElementById("role-modal");
        const title = document.getElementById("modal-title");
        const userInfo = document.getElementById("modal-user-info");
        const roleSelect = document.getElementById("modal-role-select");
        const confirmBtn = document.getElementById("modal-confirm-btn");

        if (!modal || !title || !userInfo || !roleSelect || !confirmBtn) return;
        title.textContent = "Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng";
        userInfo.innerHTML = `Ch·ªânh quy·ªÅn cho: <b>${email}</b>`;
        roleSelect.value = currentRole || "nhanvien";

        confirmBtn.onclick = async () => {
          const newRole = roleSelect.value;
          if (!newRole) {
            UI.displayMessage("Vui l√≤ng ch·ªçn vai tr√≤.", "error");
            return;
          }
          await updateUserRole(uid, email, newRole);
          closeModal();
        };

        modal.style.display = "flex";
      };

      // ---------------------------
      // 10) Personnel (listen, render, open deployment modal, confirm)
      // ---------------------------
      function listenForPersonnelList() {
        if (unsubscribePersonnelListListener) {
          unsubscribePersonnelListListener();
          unsubscribePersonnelListListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const q = query(colRef);
          unsubscribePersonnelListListener = onSnapshot(
            q,
            (snap) => {
              const personnel = [];
              const currentUserId = auth.currentUser
                ? auth.currentUser.uid
                : null;
              snap.forEach((d) => {
                const data = d.data();
                if (data.uid !== currentUserId) personnel.push(data);
              });
              renderPersonnelList(personnel);
            },
            (err) => {
              console.error("listenForPersonnelList error:", err);
              const el = document.getElementById("personnel-list-body");
              if (el)
                el.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">L·ªói t·∫£i danh s√°ch nh√¢n s·ª±: ${err.message}</td></tr>`;
            }
          );
        } catch (e) {
          console.error("listenForPersonnelList setup error:", e);
        }
      }

      function renderPersonnelList(personnel) {
        const body = document.getElementById("personnel-list-body");
        if (!body) return;
        if (!Array.isArray(personnel) || personnel.length === 0) {
          body.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ nh√¢n s·ª± n√†o ƒë·ªÉ ƒëi·ªÅu ƒë·ªông.</td></tr>`;
          return;
        }
        const rows = personnel.map((user) => {
          const roleDisplay = roleNames[user.role] || user.role;
          const departmentKey = user.phongBan || "N/A";
          const departmentDisplay =
            departmentNames[departmentKey] || "Ch∆∞a ph√¢n c√¥ng";
          const actionButton = `<button onclick="openDeploymentModal('${
            user.uid
          }', '${
            user.email
          }', '${departmentKey}')" class="py-1 px-3 bg-yellow-600 text-white text-xs font-medium rounded-lg hover:bg-yellow-700 transition" ${
            user.disabled ? "disabled" : ""
          }>ƒêi·ªÅu ƒë·ªông</button>`;
          return `
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email}</td>
            <td class="px-3 py-2 text-gray-800">${roleDisplay}</td>
            <td class="px-3 py-2 text-gray-700 font-semibold">${departmentDisplay}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center">${actionButton}</td>
          `;
        });
        UI.renderTableRows("personnel-list-body", rows);
      }

      window.openDeploymentModal = function (uid, email, currentDeptKey) {
        if (currentUserRole !== "giamdoc") return;
        const info = document.getElementById("deployment-user-info");
        const deptSelect = document.getElementById("modal-dept-select");
        const confirmBtn = document.getElementById("deployment-confirm-btn");
        if (!info || !deptSelect || !confirmBtn) return;

        info.innerHTML = `ƒêang ƒëi·ªÅu ƒë·ªông nh√¢n s·ª±: <b>${email}</b> (Ph√≤ng hi·ªán t·∫°i: ${
          departmentNames[currentDeptKey] || "Ch∆∞a ph√¢n c√¥ng"
        })`;
        deptSelect.value = departmentNames[currentDeptKey]
          ? currentDeptKey
          : Object.keys(departmentNames).find((k) => k !== "N/A");

        // remove old onclick
        confirmBtn.onclick = null;
        confirmBtn.onclick = () => {
          const newDepartmentKey = deptSelect.value;
          confirmDeploymentAndNotify(uid, email, newDepartmentKey);
          closeDeploymentModal();
        };
        document.getElementById("deployment-modal").style.display = "flex";
      };

      async function confirmDeploymentAndNotify(uid, email, newDepartmentKey) {
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán ƒëi·ªÅu ƒë·ªông.", "error");
          return;
        }
        const newDepartmentName =
          departmentNames[newDepartmentKey] || "Ch∆∞a ph√¢n c√¥ng";
        try {
          // 1) c·∫≠p nh·∫≠t ph√≤ng ban
          await saveUserProfile(uid, email, null, false, newDepartmentKey);

          // 2) t·∫°o th√¥ng b√°o c√° nh√¢n
          const today = new Date().toISOString().split("T")[0];
          const notifTieuDe = "Quy·∫øt ƒë·ªãnh ƒêi·ªÅu ƒê·ªông Nh√¢n S·ª±";
          const notifNoiDung = `Ng∆∞·ªùi g·ª≠i: Gi√°m ƒë·ªëc\nNg√†y: ${UI.formatDate(
            today
          )}\nG·ª≠i l√†: ${email}\nN·ªôi dung: B·∫°n ƒë∆∞·ª£c ƒëi·ªÅu ƒë·ªông qua Ph√≤ng Ban [${newDepartmentName}].`;

          const notificationData = {
            matb: `DD${Date.now().toString().slice(-6)}`,
            tieuDe: notifTieuDe,
            noiDung: notifNoiDung,
            ngayGui: today,
            doiTuongNhan: uid, // g·ª≠i ƒë·∫øn UID
            loaiThongBao: "khancap",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          };

          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, notificationData);
          UI.displayMessage(
            `ƒê√£ ƒëi·ªÅu ƒë·ªông ${email} sang ${newDepartmentName} v√† g·ª≠i th√¥ng b√°o th√†nh c√¥ng.`,
            "success"
          );
        } catch (e) {
          console.error("confirmDeploymentAndNotify error:", e);
          UI.displayMessage(`L·ªói ƒëi·ªÅu ƒë·ªông: ${e.message}`, "error");
        }
      }

      // ---------------------------
      // 11) NOTIFICATIONS (create, listen, render)
      // ---------------------------
      window.createNotification = async function (event) {
        event.preventDefault();
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o th√¥ng b√°o.", "error");
          return;
        }
        const matb = document.getElementById("notif-matb").value.trim();
        const tieuDe = document.getElementById("notif-tieu-de").value.trim();
        const noiDung = document.getElementById("notif-noi-dung").value.trim();
        const ngayGui = document.getElementById("notif-ngay-gui").value;
        const doiTuong = document.getElementById("notif-doi-tuong").value;
        const loai = document.getElementById("notif-loai").value;

        if (!matb || !tieuDe || !noiDung || !ngayGui || !doiTuong || !loai) {
          UI.displayMessage(
            "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin th√¥ng b√°o.",
            "error"
          );
          return;
        }
        try {
          const notificationData = {
            matb,
            tieuDe,
            noiDung,
            ngayGui,
            doiTuongNhan: doiTuong,
            loaiThongBao: loai,
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          };
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, notificationData);
          UI.displayMessage(
            `Th√¥ng b√°o "${tieuDe}" ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!`,
            "success"
          );

          // reset form fields (except date)
          document.getElementById("notif-matb").value = "";
          document.getElementById("notif-tieu-de").value = "";
          document.getElementById("notif-noi-dung").value = "";
        } catch (e) {
          console.error("createNotification error:", e);
          UI.displayMessage(`L·ªói t·∫°o th√¥ng b√°o: ${e.message}`, "error");
        }
      };

      function listenForNotificationHistory() {
        if (unsubscribeNotifHistoryListener) {
          unsubscribeNotifHistoryListener();
          unsubscribeNotifHistoryListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          const q = query(colRef);
          unsubscribeNotifHistoryListener = onSnapshot(
            q,
            (snap) => {
              const notifications = [];
              snap.forEach((d) =>
                notifications.push({ id: d.id, ...d.data() })
              );
              notifications.sort(
                (a, b) => new Date(b.ngayGui) - new Date(a.ngayGui)
              );
              renderNotificationHistory(notifications);
            },
            (err) => {
              console.error("listenForNotificationHistory error:", err);
              const body = document.getElementById("notif-history-body");
              if (body)
                body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">L·ªói t·∫£i l·ªãch s·ª≠: ${err.message}</td></tr>`;
            }
          );
        } catch (e) {
          console.error("listenForNotificationHistory setup error:", e);
        }
      }

      // ---------------------------
      // baodzaik7) ACCOUNTING: helpers (RTDB operations + UI)
      // ---------------------------
      // ---------------------------
      // 12) ACCOUNTING: helpers (RTDB operations + UI)
      // ---------------------------

      // L∆∞u √Ω: C√°c bi·∫øn v√† h√†m nh∆∞ 'db', 'rtdb', 'auth', 'collection', 'getDocs', 'dbRef', 'dbGet', 'dbSet', 'runTransaction', 'where', 'query', 'addDoc', 'onSnapshot', 'UI', 'safeShow', 'safeHide', 'currentUserRole', 'firebaseConfig', 'roleNames', 'departmentNames', 'recipientNames', 'unsubscribeUserNotifsListener' ph·∫£i ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a v√† kh·ªüi t·∫°o ·ªü n∆°i kh√°c trong m√£ ngu·ªìn c·ªßa b·∫°n.

      // encode email for RTDB keys (simple)
      function encodeEmailKey(email) {
        return email.replace(/\./g, ",");
      }

      // show accounting tabs
      window.showAccountingTab = function (tab) {
        const tabs = ["attendance", "payroll", "report"];
        tabs.forEach((t) => {
          const btn = document.getElementById("tab-" + t);
          const panel = document.getElementById("acct-" + t);
          if (t === tab) {
            if (btn) {
              btn.classList.remove("bg-gray-200");
              btn.classList.add("bg-indigo-600", "text-white");
            }
            if (panel) panel.classList.remove("hidden");
          } else {
            if (btn) {
              btn.classList.add("bg-gray-200");
              btn.classList.remove("bg-indigo-600", "text-white");
            }
            if (panel) panel.classList.add("hidden");
          }
        });
        // load content for active
        if (tab === "attendance") loadAccountingAttendanceList();
        if (tab === "payroll") loadAccountingPayrollList();
        // B√°o c√°o kh√¥ng c·∫ßn t·∫£i data m√† ch·ªâ c·∫ßn hi·ªÉn th·ªã UI, ƒë·ª£i user b·∫•m t·∫°o
      };

      // open/close accounting view
      window.openAccountingView = function () {
        if (currentUserRole === "giamdoc" || currentUserRole === "ketoan") {
          safeShow("accounting-view");
          // M·∫∑c ƒë·ªãnh tab ch·∫•m c√¥ng khi m·ªü
          window.showAccountingTab("attendance");
          // load lists (loadAccountingAttendanceList ƒë∆∞·ª£c g·ªçi trong showAccountingTab)
          // loadAccountingPayrollList();
        } else {
          UI.displayMessage(
            "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng K·∫ø to√°n.",
            "error"
          );
        }
      };
      window.closeAccountingView = function () {
        safeHide("accounting-view");
      };

      // load user list for accounting attendance tab (reuse public user_profiles)
      async function loadAccountingAttendanceList() {
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const snap = await getDocs(colRef);
          const users = [];
          snap.forEach((d) => users.push(d.data()));
          renderAccountingAttendance(users);
        } catch (e) {
          console.error("loadAccountingAttendanceList error:", e);
          const body = document.getElementById("acct-attendance-body");
          if (body)
            body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">L·ªói t·∫£i danh s√°ch: ${e.message}</td></tr>`;
        }
      }

      // render attendance table rows
      async function renderAccountingAttendance(users) {
        const tbody = document.getElementById("acct-attendance-body");
        if (!tbody) return;
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng.</td></tr>`;
          return;
        }
        const rows = [];
        for (const user of users) {
          const emailKey = encodeEmailKey(user.email || "");
          let totalHours = 0;
          try {
            // L·∫•y t·ªïng gi·ªù t·ª´ RTDB
            const snap = await dbGet(
              dbRef(rtdb, `/ChamCong/${emailKey}/tongGio`)
            );
            if (snap.exists()) totalHours = snap.val();
          } catch (e) {
            console.warn("getTotalHours error", e);
          }
          const btnDisabled = user.disabled ? "disabled" : "";
          const actionBtn = `<button onclick="markAttendance('${user.email}')" class="py-1 px-3 bg-indigo-500 text-white text-xs font-medium rounded-lg hover:bg-indigo-600 transition" ${btnDisabled}>Ch·∫•m c√¥ng (+8h)</button>`;
          rows.push(`
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email}</td>
            <td class="px-3 py-2 text-gray-800">${
              roleNames[user.role] || user.role
            }</td>
            <td class="px-3 py-2 text-gray-700">${
              departmentNames[user.phongBan] || "Ch∆∞a ph√¢n c√¥ng"
            }</td>
            <td class="px-3 py-2 whitespace-nowrap text-center">${totalHours}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center">${actionBtn}</td>
        `);
        }
        UI.renderTableRows("acct-attendance-body", rows);
      }

      // transaction to add 8 hours
      window.markAttendance = async function (email) {
        if (!(currentUserRole === "giamdoc" || currentUserRole === "ketoan")) {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn ch·∫•m c√¥ng.", "error");
          return;
        }
        const key = encodeEmailKey(email);
        const ref = dbRef(rtdb, `/ChamCong/${key}/tongGio`);
        try {
          await runTransaction(ref, (current) => {
            return (current || 0) + 8;
          });
          // push history
          const histRef = dbRef(rtdb, `/ChamCong/${key}/history/${Date.now()}`);
          await dbSet(histRef, {
            hours: 8,
            by: auth.currentUser ? auth.currentUser.email : "system",
            at: new Date().toISOString(),
          });
          UI.displayMessage(`ƒê√£ ch·∫•m c√¥ng +8h cho ${email}`, "success");
          // refresh attendance list
          loadAccountingAttendanceList();
          loadAccountingPayrollList(); // C·∫≠p nh·∫≠t lu√¥n l∆∞∆°ng c·ª©ng
        } catch (e) {
          console.error("markAttendance error:", e);
          UI.displayMessage(`L·ªói ch·∫•m c√¥ng: ${e.message}`, "error");
        }
      };

      // payroll list (for selection)
      async function loadAccountingPayrollList() {
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const snap = await getDocs(colRef);
          const users = [];
          snap.forEach((d) => users.push(d.data()));
          renderAccountingPayroll(users);
        } catch (e) {
          console.error("loadAccountingPayrollList error:", e);
          const body = document.getElementById("acct-payroll-body");
          if (body)
            body.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">L·ªói t·∫£i danh s√°ch: ${e.message}</td></tr>`;
        }
      }

      async function renderAccountingPayroll(users) {
        const tbody = document.getElementById("acct-payroll-body");
        if (!tbody) return;
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng.</td></tr>`;
          return;
        }
        const rows = [];
        for (const user of users) {
          const emailKey = encodeEmailKey(user.email || "");
          let totalHours = 0;
          try {
            // L·∫•y t·ªïng gi·ªù t·ª´ RTDB
            const snap = await dbGet(
              dbRef(rtdb, `/ChamCong/${emailKey}/tongGio`)
            );
            if (snap.exists()) totalHours = snap.val();
          } catch (e) {}
          // Gi·∫£ s·ª≠ l∆∞∆°ng 1 gi·ªù l√† 24,000
          const luongCung = totalHours * 24000;
          const actionBtn = `<button onclick="openPayrollModal('${user.email}')" class="py-1 px-3 bg-yellow-500 text-white text-xs font-medium rounded-lg hover:bg-yellow-600 transition">T√≠nh l∆∞∆°ng</button>`;
          rows.push(`
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email}</td>
            <td class="px-3 py-2 text-gray-800">${totalHours}</td>
            <td class="px-3 py-2 text-gray-800">${luongCung.toLocaleString(
              "vi-VN"
            )} ƒë</td>
            <td class="px-3 py-2 whitespace-nowrap">${actionBtn}</td>
        `);
        }
        UI.renderTableRows("acct-payroll-body", rows);
      }

      // open payroll modal (simple prompt flow to keep file single)
      window.openPayrollModal = async function (email) {
        if (!(currentUserRole === "giamdoc" || currentUserRole === "ketoan")) {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn t√≠nh l∆∞∆°ng.", "error");
          return;
        }
        const key = encodeEmailKey(email);
        let totalHours = 0;
        try {
          const snap = await dbGet(dbRef(rtdb, `/ChamCong/${key}/tongGio`));
          if (snap.exists()) totalHours = snap.val();
        } catch (e) {}
        const luongCung = totalHours * 24000;

        // S·ª≠ d·ª•ng prompt ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu
        const phuCap = prompt(
          `Nh·∫≠p ph·ª• c·∫•p cho ${email} (100000 / 200000 / 300000), ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥:`,
          "100000"
        );
        if (phuCap === null) return;
        const thuong = prompt(
          `Nh·∫≠p ti·ªÅn th∆∞·ªüng cho ${email} (s·ªë nguy√™n), ƒë·ªÉ 0 n·∫øu kh√¥ng c√≥:`,
          "0"
        );
        if (thuong === null) return;

        const pc = parseInt(phuCap) || 0;
        const tr = parseInt(thuong) || 0;
        const total = luongCung + pc + tr;

        if (
          !confirm(
            `X√°c nh·∫≠n xu·∫•t phi·∫øu l∆∞∆°ng cho ${email}?\n\nT·ªïng gi·ªù: ${totalHours}\nL∆∞∆°ng c·ª©ng: ${luongCung.toLocaleString(
              "vi-VN"
            )} ƒë\nPh·ª• c·∫•p: ${pc.toLocaleString(
              "vi-VN"
            )} ƒë\nTh∆∞·ªüng: ${tr.toLocaleString(
              "vi-VN"
            )} ƒë\n=> Total: ${total.toLocaleString("vi-VN")} ƒë`
          )
        )
          return;

        // create salary slip
        await createSalarySlip(email, {
          hours: totalHours,
          luongCung,
          phuCap: pc,
          thuong: tr,
          total,
        });
      };

      async function createSalarySlip(
        email,
        { hours, luongCung, phuCap, thuong, total }
      ) {
        try {
          const key = encodeEmailKey(email);
          const slipId = `PL_${Date.now()}`;
          // 1. L∆∞u phi·∫øu l∆∞∆°ng v√†o RTDB
          const slipRef = dbRef(rtdb, `/PhieuLuong/${key}/${slipId}`);
          await dbSet(slipRef, {
            hours,
            luong_cung: luongCung,
            phu_cap: phuCap,
            thuong,
            total,
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
            createdAt: new Date().toISOString(),
          });

          // 2. T√¨m UID c·ªßa ng∆∞·ªùi d√πng ƒë·ªÉ g·ª≠i th√¥ng b√°o
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const q = query(colRef, where("email", "==", email));
          const snaps = await getDocs(q);
          let targetUid = null;
          snaps.forEach((d) => {
            targetUid = d.id; // id l√† uid
          });

          // 3. G·ª≠i th√¥ng b√°o (Firestore)
          const notifTieuDe = "Th√¥ng b√°o phi·∫øu l∆∞∆°ng";
          const notifNoiDung = `B·∫°n ƒë√£ ƒë∆∞·ª£c xu·∫•t phi·∫øu l∆∞∆°ng. T·ªïng ti·ªÅn: ${total.toLocaleString(
            "vi-VN"
          )} ƒë. Vui l√≤ng ki·ªÉm tra chi ti·∫øt.`;
          const notificationData = {
            matb: `PL${Date.now().toString().slice(-6)}`,
            tieuDe: notifTieuDe,
            noiDung: notifNoiDung,
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: targetUid || email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          };
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, notificationData);

          UI.displayMessage(
            `Phi·∫øu l∆∞∆°ng cho ${email} ƒë√£ ƒë∆∞·ª£c l∆∞u v√† th√¥ng b√°o ƒë√£ g·ª≠i.`,
            "success"
          );
          // refresh payroll list
          loadAccountingPayrollList();
        } catch (e) {
          console.error("createSalarySlip error:", e);
          UI.displayMessage(`L·ªói xu·∫•t phi·∫øu l∆∞∆°ng: ${e.message}`, "error");
        }
      }

      // generate accounting report (simple scan of RTDB /PhieuLuong)
      window.generateAccountingReport = async function () {
        if (!(currentUserRole === "giamdoc" || currentUserRole === "ketoan")) {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o b√°o c√°o.", "error");
          return;
        }
        try {
          const start = document.getElementById("report-start").value;
          const end = document.getElementById("report-end").value;
          if (!start || !end) {
            UI.displayMessage(
              "Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c.",
              "error"
            );
            return;
          }
          // read all PhieuLuong root
          const rootRef = dbRef(rtdb, `/PhieuLuong`);
          const snap = await dbGet(rootRef);
          let totalPaid = 0;
          let staffSet = new Set();
          const results = [];

          if (snap.exists()) {
            const all = snap.val();
            for (const emailKey in all) {
              const slips = all[emailKey];
              for (const slipId in slips) {
                const slip = slips[slipId];
                const createdAt = slip.createdAt || "";
                // L·ªçc theo ng√†y t·∫°o (createdAt)
                const createdDate = createdAt.split("T")[0];
                if (createdDate >= start && createdDate <= end) {
                  totalPaid += Number(slip.total || 0);
                  staffSet.add(emailKey);
                  // Gi·∫£i m√£ email cho b√°o c√°o d·ªÖ ƒë·ªçc h∆°n
                  const email = emailKey.replace(/,/g, ".");
                  results.push({ email, slipId, ...slip });
                }
              }
            }
          }

          const reportEl = document.getElementById("acct-report-result");
          if (reportEl) {
            reportEl.innerHTML = `
                <p class="text-sm">T·ªïng ti·ªÅn ƒë√£ tr·∫£: <b>${totalPaid.toLocaleString(
                  "vi-VN"
                )} ƒë</b></p>
                <p class="text-sm">S·ªë nh√¢n vi√™n ƒë√£ t√≠nh l∆∞∆°ng: <b>${
                  staffSet.size
                }</b></p>
                <div class="mt-3"><details><summary class="cursor-pointer font-medium text-gray-700">Chi ti·∫øt c√°c phi·∫øu l∆∞∆°ng</summary><pre class="text-xs p-2 bg-gray-50 border rounded overflow-x-auto">${JSON.stringify(
                  results,
                  null,
                  2
                )}</pre></details></div>`;
          }

          // show send report button
          const sendBtn = document.getElementById("send-report-btn");
          if (sendBtn) sendBtn.classList.remove("hidden");

          // store last generated report on client state
          window._lastGeneratedReport = {
            start,
            end,
            totalPaid,
            staffCount: staffSet.size,
            details: results,
          };
          UI.displayMessage(
            "B√°o c√°o ƒë√£ ƒë∆∞·ª£c t·∫°o. Vui l√≤ng ki·ªÉm tra v√† g·ª≠i ƒëi.",
            "success"
          );
        } catch (e) {
          console.error("generateAccountingReport error:", e);
          UI.displayMessage(`L·ªói t·∫°o b√°o c√°o: ${e.message}`, "error");
        }
      };

      window.sendReportToDirector = async function () {
        if (!window._lastGeneratedReport) {
          UI.displayMessage(
            "Ch∆∞a c√≥ b√°o c√°o ƒë·ªÉ g·ª≠i. Vui l√≤ng T·∫°o b√°o c√°o tr∆∞·ªõc.",
            "error"
          );
          return;
        }
        if (!(currentUserRole === "ketoan" || currentUserRole === "giamdoc")) {
          UI.displayMessage("B·∫°n kh√¥ng c√≥ quy·ªÅn g·ª≠i b√°o c√°o.", "error");
          return;
        }
        try {
          const r = window._lastGeneratedReport;
          const reportId = `RPT_${Date.now()}`;

          // 1. save report summary to RTDB
          await dbSet(dbRef(rtdb, `/BaoCaoKeToan/${reportId}`), {
            periodStart: r.start,
            periodEnd: r.end,
            totalPaid: r.totalPaid,
            staffCount: r.staffCount,
            generatedBy: auth.currentUser ? auth.currentUser.email : "system",
            createdAt: new Date().toISOString(),
            // L∆∞u tr·ªØ chi ti·∫øt d∆∞·ªõi d·∫°ng JSON string ƒë·ªÉ tr√°nh l·ªói RTDB n·∫øu qu√° l·ªõn
            // detailsSummary: r.details.length
          });

          // 2. notify gi√°m ƒë·ªëc via Firestore notifications
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `RPT${Date.now().toString().slice(-6)}`,
            tieuDe: `B√°o c√°o k·∫ø to√°n (${r.start} ‚Üí ${r.end})`,
            noiDung: `T·ªïng ti·ªÅn ƒë√£ tr·∫£: ${r.totalPaid.toLocaleString(
              "vi-VN"
            )} ƒë\nS·ªë NV ƒë√£ t√≠nh l∆∞∆°ng: ${r.staffCount}`,
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: "giamdoc", // Target the Director role
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });

          // ·∫®n n√∫t g·ª≠i b√°o c√°o sau khi g·ª≠i th√†nh c√¥ng
          const sendBtn = document.getElementById("send-report-btn");
          if (sendBtn) sendBtn.classList.add("hidden");

          UI.displayMessage(
            "B√°o c√°o ƒë√£ g·ª≠i cho Gi√°m ƒë·ªëc v√† l∆∞u v√†o h·ªá th·ªëng.",
            "success"
          );
        } catch (e) {
          console.error("sendReportToDirector error:", e);
          UI.displayMessage(`L·ªói g·ª≠i b√°o c√°o: ${e.message}`, "error");
        }
      };

      // --- C√ÅC H√ÄM LI√äN QUAN ƒê·∫æN TH√îNG B√ÅO (THEO LOGIC BAN ƒê·∫¶U) ---

      function renderNotificationHistory(notifications) {
        const tbody = document.getElementById("notif-history-body");
        if (!tbody) return;
        if (!notifications || notifications.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ th√¥ng b√°o n√†o ƒë∆∞·ª£c t·∫°o.</td></tr>`;
          return;
        }
        const rows = notifications.map((notif) => {
          const doiTuongDisplay =
            recipientNames[notif.doiTuongNhan] ||
            (notif.doiTuongNhan ===
            (auth.currentUser ? auth.currentUser.uid : null)
              ? "C√° nh√¢n (ƒêi·ªÅu ƒë·ªông)"
              : notif.doiTuongNhan);
          const loaiClass =
            notif.loaiThongBao === "khancap"
              ? "bg-red-500 text-white"
              : "bg-blue-100 text-blue-800";
          return `
            <td class="px-3 py-2 whitespace-nowrap text-gray-900 font-medium">${
              notif.matb
            }</td>
            <td class="px-3 py-2 text-gray-800">${notif.tieuDe}</td>
            <td class="px-3 py-2 whitespace-nowrap">${UI.formatDate(
              notif.ngayGui
            )}</td>
            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-600">${doiTuongDisplay}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${loaiClass}">${
            notif.loaiThongBao === "khancap" ? "KH·∫®N C·∫§P" : "Th∆∞·ªùng k·ª≥"
          }</span></td>
        `;
        });
        UI.renderTableRows("notif-history-body", rows);
      }
      function listenForUserNotifications() {
        if (unsubscribeUserNotifsListener) {
          unsubscribeUserNotifsListener();
          unsubscribeUserNotifsListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          const role = currentUserRole;
          const currentUid = auth.currentUser ? auth.currentUser.uid : null;

          const roleRecipients = ["toancongty"];
          if (role === "quanlynhansu") roleRecipients.push("quanlynhansu");
          else if (role === "ketoan") roleRecipients.push("ketoan");
          else if (role === "giamdoc") roleRecipients.push("giamdoc"); // B·ªï sung gi√°m ƒë·ªëc

          const targetRecipients = [...roleRecipients, currentUid].slice(0, 10); // Firestore 'in' array limit precaution

          const q = query(
            colRef,
            where("doiTuongNhan", "in", targetRecipients)
          );
          unsubscribeUserNotifsListener = onSnapshot(
            q,
            (snap) => {
              const notifications = [];
              snap.forEach((d) =>
                notifications.push({ id: d.id, ...d.data() })
              );
              notifications.sort(
                (a, b) => new Date(b.ngayGui) - new Date(a.ngayGui)
              );
              renderUserNotifications(notifications);
            },
            (err) => {
              console.error("listenForUserNotifications error:", err);
              const el = document.getElementById("user-notifications-list");
              if (el)
                el.innerHTML = `<p class="text-center py-8 text-red-500">L·ªói t·∫£i th√¥ng b√°o: ${err.message}</p>`;
            }
          );
        } catch (e) {
          console.error("listenForUserNotifications setup error:", e);
        }
      }

      function renderUserNotifications(notifications) {
        const listContainer = document.getElementById(
          "user-notifications-list"
        );
        if (!listContainer) return;
        listContainer.innerHTML = "";
        if (!notifications || notifications.length === 0) {
          listContainer.innerHTML = `<p class="text-center py-8 text-gray-500">Hi·ªán t·∫°i kh√¥ng c√≥ th√¥ng b√°o n√†o d√†nh cho vai tr√≤ c·ªßa b·∫°n.</p>`;
          return;
        }
        // render cards
        const frag = document.createDocumentFragment();
        notifications.forEach((notif) => {
          const isUrgent = notif.loaiThongBao === "khancap";
          const card = document.createElement("div");
          card.className = `p-4 rounded-lg shadow-md ${
            isUrgent
              ? "border-l-4 border-red-500 bg-red-50"
              : "border-l-4 border-blue-500 bg-blue-50"
          }`;
          const titleClass = isUrgent
            ? "text-red-700 font-extrabold"
            : "text-blue-700 font-bold";
          let doiTuongDisplay =
            recipientNames[notif.doiTuongNhan] || notif.doiTuongNhan;
          if (
            notif.doiTuongNhan ===
            (auth.currentUser ? auth.currentUser.uid : null)
          )
            doiTuongDisplay = "C√° nh√¢n b·∫°n (ƒêi·ªÅu ƒë·ªông)";

          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h4 class="text-lg ${titleClass}">${notif.tieuDe}</h4>
                <span class="text-xs text-gray-500 whitespace-nowrap">${
                  isUrgent ? "KH·∫®N C·∫§P | " : ""
                } ${UI.formatDate(notif.ngayGui)}</span>
            </div>
            <p class="text-sm text-gray-800 whitespace-pre-wrap">${(
              notif.noiDung || ""
            ).replace(/\n/g, "<br>")}</p>
            <p class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">M√£: ${
              notif.matb
            } | Nh·∫≠n cho: ${doiTuongDisplay}</p>
        `;
          frag.appendChild(card);
        });
        listContainer.appendChild(frag);
      }

      // H√†m gi·∫£ ƒë·ªãnh cho c√°c ph·∫ßn t·ª≠ UI ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
      // (openSalaryModal/closeSalaryModal v√† c√°c h√†m c·ªßa modal b√°o c√°o l∆∞∆°ng kh√¥ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü ƒë√¢y)

      // window.openSalaryModal = function() { safeShow('salary-modal'); /* load salary history logic */ }
      // window.closeSalaryModal = function() { safeHide('salary-modal'); }
      // ---------------------------
      // 12) LISTEN TO ROLE CHANGES (onAuthStateChanged)
      // ---------------------------
      function listenForUserRole(uid) {
        if (unsubscribeRoleListener) {
          unsubscribeRoleListener();
          unsubscribeRoleListener = null;
        }
        try {
          const userDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
          );
          unsubscribeRoleListener = onSnapshot(
            userDocRef,
            (docSnap) => {
              const currentRoleEl = document.getElementById("current-role");
              const openBtn = document.getElementById("open-management-btn");
              const accountingBtn = document.getElementById(
                "open-accounting-btn"
              );
              const currentDeptSpan = document.getElementById(
                "current-department"
              )
                ? document
                    .getElementById("current-department")
                    .querySelector("span")
                : null;

              if (docSnap.exists()) {
                const data = docSnap.data();
                const roleKey = data.role || "nhanvien";
                const deptKey = data.phongBan || "N/A";
                currentUserRole = roleKey;
                if (currentRoleEl)
                  currentRoleEl.textContent =
                    roleNames[roleKey] || "Vai tr√≤ kh√¥ng x√°c ƒë·ªãnh";
                if (currentDeptSpan)
                  currentDeptSpan.textContent =
                    departmentNames[deptKey] || "Ch∆∞a ph√¢n c√¥ng";
                if (roleKey === "giamdoc") openBtn.classList.remove("hidden");
                else openBtn.classList.add("hidden");
                // show accounting button for giamdoc and ketoan
                if (roleKey === "giamdoc" || roleKey === "ketoan")
                  accountingBtn.classList.remove("hidden");
                else accountingBtn.classList.add("hidden");
                if (roleKey !== "giamdoc") {
                  safeHide("system-management-view");
                  safeHide("user-management-view");
                  safeHide("notification-management-view");
                  safeHide("personnel-deployment-view");
                }
              } else {
                if (currentRoleEl)
                  currentRoleEl.textContent = "ƒêang thi·∫øt l·∫≠p vai tr√≤...";
                if (currentDeptSpan)
                  currentDeptSpan.textContent = "ƒêang thi·∫øt l·∫≠p...";
                saveUserProfile(
                  uid,
                  auth.currentUser ? auth.currentUser.email : "unknown",
                  "nhanvien"
                );
              }
            },
            (err) => {
              console.error("listenForUserRole error:", err);
              UI.displayMessage(
                "Kh√¥ng th·ªÉ t·∫£i vai tr√≤ ng∆∞·ªùi d√πng (ki·ªÉm tra Firestore).",
                "error"
              );
            }
          );
        } catch (e) {
          console.error("listenForUserRole setup error:", e);
        }
      }

      onAuthStateChanged(auth, (user) => {
        const authView = document.getElementById("auth-view");
        const mainAppView = document.getElementById("main-app-view");
        if (user) {
          if (authView) authView.classList.add("hidden");
          if (mainAppView) mainAppView.classList.remove("hidden");
          const uemail = document.getElementById("user-email");
          const uuid = document.getElementById("user-uid");
          if (uemail) uemail.textContent = user.email;
          if (uuid) uuid.textContent = user.uid;
          listenForUserRole(user.uid);
        } else {
          if (authView) authView.classList.remove("hidden");
          if (mainAppView) mainAppView.classList.add("hidden");
          // unsubscribe everything on signout
          if (unsubscribeRoleListener) {
            unsubscribeRoleListener();
            unsubscribeRoleListener = null;
          }
          if (unsubscribeUserListListener) {
            unsubscribeUserListListener();
            unsubscribeUserListListener = null;
          }
          if (unsubscribeNotifHistoryListener) {
            unsubscribeNotifHistoryListener();
            unsubscribeNotifHistoryListener = null;
          }
          if (unsubscribeUserNotifsListener) {
            unsubscribeUserNotifsListener();
            unsubscribeUserNotifsListener = null;
          }
          if (unsubscribePersonnelListListener) {
            unsubscribePersonnelListListener();
            unsubscribePersonnelListListener = null;
          }
        }
      });

      /* ============================
         END OF JS CODE
         ============================ */
      /* ============================
¬† ¬†HR / PROFILE / REQUESTS MODULE
¬† ¬†(ƒê√£ g·ªôp to√†n b·ªô logic c·ªßa b·∫°n v√† gi·ªØ nguy√™n)
¬† ¬†============================ */

      /* ============================
¬† ¬†HR / PROFILE / REQUESTS MODULE
¬† ¬†(ƒê√£ g·ªôp to√†n b·ªô logic c·ªßa b·∫°n v√† gi·ªØ nguy√™n)
¬† ¬†============================ */
      /* ============================
¬† ¬†HR / PROFILE / REQUESTS MODULE
¬† ¬†(ƒê√£ g·ªôp to√†n b·ªô logic c·ªßa b·∫°n v√† gi·ªØ nguy√™n)
¬† ¬†============================ */

      /* ============================
¬† ¬†HR / PROFILE / REQUESTS MODULE
¬† ¬†(ƒê√£ g·ªôp to√†n b·ªô logic c·ªßa b·∫°n v√† gi·ªØ nguy√™n)
¬† ¬†============================ */
      // helpers for DOM
      // Bi·∫øn to√†n c·ª•c (ƒë√£ gi·∫£ ƒë·ªãnh t·ªìn t·∫°i trong m√¥i tr∆∞·ªùng c·ªßa b·∫°n)
      // const auth = firebase.auth();
      // const db = firebase.firestore();
      // const rtdb = firebase.database();
      // const firebaseConfig = {...};
      // const currentUserRole = '...'; // Gi·∫£ s·ª≠ bi·∫øn n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi ƒëƒÉng nh·∫≠p
      // const roleNames = { 'giamdoc': 'Gi√°m ƒë·ªëc', 'quanlynhansu': 'Qu·∫£n l√Ω Nh√¢n s·ª±', 'nhanvien': 'Nh√¢n vi√™n', ... };
      // const departmentNames = { 'hanhchinh': 'Ph√≤ng H√†nh ch√≠nh - Nh√¢n s·ª±', 'ketoan': 'Ph√≤ng K·∫ø to√°n - T√†i ch√≠nh', ... };

      // Bi·∫øn to√†n c·ª•c (gi·∫£ ƒë·ªãnh t·ªìn t·∫°i trong m√¥i tr∆∞·ªùng c·ªßa b·∫°n)
      // const auth = firebase.auth();
      // const db = firebase.firestore();
      // const rtdb = firebase.database();
      // const firebaseConfig = {...};
      // const currentUserRole = '...'; // Gi·∫£ s·ª≠ bi·∫øn n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi ƒëƒÉng nh·∫≠p
      // const roleNames = { 'giamdoc': 'Gi√°m ƒë·ªëc', 'quanlynhansu': 'Qu·∫£n l√Ω Nh√¢n s·ª±', 'nhanvien': 'Nh√¢n vi√™n', ... };
      // const departmentNames = { 'hanhchinh': 'Ph√≤ng H√†nh ch√≠nh - Nh√¢n s·ª±', 'ketoan': 'Ph√≤ng K·∫ø to√°n - T√†i ch√≠nh', ... };
      // const UI = { displayMessage: (msg, type) => console.log(`[UI] ${type}: ${msg}`) }; // Gi·∫£ l·∫≠p UI n·∫øu ch∆∞a c√≥

      // helpers for DOM

      // --- HELPER FUNCTION: CREATE INITIALS AVATAR ---
      // (Gi·ªØ nguy√™n)
      const $ = (id) => document.getElementById(id);

      // --- HELPER FUNCTION: CREATE INITIALS AVATAR ---
      // (Gi·ªØ nguy√™n)
      function createAvatarFromInitials(name) {
        if (!name || typeof name !== "string") return "";
        const parts = name.trim().split(/\s+/);
        let initials = ""; // L·∫•y ch·ªØ c√°i ƒë·∫ßu ti√™n c·ªßa t·ª´ cu·ªëi c√πng (t√™n)
        if (parts.length > 0) {
          initials = parts[parts.length - 1].charAt(0).toUpperCase();
        } // H√†m n√†y gi·∫£ ƒë·ªãnh t·∫°o ra m·ªôt Data URL cho ·∫£nh placeholder.
        const size = 100;
        const bgColor =
          "hsl(" + Math.floor(Math.random() * 360) + ", 60%, 70%)"; // M√†u ng·∫´u nhi√™n
        const textColor = "#fff";

        const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
¬† ¬† ¬† ¬† <rect width="${size}" height="${size}" fill="${bgColor}" />
¬† ¬† ¬† ¬† <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="${
          size * 0.5
        }" fill="${textColor}" font-family="Arial, sans-serif">${initials}</text>
¬† ¬† </svg>`;
        return "data:image/svg+xml;base64," + btoa(svg);
      }

      // ---------------------------
      // PROFILE: open/close & render
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      window.openProfileModal = async function (uid = null) {
        // if uid not provided, use auth.currentUser
        const user = auth.currentUser;
        if (!user && !uid) {
          UI.displayMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin.", "error");
          return;
        }
        const targetUid = uid || (user ? user.uid : null); // 1. L·∫•y Profile t·ª´ Firestore

        let profile = null;
        let targetEmail = null;
        try {
          const snap = await getDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${targetUid}`
            )
          );
          if (snap.exists()) {
            profile = snap.data();
            targetEmail =
              profile.email ||
              (user && user.uid === targetUid ? user.email : null);
          } else {
            targetEmail = user && user.uid === targetUid ? user.email : null;
          }
        } catch (e) {
          console.error("openProfileModal get profile error", e);
        } // 2. ƒê·ªãnh nghƒ©a c√°c t√†i kho·∫£n ƒë·∫∑c bi·ªát cho ·∫£nh
        const SPECIAL_AVATAR_USERS = {
          "quyen2@gmail.com":
            "https://sf-static.upanhlaylink.com/img/image_202510257ffd7d6e7976a9a7c173360632b896ac.jpg",
          "doanbao398@gmail.com":
            "https://sf-static.upanhlaylink.com/img/image_20251025eaa28626a01c0bf6e526a81832e1e498.jpg",
        }; // 3. X·ª≠ l√Ω d·ªØ li·ªáu Profile (∆Øu ti√™n DB, thi·∫øu th√¨ "Ch·ªù c·∫≠p nh·∫≠t")
        const hoTen = profile && profile.hoTen ? profile.hoTen : "Ch·ªù c·∫≠p nh·∫≠t";
        const mans = profile && profile.mans ? profile.mans : "Ch·ªù c·∫≠p nh·∫≠t"; // D√πng roleName/departmentNames n·∫øu c√≥, kh√¥ng th√¨ d√πng gi√° tr·ªã th√¥ ho·∫∑c "Ch·ªù c·∫≠p nh·∫≠t"
        const roleText =
          profile && profile.role
            ? typeof roleNames !== "undefined"
              ? roleNames[profile.role] || profile.role
              : profile.role
            : "Ch·ªù c·∫≠p nh·∫≠t";
        const deptText =
          profile && profile.phongBan
            ? typeof departmentNames !== "undefined"
              ? departmentNames[profile.phongBan] || profile.phongBan
              : profile.phongBan
            : "Ch·ªù c·∫≠p nh·∫≠t";
        const duAn = profile && profile.duAn ? profile.duAn : "Ch·ªù c·∫≠p nh·∫≠t";
        const ngaySinh =
          profile && profile.ngaySinh ? profile.ngaySinh : "Ch·ªù c·∫≠p nh·∫≠t";
        const gioiTinh =
          profile && profile.gioiTinh ? profile.gioiTinh : "Ch·ªù c·∫≠p nh·∫≠t";
        const ngayVaoLam =
          profile && profile.ngayVaoLam ? profile.ngayVaoLam : "Ch·ªù c·∫≠p nh·∫≠t"; // 4. Thi·∫øt l·∫≠p Avatar

        let avatarUrl = "";
        if (targetEmail && SPECIAL_AVATAR_USERS[targetEmail]) {
          // ∆Øu ti√™n ·∫£nh ƒë·∫∑c bi·ªát
          avatarUrl = SPECIAL_AVATAR_USERS[targetEmail];
          $("profile-avatar").classList.remove("hidden");
        } else if (profile && profile.photoURL) {
          // N·∫øu c√≥ ·∫£nh trong DB (photoURL)
          avatarUrl = profile.photoURL;
          $("profile-avatar").classList.remove("hidden");
        } else if (hoTen !== "Ch·ªù c·∫≠p nh·∫≠t") {
          // T·∫°o ·∫£nh ch·ªØ c√°i n·∫øu c√≥ t√™n
          avatarUrl = createAvatarFromInitials(hoTen);
          $("profile-avatar").classList.remove("hidden");
        } else {
          // ·∫®n n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu g√¨ (hoTen l√† "Ch·ªù c·∫≠p nh·∫≠t")
          $("profile-avatar").classList.add("hidden");
          avatarUrl = "";
        } // 5. C·∫≠p nh·∫≠t DOM

        $("profile-avatar").src = avatarUrl;
        $("profile-name").textContent = `H·ªå T√äN: ${hoTen}`;
        $("profile-mans").textContent = mans;
        $("profile-role").textContent = roleText;
        $("profile-dept").textContent = deptText;
        $("profile-project").textContent = duAn;
        $("profile-dob").textContent = ngaySinh;
        $("profile-gender").textContent = gioiTinh;
        $("profile-join").textContent = ngayVaoLam;
        $("profile-perm").textContent = roleText; // Quy·ªÅn h·∫°n th∆∞·ªùng l√† vai tr√≤/ch·ª©c v·ª• // show modal

        $("profile-modal").classList.remove("hidden");
      };

      window.closeProfileModal = function () {
        $("profile-modal").classList.add("hidden");
      };
      // ---------------------------
      // EMPLOYEE REGISTER (Leave / OT)
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      window.openEmployeeRegisterModal = function () {
        if (!auth.currentUser)
          return UI.displayMessage(
            "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i ƒëƒÉng k√Ω.",
            "error"
          ); // prefill name and mans if available
        (async () => {
          try {
            const uid = auth.currentUser.uid;
            const snap = await getDoc(
              doc(
                db,
                `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
              )
            );
            const p = snap && snap.exists() ? snap.data() : null;
            if (p) {
              $("leave-mans").value = p.mans || "";
              $("leave-name").value = p.hoTen || auth.currentUser.email;
              $("ot-mans").value = p.mans || "";
              $("ot-name").value = p.hoTen || auth.currentUser.email;
            } else {
              $("leave-name").value = auth.currentUser.email;
              $("ot-name").value = auth.currentUser.email;
            }
          } catch (e) {
            console.warn(e);
          }
        })();

        $("employee-register-modal").classList.remove("hidden");
      };

      window.closeEmployeeRegisterModal = function () {
        $("employee-register-modal").classList.add("hidden");
      };

      window.showEmployeeRegisterForm = function (type) {
        $("employee-leave-form").classList.add("hidden");
        $("employee-ot-form").classList.add("hidden"); // C·∫≠p nh·∫≠t style n√∫t tab
        const leaveBtn = document.querySelector(
          "[onclick=\"showEmployeeRegisterForm('leave')\"]"
        );
        const otBtn = document.querySelector(
          "[onclick=\"showEmployeeRegisterForm('ot')\"]"
        );
        if (type === "leave") {
          $("employee-leave-form").classList.remove("hidden");
          leaveBtn.classList.add("bg-indigo-600", "text-white");
          leaveBtn.classList.remove("bg-gray-200", "text-gray-700");
          otBtn.classList.remove("bg-indigo-600", "text-white");
          otBtn.classList.add("bg-gray-200", "text-gray-700");
        } else {
          $("employee-ot-form").classList.remove("hidden");
          otBtn.classList.add("bg-indigo-600", "text-white");
          otBtn.classList.remove("bg-gray-200", "text-gray-700");
          leaveBtn.classList.remove("bg-indigo-600", "text-white");
          leaveBtn.classList.add("bg-gray-200", "text-gray-700");
        }
      };

      window.submitLeaveRequest = async function (e) {
        e.preventDefault();
        if (!auth.currentUser)
          return UI.displayMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p.", "error");
        const mans = $("leave-mans").value.trim() || "Ch·ªù c·∫≠p nh·∫≠t";
        const hoTen = $("leave-name").value.trim() || auth.currentUser.email;
        const ngayBD = $("leave-start").value;
        const ngayKT = $("leave-end").value;
        const lyDo = $("leave-reason").value.trim() || "";
        if (!ngayBD || !ngayKT)
          return UI.displayMessage(
            "Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c.",
            "error"
          );

        try {
          const key = encodeEmailKey(auth.currentUser.email);
          const id = `L_${Date.now()}`;
          await dbSet(dbRef(rtdb, `/DonTu/Nghi/${key}/${id}`), {
            id,
            mans,
            hoTen,
            ngayBatDau: ngayBD,
            ngayKetThuc: ngayKT,
            lyDo,
            trangThai: "Ch·ªù duy·ªát",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.email,
          });
          UI.displayMessage(
            "ƒê∆°n xin ngh·ªâ ƒë√£ g·ª≠i ƒë·∫øn Qu·∫£n l√Ω nh√¢n s·ª±.",
            "success"
          );
          closeEmployeeRegisterModal();
        } catch (e) {
          console.error("submitLeaveRequest error", e);
          UI.displayMessage("L·ªói g·ª≠i ƒë∆°n.", "error");
        }
      };

      window.submitOTRequest = async function (e) {
        e.preventDefault();
        if (!auth.currentUser)
          return UI.displayMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p.", "error");
        const mans = $("ot-mans").value.trim() || "Ch·ªù c·∫≠p nh·∫≠t";
        const hoTen = $("ot-name").value.trim() || auth.currentUser.email;
        const ngay = $("ot-date").value;
        const soGio = parseInt($("ot-hours").value || "0", 10);
        if (!ngay || soGio <= 0)
          return UI.displayMessage("Vui l√≤ng nh·∫≠p ng√†y v√† s·ªë gi·ªù.", "error");

        try {
          const key = encodeEmailKey(auth.currentUser.email);
          const id = `OT_${Date.now()}`;
          await dbSet(dbRef(rtdb, `/DonTu/TangCa/${key}/${id}`), {
            id,
            mans,
            hoTen,
            ngay,
            soGio,
            trangThai: "Ch·ªù duy·ªát",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.email,
          });
          UI.displayMessage(
            "ƒê∆°n tƒÉng ca ƒë√£ g·ª≠i ƒë·∫øn Qu·∫£n l√Ω nh√¢n s·ª±.",
            "success"
          );
          closeEmployeeRegisterModal();
        } catch (e) {
          console.error("submitOTRequest error", e);
          UI.displayMessage("L·ªói g·ª≠i ƒë∆°n.", "error");
        }
      };

      // ---------------------------
      // HR MANAGEMENT: open/close & tabs
      // ---------------------------
      // Bi·∫øn ƒë·ªÉ l∆∞u h√†m h·ªßy l·∫Øng nghe (unsubscribe function)
      let _hrListUnsubscribe = null;

      window.openHRManagementView = function () {
        if (!auth.currentUser)
          return UI.displayMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p.", "error"); // only for giamdoc or quanlynhansu
        if (
          !(currentUserRole === "giamdoc" || currentUserRole === "quanlynhansu")
        ) {
          UI.displayMessage(
            "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p Qu·∫£n l√Ω nh√¢n s·ª±.",
            "error"
          );
          return;
        }
        $("hr-management-view").classList.remove("hidden");
        showHRTab("update"); // THAY TH·∫æ loadHRUserList() b·∫±ng Realtime Listener
        if (_hrListUnsubscribe === null) {
          _hrListUnsubscribe = setupHRUserListListener();
        }
        loadHRRequests();
        updateHRStatusList();
      };

      window.closeHRManagementView = function () {
        $("hr-management-view").classList.add("hidden"); // H·ª¶Y LISTENER KHI ƒê√ìNG GIAO DI·ªÜN
        if (_hrListUnsubscribe) {
          _hrListUnsubscribe();
          _hrListUnsubscribe = null;
        }
      };

      window.showHRTab = function (tab) {
        const tabs = ["update", "requests", "status", "report"];
        tabs.forEach((t) => {
          $("hr-tab-" + t + (t === "update" ? "" : "-panel")).classList.add(
            "hidden"
          ); // safe hide // show button styles
          const btn = $("hr-tab-" + t);
          if (btn) {
            if (t === tab) {
              btn.classList.remove(
                "bg-gray-100",
                "text-gray-600",
                "hover:bg-gray-200"
              );
              btn.classList.add("bg-indigo-600", "text-white");
            } else {
              btn.classList.add(
                "bg-gray-100",
                "text-gray-600",
                "hover:bg-gray-200"
              );
              btn.classList.remove("bg-indigo-600", "text-white");
            }
          }
        }); // show correct panel
        if (tab === "update")
          $("hr-tab-update-panel").classList.remove("hidden");
        if (tab === "requests")
          $("hr-tab-requests-panel").classList.remove("hidden");
        if (tab === "status")
          $("hr-tab-status-panel").classList.remove("hidden");
        if (tab === "report")
          $("hr-tab-report-panel").classList.remove("hidden");
      };

      // ---------------------------
      // HR: Realtime User List Listener
      // ---------------------------
      let _hrUserListCache = [];

      /**
       * Thi·∫øt l·∫≠p Listener ƒë·ªÉ theo d√µi thay ƒë·ªïi danh s√°ch nh√¢n s·ª± trong Firestore
       */
      function setupHRUserListListener() {
        // ƒê·ªçc Collection user_profiles
        const colRef = collection(
          db,
          `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
        );

        // onSnapshot l√† h√†m tr·∫£ v·ªÅ m·ªôt h√†m h·ªßy l·∫Øng nghe (unsubscribe function)
        const unsubscribe = onSnapshot(
          colRef,
          (snapshot) => {
            const users = [];
            snapshot.forEach((d) =>
              users.push({ uid: d.id, ...(d.data() || {}) })
            );
            _hrUserListCache = users;
            renderHRUserList(users);
            // UI.displayMessage("Danh s√°ch nh√¢n s·ª± ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông (Realtime).", "info");
          },
          (error) => {
            console.error("User List Listener error", error);
            const el = $("hr-user-list-body");
            if (el)
              el.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">L·ªói t·∫£i danh s√°ch t·ª± ƒë·ªông: ${error.message}</td></tr>`;
          }
        );

        return unsubscribe;
      }

      function renderHRUserList(users) {
        const body = $("hr-user-list-body");
        if (!body) return;
        if (!Array.isArray(users) || users.length === 0) {
          body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng.</td></tr>`;
          return;
        }
        const rows = users
          .map((u) => {
            const mans = u.mans || "Ch·ªù c·∫≠p nh·∫≠t";
            const hoten = u.hoTen || "Ch·ªù c·∫≠p nh·∫≠t";
            const dept = departmentNames[u.phongBan] || u.phongBan || "";
            const emailCell = u.email || ""; // TH√äM N√öT X√ìA V√ÄO C·ªòT THAO T√ÅC
            const actionBtn = `
¬† ¬† ¬† ¬† <div class="flex space-x-2 justify-center">
¬† ¬† ¬† ¬† ¬† <button onclick="openHREditProfileModal('${u.uid}')" class="py-1 px-3 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition-colors">Ch·ªânh s·ª≠a</button>
¬† ¬† ¬† ¬† ¬† <button onclick="hrDeleteProfile('${u.uid}', '${hoten}')" class="py-1 px-3 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors">X√≥a</button>
¬† ¬† ¬† ¬† </div>
¬† ¬† `;
            return `
¬† ¬† ¬† <tr>
¬† ¬† ¬† ¬† <td class="px-6 py-3 text-gray-900">${emailCell}</td>
¬† ¬† ¬† ¬† <td class="px-6 py-3 text-gray-800">${mans}</td>
¬† ¬† ¬† ¬† <td class="px-6 py-3 text-gray-800">${hoten}</td>
¬† ¬† ¬† ¬† <td class="px-6 py-3 text-gray-800">${dept}</td>
¬† ¬† ¬† ¬† <td class="px-6 py-3 text-center">${actionBtn}</td>
¬† ¬† ¬† </tr>
¬† ¬† `;
          })
          .join("");
        body.innerHTML = rows;
      }

      // ---------------------------
      // HR: X√≥a h·ªì s∆° (B·ªî SUNG LOGIC)
      // ---------------------------
      window.hrDeleteProfile = async function (uid, hoTen) {
        if (
          !confirm(
            `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªì s∆° c·ªßa "${hoTen}" (UID: ${uid})? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`
          )
        ) {
          return;
        }
        try {
          // 1. X√≥a h·ªì s∆° trong public data (Firestore)
          await deleteDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
            )
          ); // 2. (T√πy ch·ªçn) X√≥a h·ªì s∆° trong private data (Firestore) // ƒê√¢y l√† b∆∞·ªõc th√™m v√†o ƒë·ªÉ ƒë·∫£m b·∫£o s·ª± ƒë·ªìng b·ªô v√† s·∫°ch s·∫Ω.
          await deleteDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
            )
          );
          UI.displayMessage(
            `ƒê√£ x√≥a h·ªì s∆° c·ªßa ${hoTen} th√†nh c√¥ng. Danh s√°ch s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t.`,
            "success"
          ); // Kh√¥ng c·∫ßn g·ªçi l·∫°i render v√¨ Realtime Listener (onSnapshot) s·∫Ω t·ª± ƒë·ªông k√≠ch ho·∫°t
        } catch (e) {
          console.error("hrDeleteProfile error", e);
          UI.displayMessage(
            "L·ªói x√≥a h·ªì s∆°. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Firebase.",
            "error"
          );
        }
      };

      // ---------------------------
      // HR: Edit profile modal (prefill & save)
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      window.openHREditProfileModal = async function (uid) {
        const p = _hrUserListCache.find((x) => x.uid === uid) || null;
        if (!p) {
          UI.displayMessage("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.", "error");
          return;
        }
        $("edit-uid").value = p.uid;
        $("edit-mans").value = p.mans || "";
        $("edit-name").value = p.hoTen || "";
        $("edit-role").value = p.role || "nhanvien";
        $("edit-dept").value = p.phongBan || "";
        $("edit-project").value = p.duAn || "";
        $("edit-dob").value = p.ngaySinh || "";
        $("edit-gender").value = p.gioiTinh || "";
        $("edit-join").value = p.ngayVaoLam || "";
        $("hr-edit-profile-modal").classList.remove("hidden");
      };

      window.closeHREditProfileModal = function () {
        $("hr-edit-profile-modal").classList.add("hidden");
      };

      window.saveHREditedProfile = async function () {
        const uid = $("edit-uid").value;
        if (!uid) return UI.displayMessage("UID kh√¥ng h·ª£p l·ªá.", "error");
        const data = {
          mans: $("edit-mans").value.trim() || null,
          hoTen: $("edit-name").value.trim() || null,
          role: $("edit-role").value || null,
          phongBan: $("edit-dept").value.trim() || null,
          duAn: $("edit-project").value.trim() || null,
          ngaySinh: $("edit-dob").value || null,
          gioiTinh: $("edit-gender").value || null,
          ngayVaoLam: $("edit-join").value || null,
          updatedAt: new Date().toISOString(),
        };
        try {
          // write to public profile doc (merge)
          await setDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
            ),
            data,
            { merge: true }
          ); // also update private profile if exists
          await setDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
            ),
            data,
            { merge: true }
          );
          UI.displayMessage("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng.", "success");
          closeHREditProfileModal(); // KH√îNG C·∫¶N loadHRUserList() v√¨ Realtime Listener ƒë√£ lo vi·ªác c·∫≠p nh·∫≠t
        } catch (e) {
          console.error("saveHREditedProfile error", e);
          UI.displayMessage("L·ªói l∆∞u th√¥ng tin.", "error");
        }
      };

      // ---------------------------
      // HR: Load requests (using RTDB reads)
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      async function loadHRRequests() {
        try {
          // load all leave requests
          const leaveSnap = await dbGet(dbRef(rtdb, `/DonTu/Nghi`));
          const leaveHtml = [];
          if (leaveSnap.exists()) {
            const all = leaveSnap.val();
            for (const emailKey in all) {
              const userRequests = all[emailKey];
              for (const id in userRequests) {
                const r = userRequests[id];
                if (!r) continue;
                if (r.trangThai === "Ch·ªù duy·ªát") {
                  leaveHtml.push(renderLeaveRowHTML(emailKey, id, r));
                }
              }
            }
          }
          $("hr-leave-list").innerHTML = leaveHtml.length
            ? leaveHtml.join("")
            : `<p class="text-center py-6 text-gray-500">Kh√¥ng c√≥ ƒë∆°n xin ngh·ªâ ƒëang ch·ªù duy·ªát.</p>`; // load OT requests

          const otSnap = await dbGet(dbRef(rtdb, `/DonTu/TangCa`));
          const otHtml = [];
          if (otSnap.exists()) {
            const all = otSnap.val();
            for (const emailKey in all) {
              const userRequests = all[emailKey];
              for (const id in userRequests) {
                const r = userRequests[id];
                if (!r) continue;
                if (r.trangThai === "Ch·ªù duy·ªát") {
                  otHtml.push(renderOTRowHTML(emailKey, id, r));
                }
              }
            }
          }
          $("hr-ot-list").innerHTML = otHtml.length
            ? otHtml.join("")
            : `<p class="text-center py-6 text-gray-500">Kh√¥ng c√≥ ƒë∆°n tƒÉng ca ƒëang ch·ªù duy·ªát.</p>`;
        } catch (e) {
          console.error("loadHRRequests error", e);
        }
      }

      function renderLeaveRowHTML(emailKey, id, r) {
        const email = emailKey.replace(/,/g, ".");
        const approveBtn = `<button onclick="hrApproveLeave('${emailKey}','${id}')" class="py-1 px-3 bg-emerald-600 text-white text-xs rounded-lg hover:bg-emerald-700 transition-colors">Duy·ªát</button>`;
        const rejectBtn = `<button onclick="hrRejectLeave('${emailKey}','${id}')" class="py-1 px-3 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors">T·ª´ ch·ªëi</button>`;
        return `<div class="p-3 border-b border-red-200 hover:bg-red-100 transition-colors rounded-lg"><div class="flex justify-between items-center"><div><b class="text-red-800">${
          r.hoTen || email
        }</b> (${
          r.mans || "N/A"
        })<div class="text-xs text-gray-500 mt-0.5">üóìÔ∏è T·ª´ ${r.ngayBatDau} ‚Üí ${
          r.ngayKetThuc
        }</div><div class="text-xs mt-1 text-gray-600 truncate max-w-sm">L√Ω do: ${
          r.lyDo || "N/A"
        }</div></div><div class="space-x-2 flex-shrink-0">${approveBtn}${rejectBtn}</div></div></div>`;
      }

      function renderOTRowHTML(emailKey, id, r) {
        const email = emailKey.replace(/,/g, ".");
        const approveBtn = `<button onclick="hrApproveOT('${emailKey}','${id}')" class="py-1 px-3 bg-emerald-600 text-white text-xs rounded-lg hover:bg-emerald-700 transition-colors">Duy·ªát</button>`;
        const rejectBtn = `<button onclick="hrRejectOT('${emailKey}','${id}')" class="py-1 px-3 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors">T·ª´ ch·ªëi</button>`;
        return `<div class="p-3 border-b border-blue-200 hover:bg-blue-100 transition-colors rounded-lg"><div class="flex justify-between items-center"><div><b class="text-blue-800">${
          r.hoTen || email
        }</b> (${
          r.mans || "N/A"
        })<div class="text-xs text-gray-500 mt-0.5">üìÖ Ng√†y: ${
          r.ngay
        } | ‚è≥ Gi·ªù: ${
          r.soGio
        }</div></div><div class="space-x-2 flex-shrink-0">${approveBtn}${rejectBtn}</div></div></div>`;
      }

      // Approve / Reject handlers
      // (Gi·ªØ nguy√™n)
      window.hrApproveLeave = async function (emailKey, id) {
        try {
          const refPath = `/DonTu/Nghi/${emailKey}/${id}`;
          await dbSet(dbRef(rtdb, refPath + "/trangThai"), "ƒê√£ duy·ªát"); // simple set of status field // also set a status record for user (for tracking)
          const email = emailKey.replace(/,/g, "."); // send notification via Firestore
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `L${Date.now().toString().slice(-6)}`,
            tieuDe: "K·∫øt qu·∫£ duy·ªát ƒë∆°n ngh·ªâ",
            noiDung: "ƒê∆°n xin ngh·ªâ c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email, // if profile stores uid instead use uid
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("ƒê√£ duy·ªát ƒë∆°n xin ngh·ªâ.", "success"); // refresh requests and status list
          await loadHRRequests();
          await updateHRStatusList();
        } catch (e) {
          console.error("hrApproveLeave error", e);
          UI.displayMessage("L·ªói duy·ªát ƒë∆°n.", "error");
        }
      };

      window.hrRejectLeave = async function (emailKey, id) {
        try {
          await dbSet(
            dbRef(rtdb, `/DonTu/Nghi/${emailKey}/${id}/trangThai`),
            "T·ª´ ch·ªëi"
          );
          const email = emailKey.replace(/,/g, ".");
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `L${Date.now().toString().slice(-6)}`,
            tieuDe: "K·∫øt qu·∫£ duy·ªát ƒë∆°n ngh·ªâ",
            noiDung: "ƒê∆°n xin ngh·ªâ c·ªßa b·∫°n ƒë√£ b·ªã t·ª´ ch·ªëi.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("ƒê√£ t·ª´ ch·ªëi ƒë∆°n xin ngh·ªâ.", "info");
          await loadHRRequests();
        } catch (e) {
          console.error("hrRejectLeave error", e);
        }
      };

      window.hrApproveOT = async function (emailKey, id) {
        try {
          await dbSet(
            dbRef(rtdb, `/DonTu/TangCa/${emailKey}/${id}/trangThai`),
            "ƒê√£ duy·ªát"
          );
          const email = emailKey.replace(/,/g, ".");
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `OT${Date.now().toString().slice(-6)}`,
            tieuDe: "K·∫øt qu·∫£ duy·ªát ƒë∆°n tƒÉng ca",
            noiDung: "ƒê∆°n tƒÉng ca c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("ƒê√£ duy·ªát ƒë∆°n tƒÉng ca.", "success");
          await loadHRRequests();
          await updateHRStatusList();
        } catch (e) {
          console.error("hrApproveOT error", e);
        }
      };

      window.hrRejectOT = async function (emailKey, id) {
        try {
          await dbSet(
            dbRef(rtdb, `/DonTu/TangCa/${emailKey}/${id}/trangThai`),
            "T·ª´ ch·ªëi"
          );
          const email = emailKey.replace(/,/g, ".");
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `OT${Date.now().toString().slice(-6)}`,
            tieuDe: "K·∫øt qu·∫£ duy·ªát ƒë∆°n tƒÉng ca",
            noiDung: "ƒê∆°n tƒÉng ca c·ªßa b·∫°n ƒë√£ b·ªã t·ª´ ch·ªëi.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("ƒê√£ t·ª´ ch·ªëi ƒë∆°n tƒÉng ca.", "info");
          await loadHRRequests();
        } catch (e) {
          console.error("hrRejectOT error", e);
        }
      };

      // ---------------------------
      // HR: Update status list (scan RTDB for approved requests)
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      async function updateHRStatusList() {
        try {
          const usersSnap = await getDocs(
            collection(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
            )
          );
          const users = [];
          usersSnap.forEach((d) =>
            users.push({ uid: d.id, ...(d.data() || {}) })
          ); // default status map

          const statusMap = {};
          users.forEach((u) => {
            if ((u.role || "") === "nhanvien")
              statusMap[u.email || `${u.uid}@unknown`] = "B√¨nh th∆∞·ªùng";
          }); // scan leaves

          const leaveSnap = await dbGet(dbRef(rtdb, `/DonTu/Nghi`));
          if (leaveSnap.exists()) {
            const all = leaveSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "ƒê√£ duy·ªát") {
                  const email = emailKey.replace(/,/g, ".");
                  statusMap[email] = "ƒêang ngh·ªâ";
                }
              }
            }
          } // scan OT
          const otSnap = await dbGet(dbRef(rtdb, `/DonTu/TangCa`));
          if (otSnap.exists()) {
            const all = otSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "ƒê√£ duy·ªát") {
                  const email = emailKey.replace(/,/g, "."); // If already Dang nghi, keep it; otherwise set Dang tang ca
                  if (statusMap[email] !== "ƒêang ngh·ªâ")
                    statusMap[email] = "ƒêang tƒÉng ca";
                }
              }
            }
          }

          const rows = [];
          for (const u of users) {
            if ((u.role || "") !== "nhanvien") continue;
            const email = u.email || "";
            const mans = u.mans || "Ch·ªù c·∫≠p nh·∫≠t";
            const hoten = u.hoTen || "Ch·ªù c·∫≠p nh·∫≠t";
            const st = statusMap[email] || "B√¨nh th∆∞·ªùng";
            const statusColor =
              st === "ƒêang ngh·ªâ"
                ? "bg-red-100 text-red-700"
                : st === "ƒêang tƒÉng ca"
                ? "bg-blue-100 text-blue-700"
                : "bg-green-100 text-green-700";
            rows.push(`
¬† ¬† ¬† ¬† <tr>
¬† ¬† ¬† ¬† ¬† ¬† <td class="px-6 py-3">${email}</td>
¬† ¬† ¬† ¬† ¬† ¬† <td class="px-6 py-3">${mans}</td>
¬† ¬† ¬† ¬† ¬† ¬† <td class="px-6 py-3">${hoten}</td>
¬† ¬† ¬† ¬† ¬† ¬† <td class="px-6 py-3"><span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">${st}</span></td>
¬† ¬† ¬† ¬† </tr>
¬† ¬† ¬† `);
          }
          const finalRows = rows.length
            ? rows.join("")
            : `<tr><td colspan="4" class="text-center py-6 text-gray-500">Ch∆∞a c√≥ nh√¢n vi√™n.</td></tr>`; // UI.renderTableRows("hr-status-body", rows.length ? rows : [`<tr><td colspan="4" class="text-center py-6 text-gray-500">Ch∆∞a c√≥ nh√¢n vi√™n.</td></tr>`]);
          $("hr-status-body").innerHTML = finalRows;
        } catch (e) {
          console.error("updateHRStatusList error", e);
        }
      }

      // ---------------------------
      // HR: Generate report
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      window.hrGenerateReport = async function () {
        try {
          const date =
            $("hr-report-date").value || new Date().toISOString().split("T")[0];
          const title = $("hr-report-title").value || `B√°o c√°o nh√¢n s·ª± ${date}`; // gather status counts from updateHRStatusList logic but reuse code // Let's reconstruct counts quickly
          const usersSnap = await getDocs(
            collection(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
            )
          );
          const users = [];
          usersSnap.forEach((d) =>
            users.push({ uid: d.id, ...(d.data() || {}) })
          );
          let totalNV = 0,
            dangNghi = 0,
            dangOT = 0;
          const statusMap = {}; // default set
          users.forEach((u) => {
            if ((u.role || "") === "nhanvien") {
              totalNV++;
              statusMap[u.email || ""] = "B√¨nh th∆∞·ªùng";
            }
          });
          const leaveSnap = await dbGet(dbRef(rtdb, `/DonTu/Nghi`));
          if (leaveSnap.exists()) {
            const all = leaveSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "ƒê√£ duy·ªát") {
                  const email = emailKey.replace(/,/g, ".");
                  statusMap[email] = "ƒêang ngh·ªâ";
                }
              }
            }
          }
          const otSnap = await dbGet(dbRef(rtdb, `/DonTu/TangCa`));
          if (otSnap.exists()) {
            const all = otSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "ƒê√£ duy·ªát") {
                  const email = emailKey.replace(/,/g, "."); // Only count OT if they are not already on leave
                  if (statusMap[email] !== "ƒêang ngh·ªâ")
                    statusMap[email] = "ƒêang tƒÉng ca";
                }
              }
            }
          }
          for (const k in statusMap) {
            if (statusMap[k] === "ƒêang ngh·ªâ") dangNghi++;
            else if (statusMap[k] === "ƒêang tƒÉng ca") dangOT++;
          }

          const reportId = `HRRPT_${Date.now()}`;
          await dbSet(dbRef(rtdb, `/BaoCaoNhanSu/${reportId}`), {
            reportId,
            date,
            title,
            totalNV,
            dangNghi,
            dangOT,
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
            createdAt: new Date().toISOString(),
          }); // send notification to giamdoc

          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `HR${Date.now().toString().slice(-6)}`,
            tieuDe: `B√°o c√°o nh√¢n s·ª±: ${title}`,
            noiDung: `T·ªïng NV: ${totalNV}. ƒêang ngh·ªâ: ${dangNghi}. ƒêang tƒÉng ca: ${dangOT}. Xem chi ti·∫øt trong h·ªá th·ªëng.`,
            ngayGui: date,
            doiTuongNhan: "giamdoc",
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });

          $(
            "hr-report-result"
          ).innerHTML = `<p class="text-base font-medium">B√°o c√°o ƒë√£ g·ª≠i cho Gi√°m ƒë·ªëc.</p><p class="text-sm mt-1">T·ªïng NV: <b>${totalNV}</b>, ƒêang ngh·ªâ: <b>${dangNghi}</b>, ƒêang tƒÉng ca: <b>${dangOT}</b></p>`;
          UI.displayMessage(
            "B√°o c√°o ƒë√£ ƒë∆∞·ª£c t·∫°o v√† g·ª≠i cho Gi√°m ƒë·ªëc.",
            "success"
          );
        } catch (e) {
          console.error("hrGenerateReport error", e);
          UI.displayMessage("L·ªói t·∫°o b√°o c√°o.", "error");
        }
      };

      // ---------------------------
      // INITIALIZE: hook buttons visibility into main UI (optional)
      // ---------------------------
      // (Gi·ªØ nguy√™n)
      (function initHRIntegrationButtons() {
        // try to show profile / register / hr buttons in main UI
        const mainButtonsContainer = $("extra-main-buttons");
        const mainAppView = $("main-app-view");
        if (mainAppView) {
          // insert buttons area if header exists
          const headerArea =
            mainAppView.querySelector(".flex.items-center.gap-3") ||
            mainAppView.querySelector(".flex.items-center") ||
            null;
          if (headerArea && mainButtonsContainer) {
            // show profile & register buttons
            mainButtonsContainer.classList.remove("hidden"); // insert the container into header
            headerArea.insertAdjacentElement("afterend", mainButtonsContainer);
          }
        } // show HR management button if currentUserRole is giamdoc or quanlynhansu
        const observer = () => {
          const hrBtn = $("open-hr-mgmt-btn");
          const profileBtn = $("open-profile-btn");
          const regBtn = $("open-employee-register-btn");
          if (profileBtn) profileBtn.classList.remove("hidden");
          if (regBtn) regBtn.classList.remove("hidden");
          if (hrBtn) {
            if (
              currentUserRole === "giamdoc" ||
              currentUserRole === "quanlynhansu"
            )
              hrBtn.classList.remove("hidden");
            else hrBtn.classList.add("hidden");
          }
        }; // run initially and whenever role changes (we already listenForUserRole triggers currentUserRole)
        observer(); // ensure executed later after auth state changes // no need to rebind; instead rely on listenForUserRole's updates (it adjusts currentUserRole) // call observer periodically a few times to catch updates
        setTimeout(observer, 1000);
        setTimeout(observer, 3000);
      })();
      // xem lg //

      // D·ªØ li·ªáu mock (C·∫ßn thi·∫øt cho qu√° tr√¨nh ph√°t tri·ªÉn/test khi ch∆∞a c√≥ Auth v√† RTDB)
      const mockUserEmail = "p@gmail.com";
      const mockRtdbData = {
        PhieuLuong: {
          // Key n√†y m√¥ ph·ªèng p@gmail.com sau khi m√£ h√≥a
          "p@gmail,com": {
            PL_1761254454798: {
              createdAt: "2025-10-23T21:20:54.798Z",
              hours: 56,
              luong_cung: 1344000,
              phu_cap: 100000,
              thuong: 100000,
              total: 1544000,
            },
          },
          "truongphangiabao@gmail,com": {
            PL_1771254454798: {
              createdAt: "2025-11-20T21:20:54.798Z",
              hours: 170,
              luong_cung: 5000000,
              phu_cap: 500000,
              thuong: 200000,
              total: 5700000,
            },
          },
          // Th√™m m·ªôt phi·∫øu l∆∞∆°ng kh√°c cho t√†i kho·∫£n mock
          // D·ªØ li·ªáu mock kh√¥ng ƒë∆∞·ª£c d√πng key k·∫øt th√∫c b·∫±ng _2, m√† ch·ªâ l√† email key
          // ƒê·ªÉ th·ª≠ nghi·ªám, t√¥i th√™m d·ªØ li·ªáu n√†y v√†o p@gmail,com
          "p@gmail,com": {
            // ƒê√£ c√≥
            PL_1761254454798: {
              createdAt: "2025-10-23T21:20:54.798Z",
              hours: 56,
              luong_cung: 1344000,
              phu_cap: 100000,
              thuong: 100000,
              total: 1544000,
            },
            // Th√™m phi·∫øu th·ª© 2 v√†o c√πng key
            PL_177254454798: {
              createdAt: "2025-11-25T10:00:00.000Z",
              hours: 150,
              luong_cung: 4500000,
              phu_cap: 300000,
              thuong: 150000,
              total: 4950000,
            },
          },
        },
      };

      // H√†m H·ªó tr·ª£: M√¥ ph·ªèng vi·ªác l·∫•y d·ªØ li·ªáu t·ª´ RTDB
      // Thay ƒë·ªïi: S·ª≠ d·ª•ng dbGet ƒë√£ ƒë∆∞·ª£c import n·∫øu c√≥ s·∫µn
      window.dbGetMock = function (ref) {
        // Thay v√¨ ki·ªÉm tra 'get' (t√™n g·ªëc), ta ki·ªÉm tra 'dbGet' (t√™n ƒë√£ ƒë·ªïi)
        // v√† ki·ªÉm tra rtdb. N·∫øu c√≥, n√≥ l√† Realtime Database th·∫≠t.
        if (typeof dbGet === "function" && ref && typeof rtdb !== "undefined") {
          // Tr∆∞·ªùng h·ª£p n√†y kh√¥ng th·ªÉ x·∫£y ra trong m√¥i tr∆∞·ªùng Canvas do dbGet c·∫ßn d√πng await v√† tr·∫£ v·ªÅ Promise
          // nh∆∞ng ƒë·ªÉ logic v·∫´n ch·∫°y ·ªïn, ta gi·∫£ ƒë·ªãnh window.dbGet s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng cho c·∫£ mock v√† real.
          // D√≤ng n√†y ƒë∆∞·ª£c gi·ªØ l·∫°i t·ª´ logic c≈© c·ªßa b·∫°n (c√≥ th·ªÉ ƒë√£ l√† m·ªôt wrapper cho dbGet th·∫≠t)
          return dbGet(ref);
        }

        // N·∫øu kh√¥ng, s·ª≠ d·ª•ng Mock Data
        // ref c√≥ th·ªÉ l√† m·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a path: { path: '/PhieuLuong/emailkey' }
        const path = ref.path;

        // Logic t√¨m ki·∫øm key trong mockRtdbData
        const parts = path.split("/");
        let data = mockRtdbData;

        for (const part of parts) {
          if (part === "") continue;

          if (data[part]) {
            data = data[part];
          } else {
            // N·∫øu kh√¥ng t√¨m th·∫•y key, tr·∫£ v·ªÅ snapshot kh√¥ng t·ªìn t·∫°i
            return { exists: () => false };
          }
        }

        // Tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng gi·ªëng Firebase Snapshot
        return {
          exists: () => data !== null,
          val: () => data,
          path: path,
        };
      };

      // H√†m H·ªó tr·ª£: ƒê·ªãnh nghƒ©a th√™m c√°c h√†m c·∫ßn thi·∫øt trong ƒë·ªëi t∆∞·ª£ng UI
      if (typeof window.UI === "undefined") window.UI = {};

      // H√†m H·ªó tr·ª£ UI: ƒê·ªãnh d·∫°ng ng√†y t·ª´ chu·ªói ISO
      if (typeof window.UI.formatDate !== "function") {
        window.UI.formatDate = function (isoString) {
          try {
            const date = new Date(isoString);
            return date.toLocaleDateString("vi-VN");
          } catch (e) {
            return "N/A";
          }
        };
      }

      // H√†m H·ªó tr·ª£ UI: Render b·∫£ng
      if (typeof window.UI.renderTableRows !== "function") {
        window.UI.renderTableRows = function (tbodyId, rowsArray) {
          const tbody = document.getElementById(tbodyId);
          if (tbody) {
            tbody.innerHTML = rowsArray
              .map((row) => `<tr class="hover:bg-gray-50">${row}</tr>`)
              .join("");
          }
        };
      }

      // H√†m H·ªó tr·ª£ UI: Hi·ªÉn th·ªã/·∫®n view (c·∫ßn thi·∫øt cho open/closeViewSalaryView)
      // Gi·∫£ ƒë·ªãnh h√†m n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng cho UI/Modal
      window.safeShow = function (id) {
        const el = document.getElementById(id);
        if (el) el.classList.remove("hidden");
      };
      window.safeHide = function (id) {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      };
      window.UI.displayMessage = function (message, type = "info") {
        console.log(`[Message: ${type}] ${message}`);
        // Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n s·∫Ω hi·ªÉn th·ªã modal/toast ·ªü ƒë√¢y.
      };

      /**
       * M√£ h√≥a email ƒë·ªÉ l√†m key RTDB (thay th·∫ø T·∫§T C·∫¢ d·∫•u ch·∫•m '.' b·∫±ng d·∫•u ph·∫©y ',')
       */
      window.encodeEmailKey = function (email) {
        // T∆∞∆°ng th√≠ch v·ªõi c·∫•u tr√∫c RTDB c·ªßa b·∫°n (v√≠ d·ª•: p@gmail,com)
        return (email || "").replace(/\./g, ",");
      };

      // M·ªü view xem l∆∞∆°ng c√° nh√¢n
      window.openViewSalaryView = function () {
        safeShow("user-salary-view");
        window.loadUserSalarySlips();
      };

      // ƒê√≥ng view xem l∆∞∆°ng c√° nh√¢n
      window.closeViewSalaryView = function () {
        safeHide("user-salary-view");
      };

      // T·∫£i phi·∫øu l∆∞∆°ng c√° nh√¢n t·ª´ RTDB
      window.loadUserSalarySlips = async function () {
        // 1. L·∫•y th√¥ng tin ng∆∞·ªùi d√πng
        const userEmail =
          auth && auth.currentUser && auth.currentUser.email
            ? auth.currentUser.email
            : mockUserEmail; // Fallback v·ªÅ mock email n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p

        // X√≥a b·∫£ng c≈© v√† hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i
        UI.renderTableRows("user-salary-body", [
          `<td colspan="7" class="text-center py-4 text-blue-500 font-medium animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu phi·∫øu l∆∞∆°ng...</td>`,
        ]);

        if (!userEmail) {
          UI.displayMessage(
            "L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒëƒÉng nh·∫≠p ng∆∞·ªùi d√πng.",
            "error"
          );
          UI.renderTableRows("user-salary-body", [
            `<td colspan="7" class="text-center py-4 text-red-500">L·ªói: Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem phi·∫øu l∆∞∆°ng.</td>`,
          ]);
          return;
        }

        const emailKey = window.encodeEmailKey(userEmail);
        const emailDisplayEl = document.getElementById("user-salary-email");
        if (emailDisplayEl) emailDisplayEl.textContent = userEmail;

        console.log(`[Xem L∆∞∆°ng] Email ƒëƒÉng nh·∫≠p: ${userEmail}`);
        console.log(
          `[Xem L∆∞∆°ng] Key RTDB c·∫ßn truy v·∫•n: /PhieuLuong/${emailKey}`
        );

        try {
          let snap;

          // S·ª¨A L·ªñI: KI·ªÇM TRA dbRef V√Ä dbGet (t√™n ƒë√£ import) thay v√¨ ref/get (t√™n g·ªëc)
          if (
            typeof dbRef === "function" &&
            typeof rtdb !== "undefined" &&
            typeof dbGet === "function"
          ) {
            // 2. Truy v·∫•n RTDB TH·∫¨T: /PhieuLuong/{email_key}
            const dbRefInstance = dbRef(rtdb, `/PhieuLuong/${emailKey}`);
            snap = await dbGet(dbRefInstance);

            if (!snap.exists()) {
              console.warn(
                `[Xem L∆∞∆°ng] Key RTDB /PhieuLuong/${emailKey} kh√¥ng t·ªìn t·∫°i d·ªØ li·ªáu th·∫≠t.`
              );
            }
          } else {
            // 2. Truy v·∫•n MOCK DATA
            console.warn(
              "üö® H√†m 'dbRef', 'dbGet' ho·∫∑c ƒë·ªëi t∆∞·ª£ng 'rtdb' ch∆∞a s·∫µn s√†ng. S·ª≠ d·ª•ng d·ªØ li·ªáu mock."
            );
            // S·ª≠ d·ª•ng h√†m mock data helper
            snap = window.dbGetMock({ path: `/PhieuLuong/${emailKey}` });

            if (snap.exists()) {
              UI.displayMessage(
                "ƒêang d√πng d·ªØ li·ªáu th·ª≠ nghi·ªám (mock data). Vui l√≤ng ƒë·∫£m b·∫£o `rtdb` v√† `dbRef` ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh n·∫øu mu·ªën d√πng d·ªØ li·ªáu th·∫≠t.",
                "warning"
              );
            }
          }

          // 3. X·ª≠ l√Ω k·∫øt qu·∫£
          const slips = [];
          if (snap && snap.exists && snap.exists()) {
            const allSlips = snap.val();
            for (const slipId in allSlips) {
              // Ki·ªÉm tra v√† ƒë·∫©y d·ªØ li·ªáu v√†o m·∫£ng
              if (allSlips[slipId] && typeof allSlips[slipId] === "object") {
                slips.push({ slipId: String(slipId), ...allSlips[slipId] });
              } else {
                console.warn(
                  `[Xem L∆∞∆°ng] B·ªè qua d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá cho slipId: ${slipId}`
                );
              }
            }
          }

          // S·∫Øp x·∫øp theo ID phi·∫øu (gi·∫£ ƒë·ªãnh PL_timestamp) ƒë·ªÉ phi·∫øu m·ªõi nh·∫•t l√™n ƒë·∫ßu
          slips.sort((a, b) => b.slipId.localeCompare(a.slipId));
          window.renderUserSalarySlips(slips);
        } catch (e) {
          console.error("loadUserSalarySlips error:", e);
          UI.displayMessage(`L·ªói t·∫£i phi·∫øu l∆∞∆°ng: ${e.message}`, "error");
          UI.renderTableRows("user-salary-body", [
            `<td colspan="7" class="text-center py-4 text-red-500">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</td>`,
          ]);
        }
      };

      // Hi·ªÉn th·ªã phi·∫øu l∆∞∆°ng c√° nh√¢n ra b·∫£ng
      window.renderUserSalarySlips = function (slips) {
        if (slips.length === 0) {
          UI.renderTableRows("user-salary-body", [
            `<td colspan="7" class="text-center py-4 text-gray-500">B·∫°n ch∆∞a c√≥ phi·∫øu l∆∞∆°ng n√†o ƒë∆∞·ª£c xu·∫•t.</td>`,
          ]);
          return;
        }

        // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá VNƒê
        const formatVND = (amount) =>
          (amount || 0).toLocaleString("vi-VN") + " ƒë";

        const rows = slips.map((slip) => {
          // ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë·ªÅu l√† s·ªë ho·∫∑c 0
          const total = parseFloat(slip.total) || 0;
          const luongCung = parseFloat(slip.luong_cung) || 0;
          const phuCap = parseFloat(slip.phu_cap) || 0;
          const thuong = parseFloat(slip.thuong) || 0;
          const hours = parseFloat(slip.hours) || 0;
          const createdAt = slip.createdAt
            ? UI.formatDate(slip.createdAt)
            : "N/A";

          return `
        <td class="px-4 py-2 text-sm text-gray-900 font-medium">${String(
          slip.slipId
        ).replace("PL_", "#")}</td>
        <td class="px-4 py-2 text-sm text-gray-600">${createdAt}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${hours}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${formatVND(
          luongCung
        )}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${formatVND(
          phuCap
        )}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${formatVND(
          thuong
        )}</td>
        <td class="px-4 py-2 text-sm text-green-700 font-bold text-right">${formatVND(
          total
        )}</td>
    `;
        });

        UI.renderTableRows("user-salary-body", rows);
      };
    </script>
  </body>
</html>
