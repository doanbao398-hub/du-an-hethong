<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng Ký, Phân Quyền, Điều Động & Thông Báo Nội Bộ (Nâng cấp)</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .scrollable-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
      /* subtle modal animation fallback */
      .fade-scale-enter {
        transform: scale(0.98);
        opacity: 0;
      }
      .fade-scale-enter-active {
        transform: scale(1);
        opacity: 1;
        transition: all 180ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .fade-scale-leave {
        transform: scale(1);
        opacity: 1;
      }
      .fade-scale-leave-active {
        transform: scale(0.98);
        opacity: 0;
        transition: all 120ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
    </style>
  </head>

  <body class="min-h-screen flex items-center justify-center p-4">
    <!-- Container Chính -->
    <div
      id="main-container"
      class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-8 transition-all duration-300"
    >
      <!-- Khu vực Thông báo Lỗi/Thành công -->
      <div
        id="message-box"
        class="hidden p-3 mb-4 rounded-lg text-sm font-medium"
        role="alert"
      ></div>

      <!-- 1. Giao diện Xác thực (Đăng nhập) -->
      <div id="auth-view" class="w-full max-w-md mx-auto">
        <h1
          id="auth-title"
          class="text-3xl font-bold text-center text-gray-800 mb-6"
        >
          Đăng Nhập Hệ Thống
        </h1>

        <form id="auth-form" onsubmit="handleAuth(event)">
          <div class="mb-4">
            <label
              for="email"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Email</label
            >
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
              placeholder="your.email@gmail.com"
            />
          </div>
          <div class="mb-6">
            <label
              for="password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Mật khẩu</label
            >
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="6"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
              placeholder="Mật khẩu (ít nhất 6 ký tự)"
            />
          </div>

          <button
            type="submit"
            id="auth-button"
            class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150"
          >
            Đăng Nhập
          </button>
        </form>
      </div>

      <!-- 2. Giao diện Chính (Sau khi đăng nhập) -->
      <div id="main-app-view" class="hidden">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
          <h1 class="text-2xl font-bold text-gray-800">
            Xin Chào, <span id="user-email" class="text-indigo-600"></span>!
          </h1>
          <div class="flex items-center gap-3">
            <button
              onclick="logoutUser()"
              class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 text-sm"
            >
              Đăng Xuất
            </button>
            <!-- Nút Kế toán (hiển thị cho giamdoc + ketoan) -->
            <button
              id="open-accounting-btn"
              onclick="openAccountingView()"
              class="hidden py-2 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-150 text-sm"
            >
              Kế toán
            </button>
          </div>
        </div>

        <p class="text-sm text-gray-500 mb-6">
          UID:
          <span
            id="user-uid"
            class="font-mono text-xs bg-gray-100 p-1 rounded"
          ></span>
        </p>

        <!-- KHU VỰC THÔNG TIN VAI TRÒ CÁ NHÂN -->
        <div id="user-role-info" class="bg-indigo-50 p-4 rounded-lg mb-6">
          <p class="text-lg font-semibold text-indigo-700">Vai trò hiện tại:</p>
          <p
            id="current-role"
            class="text-xl font-extrabold text-indigo-900 mt-1"
          >
            Đang tải...
          </p>
          <p id="current-department" class="text-sm text-indigo-700 mt-1">
            Phòng ban:
            <span class="font-bold text-indigo-900">Đang tải...</span>
          </p>
        </div>

        <div class="mb-6 mt-6">
          <button
            onclick="openViewNotificationsView()"
            class="py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 w-full"
          >
            Xem Thông Báo Công Ty
          </button>
        </div>
        <button
          id="open-management-btn"
          onclick="openSystemManagementView()"
          class="hidden py-3 px-6 bg-purple-600 text-white font-semibold rounded-lg shadow-xl hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 mt-6 w-full"
        >
          Chức năng Quản lý Hệ thống
        </button>
      </div>
    </div>

    <!-- 3. GIAO DIỆN QUẢN LÝ HỆ THỐNG -->
    <div
      id="system-management-view"
      class="fixed inset-0 bg-gray-50/95 hidden flex-col p-4 z-40 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-6">
          <h2 class="text-2xl font-bold text-gray-800">
            Giao diện Quản Lý Hệ Thống
          </h2>
          <button
            onclick="closeSystemManagementView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-600 mb-8">
          Vui lòng chọn chức năng quản lý bạn muốn thực hiện.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <button
            onclick="openUserManagementView()"
            class="flex flex-col items-center justify-center p-6 bg-indigo-600 text-white font-semibold rounded-xl shadow-xl hover:bg-indigo-700 transition duration-150 h-36"
          >
            <!-- icon -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-8 h-8 mb-2"
            >
              <path
                fill-rule="evenodd"
                d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="text-lg">Quản Lý Tài Khoản Người Dùng</span>
          </button>

          <button
            onclick="openPersonnelDeploymentView()"
            class="flex flex-col items-center justify-center p-6 bg-yellow-600 text-white font-semibold rounded-xl shadow-xl hover:bg-yellow-700 transition duration-150 h-36"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-8 h-8 mb-2"
            >
              <path
                fill-rule="evenodd"
                d="M3 3a1.5 1.5 0 0 0-1.5 1.5v13.5a1.5 1.5 0 0 0 1.5 1.5H18a1.5 1.5 0 0 0 1.5-1.5V10.5a1.5 1.5 0 0 0-1.5-1.5H3.75a.75.75 0 0 1 0-1.5H21a.75.75 0 0 0 0-1.5H3a.75.75 0 0 1 0-1.5ZM12.375 16.5a.75.75 0 0 0 .53-1.28L10.5 13.5l2.405-2.72a.75.75 0 1 0-1.11-1.04l-3 3.375a.75.75 0 0 0 0 1.04l3 3.375a.75.75 0 0 0 .58.28Z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="text-lg">Điều Động Nhân sự</span>
          </button>

          <button
            onclick="openNotificationManagementView()"
            class="flex flex-col items-center justify-center p-6 bg-green-600 text-white font-semibold rounded-xl shadow-xl hover:bg-green-700 transition duration-150 h-36"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-8 h8 mb-2"
            >
              <path
                d="M5.566 1.657A41.01 41.01 0 0 0 12 2c2.204 0 4.343.155 6.434.407l-.468-.934a1.2 1.2 0 0 0-1.07-1.11L12 1.011 7.102 1.657a1.2 1.2 0 0 0-1.07 1.11l-.466.931ZM12 4c2.613 0 4.945.727 6.434 1.407L12 23l-6.434-17c1.488-.68 3.821-1.407 6.434-1.407ZM14.062 18.5a.75.75 0 0 0-.847-.075L12 17.587l-1.215.838a.75.75 0 0 0 .141 1.231c.42.155.845.289 1.274.405l.07.02v.005a1.5 1.5 0 0 0 2.25 0 1.498 1.498 0 0 0 .341-1.554l-.499-1.004Z"
              />
            </svg>
            <span class="text-lg">Quản Lý Thông Báo</span>
          </button>
        </div>

        <div class="flex justify-end pt-4 mt-8 border-t">
          <button
            onclick="closeSystemManagementView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay lại Màn hình chính
          </button>
        </div>
      </div>
    </div>

    <!-- 4. GIAO DIỆN QUẢN LÝ TÀI KHOẢN NGƯỜI DÙNG -->
    <div
      id="user-management-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        id="user-management-content"
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">
            Quản Lý Tài Khoản Người Dùng
          </h2>
          <button
            onclick="closeUserManagementView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">
            1. Tạo Tài Khoản Mới
          </h3>
          <form onsubmit="createNewUserByDirector(event)">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <input
                type="email"
                id="new-email"
                required
                placeholder="Email"
                class="p-2 border rounded-lg"
              />
              <input
                type="password"
                id="new-password"
                required
                minlength="6"
                placeholder="Mật khẩu (>= 6 ký tự)"
                class="p-2 border rounded-lg"
              />
              <select
                id="new-role"
                required
                class="p-2 border rounded-lg bg-white"
              >
                <option value="" disabled selected>Chọn vai trò</option>
                <option value="nhanvien">Nhân viên</option>
                <option value="quanlynhansu">Quản lý nhân sự</option>
                <option value="ketoan">Kế toán</option>
                <option value="quanlyhethong">Quản lý hệ thống</option>
                <option value="giamdoc">Giám đốc</option>
              </select>
            </div>
            <button
              type="submit"
              class="w-full mt-3 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150"
            >
              Tạo Tài Khoản
            </button>
          </form>
        </div>

        <h3 class="text-xl font-semibold text-gray-700 mb-3">
          2. Danh Sách Tài Khoản
        </h3>
        <div id="user-list-container" class="scrollable-list p-2 bg-white">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Email
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Vai trò
                </th>
                <th
                  class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Trạng thái
                </th>
                <th
                  class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Thao tác
                </th>
              </tr>
            </thead>
            <tbody
              id="user-list-body"
              class="bg-white divide-y divide-gray-200 text-sm"
            >
              <tr>
                <td colspan="4" class="text-center py-4 text-gray-500">
                  Đang tải danh sách người dùng...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closeUserManagementView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay lại Giao diện Quản lý Hệ thống
          </button>
        </div>
      </div>
    </div>

    <!-- sua  -->
    <div
      id="profile-modal"
      class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm hidden items-center justify-center p-4 z-60"
    >
      <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-sm lg:max-w-md p-6 relative transform transition-all"
        style="background: linear-gradient(135deg, #fff0f5 0%, #ffffff 100%)"
      >
        <button
          onclick="closeProfileModal()"
          class="absolute top-4 right-4 text-3xl text-gray-400 hover:text-gray-600 transition-colors"
        >
          &times;
        </button>
        <div id="profile-content" class="flex flex-col items-center gap-6">
          <div class="relative">
            <img
              id="profile-avatar"
              class="w-32 h-32 rounded-full object-cover ring-4 ring-pink-300 shadow-lg hidden"
              src=""
              alt="Avatar"
            />
            <div
              id="profile-status-badge"
              class="absolute bottom-0 right-0 w-5 h-5 bg-green-500 rounded-full border-2 border-white"
            ></div>
          </div>

          <h3 class="text-2xl font-extrabold text-pink-700" id="profile-name">
            Họ Tên: Chờ cập nhật
          </h3>

          <div class="w-full text-sm space-y-3">
            <div class="grid grid-cols-2 gap-x-4 gap-y-3">
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>Mã NS</b>
                <div id="profile-mans" class="font-medium text-gray-800">
                  Chờ cập nhật
                </div>
              </div>
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>Chức vụ</b>
                <div id="profile-role" class="font-medium text-gray-800">
                  Chờ cập nhật
                </div>
              </div>
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>Phòng ban</b>
                <div id="profile-dept" class="font-medium text-gray-800">
                  Chờ cập nhật
                </div>
              </div>
              <div class="p-3 bg-pink-50 rounded-lg">
                <b>Dự án</b>
                <div id="profile-project" class="font-medium text-gray-800">
                  Chờ cập nhật
                </div>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-3 pt-2 border-t border-pink-100">
              <div class="text-xs">
                <b>Ngày sinh</b>
                <div id="profile-dob" class="text-gray-600 mt-1">
                  Chờ cập nhật
                </div>
              </div>
              <div class="text-xs">
                <b>Giới tính</b>
                <div id="profile-gender" class="text-gray-600 mt-1">
                  Chờ cập nhật
                </div>
              </div>
              <div class="text-xs">
                <b>Ngày vào làm</b>
                <div id="profile-join" class="text-gray-600 mt-1">
                  Chờ cập nhật
                </div>
              </div>
            </div>
          </div>

          <div class="w-full text-right pt-4 border-t border-pink-100">
            <div
              class="inline-flex items-center text-sm font-semibold text-pink-600 bg-pink-100 px-3 py-1 rounded-full mr-4"
            >
              Quyền: <span id="profile-perm" class="ml-1">Chờ cập nhật</span>
            </div>
            <button
              onclick="closeProfileModal()"
              class="py-2 px-5 bg-pink-600 text-white rounded-xl shadow-md hover:bg-pink-700 transition-colors"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="hr-management-view"
      class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex-col p-4 z-60 overflow-y-auto"
    >
      <div
        class="w-full max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl p-8 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-start border-b pb-4 mb-6">
          <div>
            <h2 class="text-3xl font-extrabold text-gray-800">
              Quản lý Nhân sự
            </h2>
            <p class="text-gray-500 mt-1">
              Phân hệ quản lý thông tin, duyệt đơn và theo dõi trạng thái nhân
              viên.
            </p>
          </div>
          <button
            onclick="closeHRManagementView()"
            class="text-gray-400 hover:text-gray-600 text-4xl font-light leading-none transition-colors"
          >
            &times;
          </button>
        </div>

        <div class="mb-6 flex gap-3 border-b border-gray-200">
          <button
            id="hr-tab-update"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-indigo-600 text-white"
            onclick="showHRTab('update')"
          >
            👥 Cập nhật thông tin
          </button>
          <button
            id="hr-tab-requests"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            onclick="showHRTab('requests')"
          >
            📝 Duyệt đơn
          </button>
          <button
            id="hr-tab-status"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            onclick="showHRTab('status')"
          >
            🚦 Theo dõi trạng thái
          </button>
          <button
            id="hr-tab-report"
            class="py-3 px-6 text-sm font-semibold rounded-t-lg transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            onclick="showHRTab('report')"
          >
            📈 Xuất báo cáo
          </button>
        </div>

        <div id="hr-tab-update-panel">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Danh sách tài khoản (Cập nhật)
          </h3>
          <div class="scrollable-list rounded-lg border overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Email
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Mã NS
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Họ tên
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Phòng ban
                  </th>
                  <th
                    class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Thao tác
                  </th>
                </tr>
              </thead>
              <tbody
                id="hr-user-list-body"
                class="bg-white divide-y divide-gray-100 text-sm"
              >
                <tr>
                  <td colspan="5" class="text-center py-8 text-gray-400">
                    Đang tải dữ liệu nhân sự...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="hr-tab-requests-panel" class="hidden">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Duyệt Đơn Xin nghỉ & Tăng ca (Chờ duyệt)
          </h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="border rounded-xl p-4 bg-red-50">
              <h4 class="font-bold text-lg mb-3 text-red-700 border-b pb-2">
                Đơn xin nghỉ
              </h4>
              <div
                id="hr-leave-list"
                class="space-y-3 max-h-96 overflow-y-auto text-sm"
              >
                <p class="text-center py-10 text-gray-500">
                  Chưa có đơn xin nghỉ đang chờ duyệt.
                </p>
              </div>
            </div>
            <div class="border rounded-xl p-4 bg-blue-50">
              <h4 class="font-bold text-lg mb-3 text-blue-700 border-b pb-2">
                Đơn tăng ca
              </h4>
              <div
                id="hr-ot-list"
                class="space-y-3 max-h-96 overflow-y-auto text-sm"
              >
                <p class="text-center py-10 text-gray-500">
                  Chưa có đơn tăng ca đang chờ duyệt.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div id="hr-tab-status-panel" class="hidden">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Theo dõi tình trạng nhân viên hiện tại
          </h3>
          <div class="scrollable-list rounded-lg border overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Email
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Mã NS
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Họ tên
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Trạng thái
                  </th>
                </tr>
              </thead>
              <tbody
                id="hr-status-body"
                class="bg-white divide-y divide-gray-100 text-sm"
              >
                <tr>
                  <td colspan="4" class="text-center py-8 text-gray-400">
                    Đang tải trạng thái...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="hr-tab-report-panel" class="hidden">
          <h3 class="text-xl font-bold mb-4 text-gray-700">
            Xuất báo cáo nhân sự tổng hợp
          </h3>
          <div class="p-6 bg-gray-50 border rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
              <div class="space-y-1">
                <label
                  for="hr-report-date"
                  class="block text-sm font-medium text-gray-700"
                  >Ngày báo cáo</label
                >
                <input
                  type="date"
                  id="hr-report-date"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div class="space-y-1 md:col-span-2">
                <label
                  for="hr-report-title"
                  class="block text-sm font-medium text-gray-700"
                  >Tiêu đề / Nội dung ngắn</label
                >
                <input
                  type="text"
                  id="hr-report-title"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Báo cáo tổng hợp tháng..."
                />
              </div>
            </div>
            <button
              id="hr-generate-report-btn"
              class="py-2 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
              onclick="hrGenerateReport()"
            >
              <i class="fas fa-file-export"></i> Xuất báo cáo & Gửi cho Giám đốc
            </button>
          </div>

          <div
            id="hr-report-result"
            class="mt-6 p-4 bg-white rounded-xl shadow-lg border border-gray-200"
          >
            <p class="text-base text-gray-500 font-medium">
              Kết quả báo cáo sẽ hiển thị ở đây sau khi tạo.
            </p>
          </div>
        </div>

        <div class="flex justify-end pt-6 mt-8 border-t border-gray-200">
          <button
            onclick="closeHRManagementView()"
            class="py-2 px-5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
          >
            Quay lại
          </button>
        </div>
      </div>
    </div>

    <div
      id="employee-register-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-60"
    >
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">
        <button
          onclick="closeEmployeeRegisterModal()"
          class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-gray-600 transition-colors"
        >
          &times;
        </button>
        <h3 class="text-2xl font-bold mb-5 text-indigo-700">
          Đăng ký Đơn từ (Nhân viên)
        </h3>

        <div class="flex gap-3 mb-6 border-b pb-3">
          <button
            onclick="showEmployeeRegisterForm('leave')"
            class="py-2 px-5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
          >
            Đăng ký xin nghỉ
          </button>
          <button
            onclick="showEmployeeRegisterForm('ot')"
            class="py-2 px-5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
          >
            Đăng ký tăng ca
          </button>
        </div>

        <form
          id="employee-leave-form"
          class="space-y-4"
          onsubmit="submitLeaveRequest(event)"
        >
          <p class="text-sm text-gray-500 border-b pb-2">
            Vui lòng điền thông tin xin nghỉ chi tiết.
          </p>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="leave-mans"
              placeholder="Mã NS"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
            <input
              id="leave-name"
              placeholder="Họ tên"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="leave-start"
              type="date"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
            <input
              id="leave-end"
              type="date"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <textarea
            id="leave-reason"
            placeholder="Lý do xin nghỉ (Tối đa 250 ký tự)"
            class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none"
            maxlength="250"
            required
          ></textarea>

          <div class="text-right pt-2">
            <button
              class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg shadow-lg hover:bg-red-700 transition-colors"
            >
              Gửi đơn xin nghỉ
            </button>
          </div>
        </form>

        <form
          id="employee-ot-form"
          class="hidden space-y-4"
          onsubmit="submitOTRequest(event)"
        >
          <p class="text-sm text-gray-500 border-b pb-2">
            Vui lòng điền thông tin tăng ca chi tiết.
          </p>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="ot-name"
              placeholder="Họ tên"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
            <input
              id="ot-mans"
              placeholder="Mã NS"
              class="p-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <input
              id="ot-date"
              type="date"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
            <input
              id="ot-hours"
              type="number"
              min="1"
              max="12"
              placeholder="Số giờ tăng ca"
              class="p-3 border border-gray-300 rounded-lg"
              required
            />
          </div>

          <div class="text-right pt-2">
            <button
              class="py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
            >
              Gửi đăng ký tăng ca
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="hr-edit-profile-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-70"
    >
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
        <button
          onclick="closeHREditProfileModal()"
          class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-gray-600 transition-colors"
        >
          &times;
        </button>
        <h3 class="text-xl font-bold mb-5 text-emerald-700 border-b pb-2">
          Cập nhật thông tin nhân sự
        </h3>

        <div class="grid grid-cols-1 gap-4">
          <input id="edit-uid" type="hidden" />

          <div class="grid grid-cols-2 gap-4">
            <input
              id="edit-mans"
              placeholder="Mã NS"
              class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
            />
            <input
              id="edit-name"
              placeholder="Họ tên"
              class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
            />
          </div>

          <select
            id="edit-role"
            class="p-3 border border-gray-300 rounded-lg bg-white focus:border-emerald-500 focus:ring-emerald-500"
          >
            <option value="nhanvien">Nhân viên</option>
            <option value="quanlynhansu">Quản lý nhân sự</option>
            <option value="ketoan">Kế toán</option>
            <option value="quanlyhethong">Quản lý hệ thống</option>
            <option value="giamdoc">Giám đốc</option>
          </select>

          <input
            id="edit-dept"
            placeholder="Phòng ban"
            class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
          />
          <input
            id="edit-project"
            placeholder="Dự án"
            class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
          />

          <div class="grid grid-cols-2 gap-4">
            <input
              id="edit-dob"
              type="date"
              class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
            />
            <select
              id="edit-gender"
              class="p-3 border border-gray-300 rounded-lg bg-white focus:border-emerald-500 focus:ring-emerald-500"
            >
              <option value="">Chọn giới tính</option>
              <option value="Nam">Nam</option>
              <option value="Nữ">Nữ</option>
            </select>
          </div>

          <input
            id="edit-join"
            type="date"
            placeholder="Ngày vào làm"
            class="p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500"
          />

          <div class="text-right pt-4 border-t mt-2">
            <button
              onclick="saveHREditedProfile()"
              class="py-2 px-6 bg-emerald-600 text-white font-semibold rounded-lg shadow-lg hover:bg-emerald-700 transition-colors"
            >
              Cập nhật hồ sơ
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="extra-main-buttons"
      class="hidden flex gap-3 p-4 bg-white border-b shadow-sm"
    >
      <button
        id="open-profile-btn"
        onclick="openProfileModal()"
        class="py-2 px-4 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors"
      >
        Xem thông tin cá nhân
      </button>

      <button
        id="open-employee-register-btn"
        onclick="openEmployeeRegisterModal()"
        class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors"
      >
        Đăng ký (Nhân viên)
      </button>
      <button
        id="btn-view-salary"
        onclick="openViewSalaryView()"
        class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors"
      >
        Xem Phiếu Lương
      </button>
      <button
        id="open-hr-mgmt-btn"
        onclick="openHRManagementView()"
        class="py-2 px-4 bg-rose-600 text-white font-semibold rounded-lg hidden hover:bg-rose-700 transition-colors"
      >
        Quản lý nhân sự
      </button>
    </div>
    <!-- 5. GIAO DIỆN QUẢN LÝ THÔNG BÁO -->
    <div
      id="notification-management-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Quản Lý Thông Báo</h2>
          <button
            onclick="closeNotificationManagementView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <div class="mb-8 p-4 bg-green-50 rounded-lg shadow-inner">
          <h3 class="text-xl font-semibold text-green-700 mb-3">
            1. Tạo Thông Báo Mới
          </h3>
          <form onsubmit="createNotification(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label
                  for="notif-matb"
                  class="block text-sm font-medium text-gray-700"
                  >Mã Thông Báo (MATB)</label
                >
                <input
                  type="text"
                  id="notif-matb"
                  required
                  placeholder="Ví dụ: TB001"
                  class="w-full p-2 border rounded-lg mt-1"
                />
              </div>
              <div>
                <label
                  for="notif-tieu-de"
                  class="block text-sm font-medium text-gray-700"
                  >Tiêu Đề</label
                >
                <input
                  type="text"
                  id="notif-tieu-de"
                  required
                  placeholder="Tiêu đề thông báo"
                  class="w-full p-2 border rounded-lg mt-1"
                />
              </div>
            </div>

            <div class="mb-4">
              <label
                for="notif-noi-dung"
                class="block text-sm font-medium text-gray-700"
                >Nội Dung</label
              >
              <textarea
                id="notif-noi-dung"
                required
                rows="3"
                placeholder="Nội dung chi tiết của thông báo..."
                class="w-full p-2 border rounded-lg mt-1"
              ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label
                  for="notif-ngay-gui"
                  class="block text-sm font-medium text-gray-700"
                  >Ngày Gửi</label
                >
                <input
                  type="date"
                  id="notif-ngay-gui"
                  required
                  class="w-full p-2 border rounded-lg mt-1 bg-white"
                />
              </div>
              <div>
                <label
                  for="notif-doi-tuong"
                  class="block text-sm font-medium text-gray-700"
                  >Đối Tượng Nhận</label
                >
                <select
                  id="notif-doi-tuong"
                  required
                  class="w-full p-2 border rounded-lg mt-1 bg-white"
                >
                  <option value="" disabled selected>Chọn đối tượng</option>
                  <option value="toancongty">Toàn bộ công ty</option>
                  <option value="quanlynhansu">Quản lý nhân sự</option>
                  <option value="ketoan">Kế toán</option>
                </select>
              </div>
              <div>
                <label
                  for="notif-loai"
                  class="block text-sm font-medium text-gray-700"
                  >Loại Thông Báo</label
                >
                <select
                  id="notif-loai"
                  required
                  class="w-full p-2 border rounded-lg mt-1 bg-white"
                >
                  <option value="thuongky">Thường kỳ</option>
                  <option value="khancap">Khẩn cấp</option>
                </select>
              </div>
            </div>

            <button
              type="submit"
              class="w-full mt-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150"
            >
              Tạo Thông Báo
            </button>
          </form>
        </div>

        <div class="mb-6">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">
            2. Lịch Sử Thông Báo Đã Tạo
          </h3>
          <div
            id="notif-history-container"
            class="scrollable-list p-2 bg-white"
          >
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12"
                  >
                    Mã
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-4/12"
                  >
                    Tiêu Đề
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12"
                  >
                    Ngày Gửi
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12"
                  >
                    Đối Tượng
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12"
                  >
                    Loại
                  </th>
                </tr>
              </thead>
              <tbody
                id="notif-history-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              >
                <tr>
                  <td colspan="5" class="text-center py-4 text-gray-500">
                    Đang tải lịch sử thông báo...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closeNotificationManagementView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay lại Giao diện Quản lý Hệ thống
          </button>
        </div>
      </div>
    </div>

    <!-- 6. GIAO DIỆN XEM THÔNG BÁO (All Users) -->
    <div
      id="view-notifications-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Thông Báo Công Ty</h2>
          <button
            onclick="closeViewNotificationsView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <p
          id="notif-role-filter-info"
          class="text-sm text-indigo-600 mb-4 font-semibold"
        ></p>

        <div id="user-notifications-list" class="space-y-4">
          <p class="text-center py-8 text-gray-500">Đang tải thông báo...</p>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closeViewNotificationsView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Đóng
          </button>
        </div>
      </div>
    </div>
    <!-- 7. GIAO DIỆN ĐIỀU ĐỘNG NHÂN SỰ (Director Only) -->
    <div
      id="personnel-deployment-view"
      class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-10 mb-10"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">
            Điều Động Nhân Sự Công Ty
          </h2>
          <button
            onclick="closePersonnelDeploymentView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-600 mb-6">
          Chức năng này dùng để cập nhật phòng ban công tác và gửi thông báo
          điều động cho nhân sự.
        </p>

        <h3 class="text-xl font-semibold text-gray-700 mb-3">
          Danh Sách Nhân Sự
        </h3>
        <div id="personnel-list-container" class="scrollable-list p-2 bg-white">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3"
                >
                  Email
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6"
                >
                  Vai trò
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3"
                >
                  Phòng ban hiện tại
                </th>
                <th
                  class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6"
                >
                  Thao tác
                </th>
              </tr>
            </thead>
            <tbody
              id="personnel-list-body"
              class="bg-white divide-y divide-gray-200 text-sm"
            >
              <tr>
                <td colspan="4" class="text-center py-4 text-gray-500">
                  Đang tải danh sách nhân sự...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-end pt-4 mt-6 border-t">
          <button
            onclick="closePersonnelDeploymentView()"
            class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150"
          >
            Quay lại Giao diện Quản lý Hệ thống
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Vai trò -->
    <div
      id="role-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
        <h3 class="text-lg font-bold mb-4" id="modal-title"></h3>
        <p id="modal-user-info" class="mb-4 text-sm text-gray-600"></p>

        <div id="modal-role-select-container">
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Chọn Vai trò mới</label
          >
          <select
            id="modal-role-select"
            class="w-full p-2 border rounded-lg mb-4 bg-white"
          ></select>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="closeModal()"
            class="py-2 px-4 border rounded-lg text-gray-700 hover:bg-gray-100 transition"
          >
            Hủy
          </button>
          <button
            id="modal-confirm-btn"
            class="py-2 px-4 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition"
          >
            Xác Nhận
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Điều động -->
    <div
      id="deployment-modal"
      class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
        <h3 class="text-lg font-bold mb-4 text-indigo-700">
          Điều Động Nhân Sự
        </h3>
        <p
          id="deployment-user-info"
          class="mb-4 text-sm text-gray-700 font-medium"
        ></p>

        <div id="modal-dept-select-container">
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Chọn Phòng Ban mới</label
          >
          <select
            id="modal-dept-select"
            class="w-full p-2 border rounded-lg mb-4 bg-white"
          ></select>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="closeDeploymentModal()"
            class="py-2 px-4 border rounded-lg text-gray-700 hover:bg-gray-100 transition"
          >
            Hủy
          </button>
          <button
            id="deployment-confirm-btn"
            class="py-2 px-4 rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 transition"
          >
            Cập Nhật & Thông Báo
          </button>
        </div>
      </div>
    </div>
    <!-- baodzaik. GIAO DIỆN KẾ TOÁN (Mới thêm) -->
    <!-- NÚT XEM PHIẾU LƯƠNG CÁ NHÂN (Dán vào bên trong div id="main-buttons-container") -->
    <div
      id="user-salary-view"
      class="fixed inset-0 z-50 overflow-y-auto hidden"
      style="background-color: rgba(0, 0, 0, 0.6)"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <!-- Card nội dung -->
        <div
          class="bg-white rounded-xl shadow-2xl w-full max-w-5xl transform transition-all duration-300"
        >
          <!-- Header Modal -->
          <div
            class="p-6 border-b border-gray-200 flex justify-between items-center"
          >
            <h3 class="text-2xl font-bold text-gray-800">
              Lịch Sử Phiếu Lương Cá Nhân
            </h3>
            <button
              onclick="closeViewSalaryView()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Body Modal (Thông tin & Bảng) -->
          <div class="p-6">
            <div class="mb-4 text-sm text-gray-600">
              <span class="font-semibold text-gray-800">Người dùng:</span>
              <span id="user-salary-email" class="text-indigo-600 font-medium"
                >Đang tải...</span
              >
            </div>

            <!-- Bảng hiển thị phiếu lương -->
            <div
              class="overflow-x-auto rounded-lg shadow-md border border-gray-100"
            >
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Mã Phiếu
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Ngày Xuất
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Giờ Công
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Lương Cứng
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Phụ Cấp
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Thưởng
                    </th>
                    <th
                      class="px-4 py-3 text-right text-xs font-bold text-green-700 uppercase tracking-wider"
                    >
                      Tổng Thu Nhập
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="user-salary-body"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Dữ liệu phiếu lương sẽ được chèn vào đây -->
                  <tr>
                    <td colspan="7" class="text-center py-6 text-gray-400">
                      Đang tải dữ liệu...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Footer Modal -->
          <div class="p-4 border-t border-gray-200 flex justify-end">
            <button
              onclick="closeViewSalaryView()"
              class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg shadow hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- baodzaik. GIAO DIỆN KẾ TOÁN (Mới thêm) -->
    <div
      id="accounting-view"
      class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex-col p-4 z-50 overflow-y-auto"
    >
      <div
        class="w-full max-w-5xl mx-auto bg-white shadow-2xl rounded-xl p-6 relative mt-8 mb-8"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Giao diện Kế Toán</h2>
          <button
            onclick="closeAccountingView()"
            class="text-gray-500 hover:text-gray-700 text-3xl font-light"
          >
            &times;
          </button>
        </div>

        <div class="mb-6">
          <div class="flex gap-2">
            <button
              id="tab-attendance"
              class="py-2 px-4 bg-indigo-600 text-white rounded"
              onclick="showAccountingTab('attendance')"
            >
              Chấm công
            </button>
            <button
              id="tab-payroll"
              class="py-2 px-4 bg-gray-200 rounded"
              onclick="showAccountingTab('payroll')"
            >
              Tính lương
            </button>
            <button
              id="tab-report"
              class="py-2 px-4 bg-gray-200 rounded"
              onclick="showAccountingTab('report')"
            >
              Báo cáo kế toán
            </button>
          </div>
        </div>

        <div id="acct-attendance" class="">
          <h3 class="text-lg font-semibold mb-3">
            Danh sách tài khoản (Chấm công)
          </h3>
          <div id="acct-attendance-list" class="scrollable-list p-2 bg-white">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Email
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Vai trò
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Phòng ban
                  </th>
                  <th class="px-3 py-2 text-center text-xs text-gray-500">
                    Tổng giờ
                  </th>
                  <th class="px-3 py-2 text-center text-xs text-gray-500">
                    Thao tác
                  </th>
                </tr>
              </thead>
              <tbody
                id="acct-attendance-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              >
                <tr>
                  <td colspan="5" class="text-center py-4 text-gray-500">
                    Đang tải...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="acct-payroll" class="hidden mt-6">
          <h3 class="text-lg font-semibold mb-3">Tính lương</h3>
          <div class="mb-4">
            <p class="text-sm text-gray-600">
              Chọn nhân viên bên dưới để tính lương. 1 giờ = <b>24,000</b> VNĐ.
            </p>
          </div>
          <div id="acct-payroll-list" class="scrollable-list p-2 bg-white">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Email
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Tổng giờ
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Lương cứng
                  </th>
                  <th class="px-3 py-2 text-left text-xs text-gray-500">
                    Thao tác
                  </th>
                </tr>
              </thead>
              <tbody
                id="acct-payroll-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              >
                <tr>
                  <td colspan="4" class="text-center py-4 text-gray-500">
                    Đang tải...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="acct-report" class="hidden mt-6">
          <h3 class="text-lg font-semibold mb-3">Báo cáo kế toán</h3>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <input type="date" id="report-start" class="p-2 border rounded" />
            <input type="date" id="report-end" class="p-2 border rounded" />
            <button
              id="generate-report-btn"
              class="py-2 px-4 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              onclick="generateAccountingReport()"
            >
              Tạo báo cáo
            </button>
          </div>

          <div id="acct-report-result" class="p-4 bg-white rounded shadow-sm">
            <p class="text-sm text-gray-500">
              Kết quả báo cáo sẽ hiển thị ở đây.
            </p>
          </div>

          <div class="flex justify-end mt-4">
            <button
              id="send-report-btn"
              class="py-2 px-4 bg-emerald-600 text-white rounded hidden hover:bg-emerald-700"
              onclick="sendReportToDirector()"
            >
              Gửi báo cáo cho Giám đốc
            </button>
          </div>
        </div>
      </div>
    </div>

    <button
      id="open-salary-btn"
      onclick="openSalaryModal()"
      class="hidden py-2 px-4 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition-colors"
    >
      <i class="fas fa-money-bill-wave mr-1"></i> Xem Lương
    </button>

    <div
      id="salary-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 relative"
      >
        <h3 class="text-xl font-bold text-teal-700 border-b pb-2 mb-4">
          Phiếu Lương Chi Tiết
        </h3>

        <div
          id="salary-content"
          class="max-h-96 overflow-y-auto space-y-3 text-sm"
        >
          <p class="text-center text-gray-500" id="salary-message">
            Đang tải...
          </p>
        </div>

        <div class="mt-6 text-right">
          <button
            onclick="closeSalaryModal()"
            class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400"
          >
            Đóng
          </button>
        </div>
      </div>
    </div>

    <div
      id="baoCaoModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 999;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          width: 400px;
          max-height: 80%;
          overflow-y: auto;
        "
      >
        <h3 style="text-align: center; margin-bottom: 15px">
          📋 Báo cáo lương
        </h3>

        <div id="dsLuong"></div>

        <textarea
          id="noiDungBaoCao"
          placeholder="Nhập nội dung báo cáo thêm..."
          style="
            width: 100%;
            height: 80px;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
          "
        ></textarea>

        <div style="text-align: center; margin-top: 15px">
          <button
            id="guiBaoCao"
            style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 8px;
            "
          >
            Gửi
          </button>
          <button
            id="dongModal"
            style="
              margin-left: 10px;
              background: #ccc;
              border: none;
              padding: 8px 16px;
              border-radius: 8px;
            "
          >
            Đóng
          </button>
        </div>
      </div>
    </div>
    <button id="moBaoCao" style="margin-top: 20px"></button>
    <!-- -----------------------------------------------------------------------
         JAVASCRIPT (MODULE) - TẤT CẢ LOGIC ĐÃ ĐƯỢC NÂNG CẤP, NHƯNG GIỮ NGUYÊN CHỨC NĂNG
         ----------------------------------------------------------------------- -->
    <script type="module">
      import { runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";

      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        addDoc,
        getDocs,
        onSnapshot,
        query,
        where,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
      import {
        getDatabase,
        ref as dbRef, // <-- Đã đặt tên lại thành dbRef
        set as dbSet,
        get as dbGet, // <-- Đã đặt tên lại thành dbGet
        update as dbUpdate,
        push as dbPush,
        child as dbChild,
        remove as dbRemove,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

      // ---------------------------
      // 1️⃣ CẤU HÌNH FIREBASE
      // ---------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyA4d8ntVGva4RgVq8dN1IP56qB4_2Lm2lE",
        authDomain: "user-f441d.firebaseapp.com",
        projectId: "user-f441d",
        databaseURL: "https://user-f441d-default-rtdb.firebaseio.com",
        storageBucket: "user-f441d.firebasestorage.app",
        messagingSenderId: "348854983093",
        appId: "1:348854983093:web:c63954303bd441bb24a1fc",
        measurementId: "G-NNL96JYL4N",
      };

      // ---------------------------
      // 2️⃣ KHỞI TẠO FIREBASE
      // ---------------------------
      let app, db, rtdb, auth;

      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app); // Firestore
        rtdb = getDatabase(app); // Realtime DB
        auth = getAuth(app);

        console.log(
          "%c🔥 Firebase (Firestore + RTDB) khởi tạo thành công!",
          "color: #4caf50; font-weight: bold;"
        );

        // Theo dõi đăng nhập
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("%c👤 Đã đăng nhập: " + user.email, "color: #2196f3;");
            // Khi có user, có thể gọi loadUserSalarySlips() tại đây nếu cần
            // Vd: if (document.getElementById('user-salary-view')?.style.display !== 'none') { window.loadUserSalarySlips(); }
          } else {
            console.log(
              "%c🚪 Chưa có người dùng đăng nhập.",
              "color: #f57c00;"
            );
          }
        });
      } catch (e) {
        console.error("❌ Lỗi khởi tạo Firebase:", e);
        // Thay thế alert() bằng UI displayMessage
        if (typeof UI?.displayMessage === "function") {
          UI.displayMessage("Lỗi khởi tạo Firebase: " + e.message, "error");
        } else {
          console.error(
            "Lỗi: Không thể hiển thị tin nhắn do UI.displayMessage không tồn tại."
          );
        }
      }

      // ---------------------------
      // 3️⃣ FIRESTORE FUNCTIONS
      // ---------------------------
      async function saveUserData(uid, data) {
        try {
          await setDoc(doc(db, "users", uid), data);
          console.log(
            "%c✅ Dữ liệu người dùng đã lưu vào Firestore!",
            "color: #00c853;"
          );
        } catch (err) {
          console.error("❌ Lỗi lưu dữ liệu:", err);
        }
      }

      async function loadUserData(uid) {
        try {
          const snap = await getDoc(doc(db, "users", uid));
          if (snap.exists()) {
            console.log(
              "%c📄 Dữ liệu người dùng:",
              "color: #4caf50;",
              snap.data()
            );
            return snap.data();
          } else {
            console.warn("⚠️ Không tìm thấy người dùng:", uid);
          }
        } catch (err) {
          console.error("❌ Lỗi đọc dữ liệu:", err);
        }
      }

      // ---------------------------
      // 4️⃣ REALTIME DATABASE FUNCTIONS (Hàm ví dụ)
      // ---------------------------
      async function markAttendance(userId, date, status) {
        try {
          // SỬ DỤNG dbRef VÀ dbSet ĐÃ ĐƯỢC IMPORT
          const reference = dbRef(rtdb, `attendance/${userId}/${date}`);
          await dbSet(reference, {
            status,
            time: new Date().toISOString(),
          });
          console.log("%c🕓 Chấm công thành công!", "color: #03a9f4;");
        } catch (err) {
          console.error("❌ Lỗi chấm công:", err);
        }
      }

      async function getAttendance(userId) {
        try {
          // SỬ DỤNG dbRef VÀ dbGet ĐÃ ĐƯỢC IMPORT
          const reference = dbRef(rtdb, `attendance/${userId}`);
          const snap = await dbGet(reference);
          if (snap.exists()) {
            console.log(
              "%c📊 Dữ liệu chấm công:",
              "color: #8bc34a;",
              snap.val()
            );
            return snap.val();
          } else {
            console.warn("⚠️ Không có dữ liệu chấm công.");
          }
        } catch (err) {
          console.error("❌ Lỗi đọc chấm công:", err);
        }
      }

      // Xuất các hàm ra để dùng trong HTML
      window.saveUserData = saveUserData;
      window.loadUserData = loadUserData;
      window.markAttendance = markAttendance;
      window.getAttendance = getAttendance;

      // ---------------------------
      // 2) HÀM TIỆN ÍCH CHUNG (UI & HELPERS)
      // ---------------------------
      const UI = (() => {
        // cache selectors we use often
        const $ = (id) => document.getElementById(id);

        function displayMessage(message, type = "info", timeout = 4500) {
          const box = $("message-box");
          if (!box) return;
          box.textContent = message;
          box.classList.remove(
            "hidden",
            "bg-red-100",
            "text-red-700",
            "bg-green-100",
            "text-green-700",
            "bg-blue-100",
            "text-blue-700"
          );
          if (type === "error") box.classList.add("bg-red-100", "text-red-700");
          else if (type === "success")
            box.classList.add("bg-green-100", "text-green-700");
          else box.classList.add("bg-blue-100", "text-blue-700");

          // clear timeout if exists
          if (box._hideTimer) clearTimeout(box._hideTimer);
          box._hideTimer = setTimeout(() => {
            box.classList.add("hidden");
          }, timeout);
        }

        function formatDate(isoString) {
          if (!isoString) return "N/A";
          if (/^\d{4}-\d{2}-\d{2}$/.test(isoString)) {
            return new Date(isoString + "T00:00:00").toLocaleDateString(
              "vi-VN",
              { day: "2-digit", month: "2-digit", year: "numeric" }
            );
          }
          const d = new Date(isoString);
          return d.toLocaleDateString("vi-VN", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });
        }

        // render helpers for tables/lists using DocumentFragment
        function renderTableRows(containerId, rowsHtmlArray) {
          const el = $(containerId);
          if (!el) return;
          el.innerHTML = ""; // clear existing
          const frag = document.createDocumentFragment();
          // create wrapper tbody to append rows safely
          rowsHtmlArray.forEach((html) => {
            const tr = document.createElement("tr");
            tr.innerHTML = html;
            frag.appendChild(tr);
          });
          el.appendChild(frag);
        }

        return { displayMessage, formatDate, renderTableRows, $ };
      })();

      // ---------------------------
      // 3) CẤU HÌNH ROLE & DEPT (KEEP)
      // ---------------------------
      const roleNames = {
        nhanvien: "Nhân viên",
        quanlynhansu: "Quản lý nhân sự",
        ketoan: "Kế toán",
        quanlyhethong: "Quản lý hệ thống",
        giamdoc: "Giám đốc",
      };

      const departmentNames = {
        kythuat: "KỸ THUẬT",
        marketing: "MARKETING",
        ketoantaichinh: "Phòng Kế toán - Tài chính",
        hanhchinhnhansu: "Phòng Hành chính - Nhân sự",
        "N/A": "Chưa phân công",
      };

      const recipientNames = {
        toancongty: "Toàn bộ công ty",
        quanlynhansu: "Quản lý nhân sự",
        ketoan: "Kế toán",
      };

      // prepare select option html strings
      const roleOptionsHtml = Object.entries(roleNames)
        .map(([key, name]) => `<option value="${key}">${name}</option>`)
        .join("");
      const departmentOptionsHtml = Object.entries(departmentNames)
        .filter(([k]) => k !== "N/A")
        .map(([k, n]) => `<option value="${k}">${n}</option>`)
        .join("");

      // ---------------------------
      // 4) GLOBAL STATE (scoped to module)
      // ---------------------------
      let currentUserRole = "nhanvien";
      let unsubscribeRoleListener = null;
      let unsubscribeUserListListener = null;
      let unsubscribeNotifHistoryListener = null;
      let unsubscribeUserNotifsListener = null;
      let unsubscribePersonnelListListener = null;

      // store director session when creating other accounts (existing behavior)
      let directorEmailSession = null;
      let directorPasswordSession = null;

      // ---------------------------
      // 5) DOMContent Loaded init
      // ---------------------------
      document.addEventListener("DOMContentLoaded", () => {
        // set today as default
        const today = new Date().toISOString().split("T")[0];
        const notifDateInput = document.getElementById("notif-ngay-gui");
        if (notifDateInput) notifDateInput.value = today;

        const modalRoleSelect = document.getElementById("modal-role-select");
        if (modalRoleSelect) modalRoleSelect.innerHTML = roleOptionsHtml;

        const deptSelect = document.getElementById("modal-dept-select");
        if (deptSelect) deptSelect.innerHTML = departmentOptionsHtml;

        // accounting tab defaults
        showAccountingTab("attendance");
      });

      // ---------------------------
      // 6) UI OPEN/CLOSE functions (kept original but safer)
      // ---------------------------
      function safeShow(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = "flex";
      }
      function safeHide(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = "none";
      }

      window.openSystemManagementView = function () {
        if (currentUserRole === "giamdoc") {
          safeShow("system-management-view");
          safeHide("user-management-view");
          safeHide("notification-management-view");
          safeHide("personnel-deployment-view");
        } else {
          UI.displayMessage(
            "Bạn không có quyền truy cập chức năng này.",
            "error"
          );
        }
      };
      window.closeSystemManagementView = function () {
        safeHide("system-management-view");
        safeHide("personnel-deployment-view");
      };

      window.openUserManagementView = function () {
        if (currentUserRole === "giamdoc") {
          safeShow("user-management-view");
          listenForUserList();
        } else
          UI.displayMessage(
            "Bạn không có quyền truy cập chức năng này.",
            "error"
          );
      };
      window.closeUserManagementView = function () {
        safeHide("user-management-view");
        if (unsubscribeUserListListener) {
          unsubscribeUserListListener();
          unsubscribeUserListListener = null;
        }
      };

      window.openNotificationManagementView = function () {
        safeShow("notification-management-view");
        if (currentUserRole === "giamdoc") listenForNotificationHistory();
      };
      window.closeNotificationManagementView = function () {
        safeHide("notification-management-view");
        if (unsubscribeNotifHistoryListener) {
          unsubscribeNotifHistoryListener();
          unsubscribeNotifHistoryListener = null;
        }
      };

      window.openViewNotificationsView = function () {
        safeShow("view-notifications-view");
        document.getElementById(
          "notif-role-filter-info"
        ).textContent = `Thông báo dành cho vai trò: ${
          roleNames[currentUserRole] || "Đang tải..."
        }`;
        listenForUserNotifications();
      };
      window.closeViewNotificationsView = function () {
        safeHide("view-notifications-view");
        if (unsubscribeUserNotifsListener) {
          unsubscribeUserNotifsListener();
          unsubscribeUserNotifsListener = null;
        }
      };

      window.openPersonnelDeploymentView = function () {
        if (currentUserRole === "giamdoc") {
          safeShow("personnel-deployment-view");
          listenForPersonnelList();
        } else
          UI.displayMessage(
            "Bạn không có quyền truy cập chức năng này.",
            "error"
          );
      };
      window.closePersonnelDeploymentView = function () {
        safeHide("personnel-deployment-view");
        if (unsubscribePersonnelListListener) {
          unsubscribePersonnelListListener();
          unsubscribePersonnelListListener = null;
        }
      };

      window.closeModal = function () {
        safeHide("role-modal");
        const container = document.getElementById(
          "modal-role-select-container"
        );
        if (container) container.classList.remove("hidden");
        const btn = document.getElementById("modal-confirm-btn");
        if (btn) btn.textContent = "Xác Nhận";
      };
      window.closeDeploymentModal = function () {
        safeHide("deployment-modal");
      };

      // ---------------------------
      // 7) AUTH (login/logout & onAuthState)
      // ---------------------------
      window.handleAuth = async function (event) {
        event.preventDefault();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          UI.displayMessage("Vui lòng nhập đầy đủ Email và Mật khẩu.", "error");
          return;
        }
        try {
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;
          const userData = await getUserProfile(user.uid);
          if (userData && userData.disabled) {
            await signOut(auth);
            UI.displayMessage(
              "Tài khoản này đã bị vô hiệu hóa. Vui lòng liên hệ Giám đốc để Khôi phục.",
              "error"
            );
            return;
          }
          directorEmailSession = email;
          directorPasswordSession = password;
          UI.displayMessage(
            "Đăng nhập thành công! Đang tải dữ liệu...",
            "success"
          );
        } catch (error) {
          console.error("Login error:", error);
          let msg = "Đã xảy ra lỗi. Vui lòng thử lại.";
          if (error.code === "auth/invalid-email")
            msg = "Địa chỉ email không hợp lệ.";
          else if (
            ["auth/user-not-found", "auth/wrong-password"].includes(error.code)
          )
            msg = "Email hoặc mật khẩu không chính xác.";
          UI.displayMessage(`Lỗi: ${msg}`, "error");
        }
      };

      window.logoutUser = async function () {
        try {
          [
            unsubscribeRoleListener,
            unsubscribeUserListListener,
            unsubscribeNotifHistoryListener,
            unsubscribeUserNotifsListener,
            unsubscribePersonnelListListener,
          ].forEach((fn, idx) => {
            if (fn) {
              try {
                fn();
              } catch (e) {
                console.warn("unsubscribe error", e);
              }
            }
          });
          unsubscribeRoleListener =
            unsubscribeUserListListener =
            unsubscribeNotifHistoryListener =
            unsubscribeUserNotifsListener =
            unsubscribePersonnelListListener =
              null;

          await signOut(auth);
          directorEmailSession = directorPasswordSession = null;

          safeHide("system-management-view");
          safeHide("user-management-view");
          safeHide("notification-management-view");
          safeHide("view-notifications-view");
          safeHide("personnel-deployment-view");
          safeHide("accounting-view");

          UI.displayMessage("Đăng xuất thành công.", "info");
        } catch (error) {
          console.error("Logout error:", error);
          UI.displayMessage(
            "Lỗi khi đăng xuất. Vui lòng kiểm tra console.",
            "error"
          );
        }
      };

      // ---------------------------
      // 8) Firestore helpers (profile save/get)
      // ---------------------------
      async function getUserProfile(uid) {
        try {
          const userDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
          );
          const snap = await getDoc(userDocRef);
          return snap.exists() ? snap.data() : null;
        } catch (e) {
          console.error("getUserProfile error:", e);
          return null;
        }
      }

      async function saveUserProfile(
        uid,
        email,
        role = null,
        disabled = null,
        phongBan = null
      ) {
        try {
          const privateDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
          );
          const publicDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
          );

          // merge strategy: read current profile once to avoid overwriting unintentionally
          const current = (await getUserProfile(uid)) || {};

          const profileData = {
            uid,
            email,
            updatedAt: new Date().toISOString(),
            role: role ?? current.role ?? "nhanvien",
            phongBan: phongBan ?? current.phongBan ?? "N/A",
          };
          // only set disabled field if explicitly provided (to avoid toggling accidentally)
          if (disabled !== null) profileData.disabled = disabled;

          await setDoc(privateDocRef, profileData, { merge: true });
          await setDoc(publicDocRef, profileData, { merge: true });
        } catch (e) {
          console.error("saveUserProfile error:", e);
          throw e;
        }
      }

      // ---------------------------
      // 9) USER MANAGEMENT (list, render, create, toggle status, role update)
      // ---------------------------
      function listenForUserList() {
        if (unsubscribeUserListListener) {
          unsubscribeUserListListener();
          unsubscribeUserListListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const q = query(colRef);
          unsubscribeUserListListener = onSnapshot(
            q,
            (snap) => {
              const users = [];
              snap.forEach((d) => users.push(d.data()));
              renderUserList(users);
            },
            (err) => {
              console.error("listenForUserList error:", err);
              const body = document.getElementById("user-list-body");
              if (body)
                body.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Lỗi tải danh sách: ${err.message}</td></tr>`;
            }
          );
        } catch (e) {
          console.error("listenForUserList setup error:", e);
        }
      }

      function renderUserList(users) {
        const tbody = document.getElementById("user-list-body");
        if (!tbody) return;
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Chưa có người dùng nào được tạo.</td></tr>`;
          return;
        }
        const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
        const rows = users.map((user) => {
          const roleDisplay = roleNames[user.role] || user.role;
          const statusDisplay = user.disabled ? "Bị khóa" : "Hoạt động";
          const statusClass = user.disabled
            ? "bg-red-100 text-red-800"
            : "bg-green-100 text-green-800";
          const isCurrentUser = user.uid === currentUserId;

          // action buttons html (keep same functions)
          const actionButtons = `
            <button onclick="openRoleModal('${user.uid}', '${user.email}', '${
            user.role
          }')" class="py-1 px-2 bg-indigo-500 text-white text-xs font-medium rounded-lg hover:bg-indigo-600 transition ${
            isCurrentUser ? "opacity-50 cursor-not-allowed" : ""
          }" ${isCurrentUser ? "disabled" : ""}>Phân quyền</button>
            <button onclick="openPasswordModal('${user.uid}', '${
            user.email
          }')" class="py-1 px-2 bg-yellow-500 text-white text-xs font-medium rounded-lg hover:bg-yellow-600 transition">Đặt lại mật khẩu</button>
            <button onclick="toggleUserStatus('${user.uid}', '${
            user.email
          }', ${!user.disabled})" class="py-1 px-2 text-white text-xs font-medium rounded-lg transition ${
            user.disabled
              ? "bg-green-500 hover:bg-green-600"
              : "bg-red-500 hover:bg-red-600"
          }" ${isCurrentUser ? "disabled" : ""}>${
            user.disabled ? "Khôi phục" : "Vô hiệu hóa"
          }</button>
          `;

          return `
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email} ${
            isCurrentUser ? "(Bạn)" : ""
          }</td>
            <td class="px-3 py-2 text-gray-800">${roleDisplay}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusDisplay}</span></td>
            <td class="px-3 py-2 whitespace-nowrap text-right space-x-1">${actionButtons}</td>
          `;
        });

        // use the render helper to append rows
        UI.renderTableRows("user-list-body", rows);
      }

      window.createNewUserByDirector = async function (event) {
        event.preventDefault();
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("Bạn không có quyền tạo tài khoản.", "error");
          return;
        }
        const email = document.getElementById("new-email").value.trim();
        const password = document.getElementById("new-password").value;
        const role = document.getElementById("new-role").value;
        if (!email || !password || !role) {
          UI.displayMessage("Vui lòng nhập đầy đủ thông tin.", "error");
          return;
        }
        try {
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;
          await saveUserProfile(user.uid, email, role, false, "N/A");
          UI.displayMessage(
            `Tài khoản ${email} (${roleNames[role]}) đã được tạo thành công.`,
            "success"
          );

          // Re-authenticate director to restore session if needed (existing behavior)
          if (directorEmailSession && directorPasswordSession) {
            try {
              await signInWithEmailAndPassword(
                auth,
                directorEmailSession,
                directorPasswordSession
              );
            } catch (reAuthErr) {
              console.warn("Re-auth director failed:", reAuthErr);
            }
          }

          // reset form inputs
          document.getElementById("new-email").value = "";
          document.getElementById("new-password").value = "";
          document.getElementById("new-role").value = "";
        } catch (e) {
          console.error("createNewUser error:", e);
          UI.displayMessage(`Lỗi tạo tài khoản: ${e.message}`, "error");
        }
      };

      window.toggleUserStatus = async function (uid, email, isDisabled) {
        if (uid === (auth.currentUser ? auth.currentUser.uid : null)) {
          UI.displayMessage(
            "Bạn không thể vô hiệu hóa tài khoản Giám đốc của chính mình.",
            "error"
          );
          return;
        }
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage(
            "Bạn không có quyền thay đổi trạng thái người dùng.",
            "error"
          );
          return;
        }
        try {
          await saveUserProfile(uid, email, null, isDisabled, null);
          UI.displayMessage(
            `Đã ${
              isDisabled ? "vô hiệu hóa" : "kích hoạt"
            } tài khoản ${email}.`,
            "success"
          );
        } catch (e) {
          console.error("toggleUserStatus error:", e);
          UI.displayMessage(`Lỗi: ${e.message}`, "error");
        }
      };

      async function updateUserRole(uid, email, newRole) {
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("Bạn không có quyền thay đổi vai trò.", "error");
          return;
        }
        try {
          await saveUserProfile(uid, email, newRole, null, null);
          UI.displayMessage(
            `Đã cập nhật vai trò của ${email} thành ${roleNames[newRole]}.`,
            "success"
          );
        } catch (e) {
          console.error("updateUserRole error:", e);
          UI.displayMessage(`Lỗi: ${e.message}`, "error");
        }
      }

      // openPasswordModal, openRoleModal kept but refactored for safety
      window.openPasswordModal = function (uid, email) {
        // will reuse role modal area UI to ask for reset/ send email (original behavior kept)
        // Implementation: send reset email
        if (!confirm(`Bạn muốn gửi email đặt lại mật khẩu cho ${email}?`))
          return;
        sendPasswordResetEmail(auth, email)
          .then(() => {
            UI.displayMessage(
              `Email đặt lại mật khẩu đã gửi tới ${email}`,
              "success"
            );
          })
          .catch((e) => {
            console.error("sendResetEmail error:", e);
            UI.displayMessage(`Lỗi gửi email: ${e.message}`, "error");
          });
      };

      window.openRoleModal = function (uid, email, currentRole) {
        if (currentUserRole !== "giamdoc") return;
        const modal = document.getElementById("role-modal");
        const title = document.getElementById("modal-title");
        const userInfo = document.getElementById("modal-user-info");
        const roleSelect = document.getElementById("modal-role-select");
        const confirmBtn = document.getElementById("modal-confirm-btn");

        if (!modal || !title || !userInfo || !roleSelect || !confirmBtn) return;
        title.textContent = "Phân quyền người dùng";
        userInfo.innerHTML = `Chỉnh quyền cho: <b>${email}</b>`;
        roleSelect.value = currentRole || "nhanvien";

        confirmBtn.onclick = async () => {
          const newRole = roleSelect.value;
          if (!newRole) {
            UI.displayMessage("Vui lòng chọn vai trò.", "error");
            return;
          }
          await updateUserRole(uid, email, newRole);
          closeModal();
        };

        modal.style.display = "flex";
      };

      // ---------------------------
      // 10) Personnel (listen, render, open deployment modal, confirm)
      // ---------------------------
      function listenForPersonnelList() {
        if (unsubscribePersonnelListListener) {
          unsubscribePersonnelListListener();
          unsubscribePersonnelListListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const q = query(colRef);
          unsubscribePersonnelListListener = onSnapshot(
            q,
            (snap) => {
              const personnel = [];
              const currentUserId = auth.currentUser
                ? auth.currentUser.uid
                : null;
              snap.forEach((d) => {
                const data = d.data();
                if (data.uid !== currentUserId) personnel.push(data);
              });
              renderPersonnelList(personnel);
            },
            (err) => {
              console.error("listenForPersonnelList error:", err);
              const el = document.getElementById("personnel-list-body");
              if (el)
                el.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Lỗi tải danh sách nhân sự: ${err.message}</td></tr>`;
            }
          );
        } catch (e) {
          console.error("listenForPersonnelList setup error:", e);
        }
      }

      function renderPersonnelList(personnel) {
        const body = document.getElementById("personnel-list-body");
        if (!body) return;
        if (!Array.isArray(personnel) || personnel.length === 0) {
          body.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Chưa có nhân sự nào để điều động.</td></tr>`;
          return;
        }
        const rows = personnel.map((user) => {
          const roleDisplay = roleNames[user.role] || user.role;
          const departmentKey = user.phongBan || "N/A";
          const departmentDisplay =
            departmentNames[departmentKey] || "Chưa phân công";
          const actionButton = `<button onclick="openDeploymentModal('${
            user.uid
          }', '${
            user.email
          }', '${departmentKey}')" class="py-1 px-3 bg-yellow-600 text-white text-xs font-medium rounded-lg hover:bg-yellow-700 transition" ${
            user.disabled ? "disabled" : ""
          }>Điều động</button>`;
          return `
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email}</td>
            <td class="px-3 py-2 text-gray-800">${roleDisplay}</td>
            <td class="px-3 py-2 text-gray-700 font-semibold">${departmentDisplay}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center">${actionButton}</td>
          `;
        });
        UI.renderTableRows("personnel-list-body", rows);
      }

      window.openDeploymentModal = function (uid, email, currentDeptKey) {
        if (currentUserRole !== "giamdoc") return;
        const info = document.getElementById("deployment-user-info");
        const deptSelect = document.getElementById("modal-dept-select");
        const confirmBtn = document.getElementById("deployment-confirm-btn");
        if (!info || !deptSelect || !confirmBtn) return;

        info.innerHTML = `Đang điều động nhân sự: <b>${email}</b> (Phòng hiện tại: ${
          departmentNames[currentDeptKey] || "Chưa phân công"
        })`;
        deptSelect.value = departmentNames[currentDeptKey]
          ? currentDeptKey
          : Object.keys(departmentNames).find((k) => k !== "N/A");

        // remove old onclick
        confirmBtn.onclick = null;
        confirmBtn.onclick = () => {
          const newDepartmentKey = deptSelect.value;
          confirmDeploymentAndNotify(uid, email, newDepartmentKey);
          closeDeploymentModal();
        };
        document.getElementById("deployment-modal").style.display = "flex";
      };

      async function confirmDeploymentAndNotify(uid, email, newDepartmentKey) {
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("Bạn không có quyền thực hiện điều động.", "error");
          return;
        }
        const newDepartmentName =
          departmentNames[newDepartmentKey] || "Chưa phân công";
        try {
          // 1) cập nhật phòng ban
          await saveUserProfile(uid, email, null, false, newDepartmentKey);

          // 2) tạo thông báo cá nhân
          const today = new Date().toISOString().split("T")[0];
          const notifTieuDe = "Quyết định Điều Động Nhân Sự";
          const notifNoiDung = `Người gửi: Giám đốc\nNgày: ${UI.formatDate(
            today
          )}\nGửi là: ${email}\nNội dung: Bạn được điều động qua Phòng Ban [${newDepartmentName}].`;

          const notificationData = {
            matb: `DD${Date.now().toString().slice(-6)}`,
            tieuDe: notifTieuDe,
            noiDung: notifNoiDung,
            ngayGui: today,
            doiTuongNhan: uid, // gửi đến UID
            loaiThongBao: "khancap",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          };

          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, notificationData);
          UI.displayMessage(
            `Đã điều động ${email} sang ${newDepartmentName} và gửi thông báo thành công.`,
            "success"
          );
        } catch (e) {
          console.error("confirmDeploymentAndNotify error:", e);
          UI.displayMessage(`Lỗi điều động: ${e.message}`, "error");
        }
      }

      // ---------------------------
      // 11) NOTIFICATIONS (create, listen, render)
      // ---------------------------
      window.createNotification = async function (event) {
        event.preventDefault();
        if (currentUserRole !== "giamdoc") {
          UI.displayMessage("Bạn không có quyền tạo thông báo.", "error");
          return;
        }
        const matb = document.getElementById("notif-matb").value.trim();
        const tieuDe = document.getElementById("notif-tieu-de").value.trim();
        const noiDung = document.getElementById("notif-noi-dung").value.trim();
        const ngayGui = document.getElementById("notif-ngay-gui").value;
        const doiTuong = document.getElementById("notif-doi-tuong").value;
        const loai = document.getElementById("notif-loai").value;

        if (!matb || !tieuDe || !noiDung || !ngayGui || !doiTuong || !loai) {
          UI.displayMessage(
            "Vui lòng nhập đầy đủ thông tin thông báo.",
            "error"
          );
          return;
        }
        try {
          const notificationData = {
            matb,
            tieuDe,
            noiDung,
            ngayGui,
            doiTuongNhan: doiTuong,
            loaiThongBao: loai,
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          };
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, notificationData);
          UI.displayMessage(
            `Thông báo "${tieuDe}" đã được tạo thành công!`,
            "success"
          );

          // reset form fields (except date)
          document.getElementById("notif-matb").value = "";
          document.getElementById("notif-tieu-de").value = "";
          document.getElementById("notif-noi-dung").value = "";
        } catch (e) {
          console.error("createNotification error:", e);
          UI.displayMessage(`Lỗi tạo thông báo: ${e.message}`, "error");
        }
      };

      function listenForNotificationHistory() {
        if (unsubscribeNotifHistoryListener) {
          unsubscribeNotifHistoryListener();
          unsubscribeNotifHistoryListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          const q = query(colRef);
          unsubscribeNotifHistoryListener = onSnapshot(
            q,
            (snap) => {
              const notifications = [];
              snap.forEach((d) =>
                notifications.push({ id: d.id, ...d.data() })
              );
              notifications.sort(
                (a, b) => new Date(b.ngayGui) - new Date(a.ngayGui)
              );
              renderNotificationHistory(notifications);
            },
            (err) => {
              console.error("listenForNotificationHistory error:", err);
              const body = document.getElementById("notif-history-body");
              if (body)
                body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Lỗi tải lịch sử: ${err.message}</td></tr>`;
            }
          );
        } catch (e) {
          console.error("listenForNotificationHistory setup error:", e);
        }
      }

      // ---------------------------
      // baodzaik7) ACCOUNTING: helpers (RTDB operations + UI)
      // ---------------------------
      // ---------------------------
      // 12) ACCOUNTING: helpers (RTDB operations + UI)
      // ---------------------------

      // Lưu ý: Các biến và hàm như 'db', 'rtdb', 'auth', 'collection', 'getDocs', 'dbRef', 'dbGet', 'dbSet', 'runTransaction', 'where', 'query', 'addDoc', 'onSnapshot', 'UI', 'safeShow', 'safeHide', 'currentUserRole', 'firebaseConfig', 'roleNames', 'departmentNames', 'recipientNames', 'unsubscribeUserNotifsListener' phải được định nghĩa và khởi tạo ở nơi khác trong mã nguồn của bạn.

      // encode email for RTDB keys (simple)
      function encodeEmailKey(email) {
        return email.replace(/\./g, ",");
      }

      // show accounting tabs
      window.showAccountingTab = function (tab) {
        const tabs = ["attendance", "payroll", "report"];
        tabs.forEach((t) => {
          const btn = document.getElementById("tab-" + t);
          const panel = document.getElementById("acct-" + t);
          if (t === tab) {
            if (btn) {
              btn.classList.remove("bg-gray-200");
              btn.classList.add("bg-indigo-600", "text-white");
            }
            if (panel) panel.classList.remove("hidden");
          } else {
            if (btn) {
              btn.classList.add("bg-gray-200");
              btn.classList.remove("bg-indigo-600", "text-white");
            }
            if (panel) panel.classList.add("hidden");
          }
        });
        // load content for active
        if (tab === "attendance") loadAccountingAttendanceList();
        if (tab === "payroll") loadAccountingPayrollList();
        // Báo cáo không cần tải data mà chỉ cần hiển thị UI, đợi user bấm tạo
      };

      // open/close accounting view
      window.openAccountingView = function () {
        if (currentUserRole === "giamdoc" || currentUserRole === "ketoan") {
          safeShow("accounting-view");
          // Mặc định tab chấm công khi mở
          window.showAccountingTab("attendance");
          // load lists (loadAccountingAttendanceList được gọi trong showAccountingTab)
          // loadAccountingPayrollList();
        } else {
          UI.displayMessage(
            "Bạn không có quyền truy cập chức năng Kế toán.",
            "error"
          );
        }
      };
      window.closeAccountingView = function () {
        safeHide("accounting-view");
      };

      // load user list for accounting attendance tab (reuse public user_profiles)
      async function loadAccountingAttendanceList() {
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const snap = await getDocs(colRef);
          const users = [];
          snap.forEach((d) => users.push(d.data()));
          renderAccountingAttendance(users);
        } catch (e) {
          console.error("loadAccountingAttendanceList error:", e);
          const body = document.getElementById("acct-attendance-body");
          if (body)
            body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Lỗi tải danh sách: ${e.message}</td></tr>`;
        }
      }

      // render attendance table rows
      async function renderAccountingAttendance(users) {
        const tbody = document.getElementById("acct-attendance-body");
        if (!tbody) return;
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Chưa có người dùng.</td></tr>`;
          return;
        }
        const rows = [];
        for (const user of users) {
          const emailKey = encodeEmailKey(user.email || "");
          let totalHours = 0;
          try {
            // Lấy tổng giờ từ RTDB
            const snap = await dbGet(
              dbRef(rtdb, `/ChamCong/${emailKey}/tongGio`)
            );
            if (snap.exists()) totalHours = snap.val();
          } catch (e) {
            console.warn("getTotalHours error", e);
          }
          const btnDisabled = user.disabled ? "disabled" : "";
          const actionBtn = `<button onclick="markAttendance('${user.email}')" class="py-1 px-3 bg-indigo-500 text-white text-xs font-medium rounded-lg hover:bg-indigo-600 transition" ${btnDisabled}>Chấm công (+8h)</button>`;
          rows.push(`
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email}</td>
            <td class="px-3 py-2 text-gray-800">${
              roleNames[user.role] || user.role
            }</td>
            <td class="px-3 py-2 text-gray-700">${
              departmentNames[user.phongBan] || "Chưa phân công"
            }</td>
            <td class="px-3 py-2 whitespace-nowrap text-center">${totalHours}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center">${actionBtn}</td>
        `);
        }
        UI.renderTableRows("acct-attendance-body", rows);
      }

      // transaction to add 8 hours
      window.markAttendance = async function (email) {
        if (!(currentUserRole === "giamdoc" || currentUserRole === "ketoan")) {
          UI.displayMessage("Bạn không có quyền chấm công.", "error");
          return;
        }
        const key = encodeEmailKey(email);
        const ref = dbRef(rtdb, `/ChamCong/${key}/tongGio`);
        try {
          await runTransaction(ref, (current) => {
            return (current || 0) + 8;
          });
          // push history
          const histRef = dbRef(rtdb, `/ChamCong/${key}/history/${Date.now()}`);
          await dbSet(histRef, {
            hours: 8,
            by: auth.currentUser ? auth.currentUser.email : "system",
            at: new Date().toISOString(),
          });
          UI.displayMessage(`Đã chấm công +8h cho ${email}`, "success");
          // refresh attendance list
          loadAccountingAttendanceList();
          loadAccountingPayrollList(); // Cập nhật luôn lương cứng
        } catch (e) {
          console.error("markAttendance error:", e);
          UI.displayMessage(`Lỗi chấm công: ${e.message}`, "error");
        }
      };

      // payroll list (for selection)
      async function loadAccountingPayrollList() {
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const snap = await getDocs(colRef);
          const users = [];
          snap.forEach((d) => users.push(d.data()));
          renderAccountingPayroll(users);
        } catch (e) {
          console.error("loadAccountingPayrollList error:", e);
          const body = document.getElementById("acct-payroll-body");
          if (body)
            body.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Lỗi tải danh sách: ${e.message}</td></tr>`;
        }
      }

      async function renderAccountingPayroll(users) {
        const tbody = document.getElementById("acct-payroll-body");
        if (!tbody) return;
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Chưa có người dùng.</td></tr>`;
          return;
        }
        const rows = [];
        for (const user of users) {
          const emailKey = encodeEmailKey(user.email || "");
          let totalHours = 0;
          try {
            // Lấy tổng giờ từ RTDB
            const snap = await dbGet(
              dbRef(rtdb, `/ChamCong/${emailKey}/tongGio`)
            );
            if (snap.exists()) totalHours = snap.val();
          } catch (e) {}
          // Giả sử lương 1 giờ là 24,000
          const luongCung = totalHours * 24000;
          const actionBtn = `<button onclick="openPayrollModal('${user.email}')" class="py-1 px-3 bg-yellow-500 text-white text-xs font-medium rounded-lg hover:bg-yellow-600 transition">Tính lương</button>`;
          rows.push(`
            <td class="px-3 py-2 text-gray-900 font-medium">${user.email}</td>
            <td class="px-3 py-2 text-gray-800">${totalHours}</td>
            <td class="px-3 py-2 text-gray-800">${luongCung.toLocaleString(
              "vi-VN"
            )} đ</td>
            <td class="px-3 py-2 whitespace-nowrap">${actionBtn}</td>
        `);
        }
        UI.renderTableRows("acct-payroll-body", rows);
      }

      // open payroll modal (simple prompt flow to keep file single)
      window.openPayrollModal = async function (email) {
        if (!(currentUserRole === "giamdoc" || currentUserRole === "ketoan")) {
          UI.displayMessage("Bạn không có quyền tính lương.", "error");
          return;
        }
        const key = encodeEmailKey(email);
        let totalHours = 0;
        try {
          const snap = await dbGet(dbRef(rtdb, `/ChamCong/${key}/tongGio`));
          if (snap.exists()) totalHours = snap.val();
        } catch (e) {}
        const luongCung = totalHours * 24000;

        // Sử dụng prompt để nhập dữ liệu
        const phuCap = prompt(
          `Nhập phụ cấp cho ${email} (100000 / 200000 / 300000), để trống nếu không có:`,
          "100000"
        );
        if (phuCap === null) return;
        const thuong = prompt(
          `Nhập tiền thưởng cho ${email} (số nguyên), để 0 nếu không có:`,
          "0"
        );
        if (thuong === null) return;

        const pc = parseInt(phuCap) || 0;
        const tr = parseInt(thuong) || 0;
        const total = luongCung + pc + tr;

        if (
          !confirm(
            `Xác nhận xuất phiếu lương cho ${email}?\n\nTổng giờ: ${totalHours}\nLương cứng: ${luongCung.toLocaleString(
              "vi-VN"
            )} đ\nPhụ cấp: ${pc.toLocaleString(
              "vi-VN"
            )} đ\nThưởng: ${tr.toLocaleString(
              "vi-VN"
            )} đ\n=> Total: ${total.toLocaleString("vi-VN")} đ`
          )
        )
          return;

        // create salary slip
        await createSalarySlip(email, {
          hours: totalHours,
          luongCung,
          phuCap: pc,
          thuong: tr,
          total,
        });
      };

      async function createSalarySlip(
        email,
        { hours, luongCung, phuCap, thuong, total }
      ) {
        try {
          const key = encodeEmailKey(email);
          const slipId = `PL_${Date.now()}`;
          // 1. Lưu phiếu lương vào RTDB
          const slipRef = dbRef(rtdb, `/PhieuLuong/${key}/${slipId}`);
          await dbSet(slipRef, {
            hours,
            luong_cung: luongCung,
            phu_cap: phuCap,
            thuong,
            total,
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
            createdAt: new Date().toISOString(),
          });

          // 2. Tìm UID của người dùng để gửi thông báo
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
          );
          const q = query(colRef, where("email", "==", email));
          const snaps = await getDocs(q);
          let targetUid = null;
          snaps.forEach((d) => {
            targetUid = d.id; // id là uid
          });

          // 3. Gửi thông báo (Firestore)
          const notifTieuDe = "Thông báo phiếu lương";
          const notifNoiDung = `Bạn đã được xuất phiếu lương. Tổng tiền: ${total.toLocaleString(
            "vi-VN"
          )} đ. Vui lòng kiểm tra chi tiết.`;
          const notificationData = {
            matb: `PL${Date.now().toString().slice(-6)}`,
            tieuDe: notifTieuDe,
            noiDung: notifNoiDung,
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: targetUid || email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          };
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, notificationData);

          UI.displayMessage(
            `Phiếu lương cho ${email} đã được lưu và thông báo đã gửi.`,
            "success"
          );
          // refresh payroll list
          loadAccountingPayrollList();
        } catch (e) {
          console.error("createSalarySlip error:", e);
          UI.displayMessage(`Lỗi xuất phiếu lương: ${e.message}`, "error");
        }
      }

      // generate accounting report (simple scan of RTDB /PhieuLuong)
      window.generateAccountingReport = async function () {
        if (!(currentUserRole === "giamdoc" || currentUserRole === "ketoan")) {
          UI.displayMessage("Bạn không có quyền tạo báo cáo.", "error");
          return;
        }
        try {
          const start = document.getElementById("report-start").value;
          const end = document.getElementById("report-end").value;
          if (!start || !end) {
            UI.displayMessage(
              "Vui lòng chọn ngày bắt đầu và kết thúc.",
              "error"
            );
            return;
          }
          // read all PhieuLuong root
          const rootRef = dbRef(rtdb, `/PhieuLuong`);
          const snap = await dbGet(rootRef);
          let totalPaid = 0;
          let staffSet = new Set();
          const results = [];

          if (snap.exists()) {
            const all = snap.val();
            for (const emailKey in all) {
              const slips = all[emailKey];
              for (const slipId in slips) {
                const slip = slips[slipId];
                const createdAt = slip.createdAt || "";
                // Lọc theo ngày tạo (createdAt)
                const createdDate = createdAt.split("T")[0];
                if (createdDate >= start && createdDate <= end) {
                  totalPaid += Number(slip.total || 0);
                  staffSet.add(emailKey);
                  // Giải mã email cho báo cáo dễ đọc hơn
                  const email = emailKey.replace(/,/g, ".");
                  results.push({ email, slipId, ...slip });
                }
              }
            }
          }

          const reportEl = document.getElementById("acct-report-result");
          if (reportEl) {
            reportEl.innerHTML = `
                <p class="text-sm">Tổng tiền đã trả: <b>${totalPaid.toLocaleString(
                  "vi-VN"
                )} đ</b></p>
                <p class="text-sm">Số nhân viên đã tính lương: <b>${
                  staffSet.size
                }</b></p>
                <div class="mt-3"><details><summary class="cursor-pointer font-medium text-gray-700">Chi tiết các phiếu lương</summary><pre class="text-xs p-2 bg-gray-50 border rounded overflow-x-auto">${JSON.stringify(
                  results,
                  null,
                  2
                )}</pre></details></div>`;
          }

          // show send report button
          const sendBtn = document.getElementById("send-report-btn");
          if (sendBtn) sendBtn.classList.remove("hidden");

          // store last generated report on client state
          window._lastGeneratedReport = {
            start,
            end,
            totalPaid,
            staffCount: staffSet.size,
            details: results,
          };
          UI.displayMessage(
            "Báo cáo đã được tạo. Vui lòng kiểm tra và gửi đi.",
            "success"
          );
        } catch (e) {
          console.error("generateAccountingReport error:", e);
          UI.displayMessage(`Lỗi tạo báo cáo: ${e.message}`, "error");
        }
      };

      window.sendReportToDirector = async function () {
        if (!window._lastGeneratedReport) {
          UI.displayMessage(
            "Chưa có báo cáo để gửi. Vui lòng Tạo báo cáo trước.",
            "error"
          );
          return;
        }
        if (!(currentUserRole === "ketoan" || currentUserRole === "giamdoc")) {
          UI.displayMessage("Bạn không có quyền gửi báo cáo.", "error");
          return;
        }
        try {
          const r = window._lastGeneratedReport;
          const reportId = `RPT_${Date.now()}`;

          // 1. save report summary to RTDB
          await dbSet(dbRef(rtdb, `/BaoCaoKeToan/${reportId}`), {
            periodStart: r.start,
            periodEnd: r.end,
            totalPaid: r.totalPaid,
            staffCount: r.staffCount,
            generatedBy: auth.currentUser ? auth.currentUser.email : "system",
            createdAt: new Date().toISOString(),
            // Lưu trữ chi tiết dưới dạng JSON string để tránh lỗi RTDB nếu quá lớn
            // detailsSummary: r.details.length
          });

          // 2. notify giám đốc via Firestore notifications
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `RPT${Date.now().toString().slice(-6)}`,
            tieuDe: `Báo cáo kế toán (${r.start} → ${r.end})`,
            noiDung: `Tổng tiền đã trả: ${r.totalPaid.toLocaleString(
              "vi-VN"
            )} đ\nSố NV đã tính lương: ${r.staffCount}`,
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: "giamdoc", // Target the Director role
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });

          // Ẩn nút gửi báo cáo sau khi gửi thành công
          const sendBtn = document.getElementById("send-report-btn");
          if (sendBtn) sendBtn.classList.add("hidden");

          UI.displayMessage(
            "Báo cáo đã gửi cho Giám đốc và lưu vào hệ thống.",
            "success"
          );
        } catch (e) {
          console.error("sendReportToDirector error:", e);
          UI.displayMessage(`Lỗi gửi báo cáo: ${e.message}`, "error");
        }
      };

      // --- CÁC HÀM LIÊN QUAN ĐẾN THÔNG BÁO (THEO LOGIC BAN ĐẦU) ---

      function renderNotificationHistory(notifications) {
        const tbody = document.getElementById("notif-history-body");
        if (!tbody) return;
        if (!notifications || notifications.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Chưa có thông báo nào được tạo.</td></tr>`;
          return;
        }
        const rows = notifications.map((notif) => {
          const doiTuongDisplay =
            recipientNames[notif.doiTuongNhan] ||
            (notif.doiTuongNhan ===
            (auth.currentUser ? auth.currentUser.uid : null)
              ? "Cá nhân (Điều động)"
              : notif.doiTuongNhan);
          const loaiClass =
            notif.loaiThongBao === "khancap"
              ? "bg-red-500 text-white"
              : "bg-blue-100 text-blue-800";
          return `
            <td class="px-3 py-2 whitespace-nowrap text-gray-900 font-medium">${
              notif.matb
            }</td>
            <td class="px-3 py-2 text-gray-800">${notif.tieuDe}</td>
            <td class="px-3 py-2 whitespace-nowrap">${UI.formatDate(
              notif.ngayGui
            )}</td>
            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-600">${doiTuongDisplay}</td>
            <td class="px-3 py-2 whitespace-nowrap text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${loaiClass}">${
            notif.loaiThongBao === "khancap" ? "KHẨN CẤP" : "Thường kỳ"
          }</span></td>
        `;
        });
        UI.renderTableRows("notif-history-body", rows);
      }
      function listenForUserNotifications() {
        if (unsubscribeUserNotifsListener) {
          unsubscribeUserNotifsListener();
          unsubscribeUserNotifsListener = null;
        }
        try {
          const colRef = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          const role = currentUserRole;
          const currentUid = auth.currentUser ? auth.currentUser.uid : null;

          const roleRecipients = ["toancongty"];
          if (role === "quanlynhansu") roleRecipients.push("quanlynhansu");
          else if (role === "ketoan") roleRecipients.push("ketoan");
          else if (role === "giamdoc") roleRecipients.push("giamdoc"); // Bổ sung giám đốc

          const targetRecipients = [...roleRecipients, currentUid].slice(0, 10); // Firestore 'in' array limit precaution

          const q = query(
            colRef,
            where("doiTuongNhan", "in", targetRecipients)
          );
          unsubscribeUserNotifsListener = onSnapshot(
            q,
            (snap) => {
              const notifications = [];
              snap.forEach((d) =>
                notifications.push({ id: d.id, ...d.data() })
              );
              notifications.sort(
                (a, b) => new Date(b.ngayGui) - new Date(a.ngayGui)
              );
              renderUserNotifications(notifications);
            },
            (err) => {
              console.error("listenForUserNotifications error:", err);
              const el = document.getElementById("user-notifications-list");
              if (el)
                el.innerHTML = `<p class="text-center py-8 text-red-500">Lỗi tải thông báo: ${err.message}</p>`;
            }
          );
        } catch (e) {
          console.error("listenForUserNotifications setup error:", e);
        }
      }

      function renderUserNotifications(notifications) {
        const listContainer = document.getElementById(
          "user-notifications-list"
        );
        if (!listContainer) return;
        listContainer.innerHTML = "";
        if (!notifications || notifications.length === 0) {
          listContainer.innerHTML = `<p class="text-center py-8 text-gray-500">Hiện tại không có thông báo nào dành cho vai trò của bạn.</p>`;
          return;
        }
        // render cards
        const frag = document.createDocumentFragment();
        notifications.forEach((notif) => {
          const isUrgent = notif.loaiThongBao === "khancap";
          const card = document.createElement("div");
          card.className = `p-4 rounded-lg shadow-md ${
            isUrgent
              ? "border-l-4 border-red-500 bg-red-50"
              : "border-l-4 border-blue-500 bg-blue-50"
          }`;
          const titleClass = isUrgent
            ? "text-red-700 font-extrabold"
            : "text-blue-700 font-bold";
          let doiTuongDisplay =
            recipientNames[notif.doiTuongNhan] || notif.doiTuongNhan;
          if (
            notif.doiTuongNhan ===
            (auth.currentUser ? auth.currentUser.uid : null)
          )
            doiTuongDisplay = "Cá nhân bạn (Điều động)";

          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h4 class="text-lg ${titleClass}">${notif.tieuDe}</h4>
                <span class="text-xs text-gray-500 whitespace-nowrap">${
                  isUrgent ? "KHẨN CẤP | " : ""
                } ${UI.formatDate(notif.ngayGui)}</span>
            </div>
            <p class="text-sm text-gray-800 whitespace-pre-wrap">${(
              notif.noiDung || ""
            ).replace(/\n/g, "<br>")}</p>
            <p class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">Mã: ${
              notif.matb
            } | Nhận cho: ${doiTuongDisplay}</p>
        `;
          frag.appendChild(card);
        });
        listContainer.appendChild(frag);
      }

      // Hàm giả định cho các phần tử UI chưa được định nghĩa
      // (openSalaryModal/closeSalaryModal và các hàm của modal báo cáo lương không được định nghĩa ở đây)

      // window.openSalaryModal = function() { safeShow('salary-modal'); /* load salary history logic */ }
      // window.closeSalaryModal = function() { safeHide('salary-modal'); }
      // ---------------------------
      // 12) LISTEN TO ROLE CHANGES (onAuthStateChanged)
      // ---------------------------
      function listenForUserRole(uid) {
        if (unsubscribeRoleListener) {
          unsubscribeRoleListener();
          unsubscribeRoleListener = null;
        }
        try {
          const userDocRef = doc(
            db,
            `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
          );
          unsubscribeRoleListener = onSnapshot(
            userDocRef,
            (docSnap) => {
              const currentRoleEl = document.getElementById("current-role");
              const openBtn = document.getElementById("open-management-btn");
              const accountingBtn = document.getElementById(
                "open-accounting-btn"
              );
              const currentDeptSpan = document.getElementById(
                "current-department"
              )
                ? document
                    .getElementById("current-department")
                    .querySelector("span")
                : null;

              if (docSnap.exists()) {
                const data = docSnap.data();
                const roleKey = data.role || "nhanvien";
                const deptKey = data.phongBan || "N/A";
                currentUserRole = roleKey;
                if (currentRoleEl)
                  currentRoleEl.textContent =
                    roleNames[roleKey] || "Vai trò không xác định";
                if (currentDeptSpan)
                  currentDeptSpan.textContent =
                    departmentNames[deptKey] || "Chưa phân công";
                if (roleKey === "giamdoc") openBtn.classList.remove("hidden");
                else openBtn.classList.add("hidden");
                // show accounting button for giamdoc and ketoan
                if (roleKey === "giamdoc" || roleKey === "ketoan")
                  accountingBtn.classList.remove("hidden");
                else accountingBtn.classList.add("hidden");
                if (roleKey !== "giamdoc") {
                  safeHide("system-management-view");
                  safeHide("user-management-view");
                  safeHide("notification-management-view");
                  safeHide("personnel-deployment-view");
                }
              } else {
                if (currentRoleEl)
                  currentRoleEl.textContent = "Đang thiết lập vai trò...";
                if (currentDeptSpan)
                  currentDeptSpan.textContent = "Đang thiết lập...";
                saveUserProfile(
                  uid,
                  auth.currentUser ? auth.currentUser.email : "unknown",
                  "nhanvien"
                );
              }
            },
            (err) => {
              console.error("listenForUserRole error:", err);
              UI.displayMessage(
                "Không thể tải vai trò người dùng (kiểm tra Firestore).",
                "error"
              );
            }
          );
        } catch (e) {
          console.error("listenForUserRole setup error:", e);
        }
      }

      onAuthStateChanged(auth, (user) => {
        const authView = document.getElementById("auth-view");
        const mainAppView = document.getElementById("main-app-view");
        if (user) {
          if (authView) authView.classList.add("hidden");
          if (mainAppView) mainAppView.classList.remove("hidden");
          const uemail = document.getElementById("user-email");
          const uuid = document.getElementById("user-uid");
          if (uemail) uemail.textContent = user.email;
          if (uuid) uuid.textContent = user.uid;
          listenForUserRole(user.uid);
        } else {
          if (authView) authView.classList.remove("hidden");
          if (mainAppView) mainAppView.classList.add("hidden");
          // unsubscribe everything on signout
          if (unsubscribeRoleListener) {
            unsubscribeRoleListener();
            unsubscribeRoleListener = null;
          }
          if (unsubscribeUserListListener) {
            unsubscribeUserListListener();
            unsubscribeUserListListener = null;
          }
          if (unsubscribeNotifHistoryListener) {
            unsubscribeNotifHistoryListener();
            unsubscribeNotifHistoryListener = null;
          }
          if (unsubscribeUserNotifsListener) {
            unsubscribeUserNotifsListener();
            unsubscribeUserNotifsListener = null;
          }
          if (unsubscribePersonnelListListener) {
            unsubscribePersonnelListListener();
            unsubscribePersonnelListListener = null;
          }
        }
      });

      /* ============================
         END OF JS CODE
         ============================ */
      /* ============================
   HR / PROFILE / REQUESTS MODULE
   (Đã gộp toàn bộ logic của bạn và giữ nguyên)
   ============================ */

      /* ============================
   HR / PROFILE / REQUESTS MODULE
   (Đã gộp toàn bộ logic của bạn và giữ nguyên)
   ============================ */
      /* ============================
   HR / PROFILE / REQUESTS MODULE
   (Đã gộp toàn bộ logic của bạn và giữ nguyên)
   ============================ */

      /* ============================
   HR / PROFILE / REQUESTS MODULE
   (Đã gộp toàn bộ logic của bạn và giữ nguyên)
   ============================ */
      // helpers for DOM
      // Biến toàn cục (đã giả định tồn tại trong môi trường của bạn)
      // const auth = firebase.auth();
      // const db = firebase.firestore();
      // const rtdb = firebase.database();
      // const firebaseConfig = {...};
      // const currentUserRole = '...'; // Giả sử biến này được cập nhật khi đăng nhập
      // const roleNames = { 'giamdoc': 'Giám đốc', 'quanlynhansu': 'Quản lý Nhân sự', 'nhanvien': 'Nhân viên', ... };
      // const departmentNames = { 'hanhchinh': 'Phòng Hành chính - Nhân sự', 'ketoan': 'Phòng Kế toán - Tài chính', ... };

      // Biến toàn cục (giả định tồn tại trong môi trường của bạn)
      // const auth = firebase.auth();
      // const db = firebase.firestore();
      // const rtdb = firebase.database();
      // const firebaseConfig = {...};
      // const currentUserRole = '...'; // Giả sử biến này được cập nhật khi đăng nhập
      // const roleNames = { 'giamdoc': 'Giám đốc', 'quanlynhansu': 'Quản lý Nhân sự', 'nhanvien': 'Nhân viên', ... };
      // const departmentNames = { 'hanhchinh': 'Phòng Hành chính - Nhân sự', 'ketoan': 'Phòng Kế toán - Tài chính', ... };
      // const UI = { displayMessage: (msg, type) => console.log(`[UI] ${type}: ${msg}`) }; // Giả lập UI nếu chưa có

      // helpers for DOM

      // --- HELPER FUNCTION: CREATE INITIALS AVATAR ---
      // (Giữ nguyên)
      const $ = (id) => document.getElementById(id);

      // --- HELPER FUNCTION: CREATE INITIALS AVATAR ---
      // (Giữ nguyên)
      function createAvatarFromInitials(name) {
        if (!name || typeof name !== "string") return "";
        const parts = name.trim().split(/\s+/);
        let initials = ""; // Lấy chữ cái đầu tiên của từ cuối cùng (tên)
        if (parts.length > 0) {
          initials = parts[parts.length - 1].charAt(0).toUpperCase();
        } // Hàm này giả định tạo ra một Data URL cho ảnh placeholder.
        const size = 100;
        const bgColor =
          "hsl(" + Math.floor(Math.random() * 360) + ", 60%, 70%)"; // Màu ngẫu nhiên
        const textColor = "#fff";

        const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
        <rect width="${size}" height="${size}" fill="${bgColor}" />
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="${
          size * 0.5
        }" fill="${textColor}" font-family="Arial, sans-serif">${initials}</text>
    </svg>`;
        return "data:image/svg+xml;base64," + btoa(svg);
      }

      // ---------------------------
      // PROFILE: open/close & render
      // ---------------------------
      // (Giữ nguyên)
      window.openProfileModal = async function (uid = null) {
        // if uid not provided, use auth.currentUser
        const user = auth.currentUser;
        if (!user && !uid) {
          UI.displayMessage("Vui lòng đăng nhập để xem thông tin.", "error");
          return;
        }
        const targetUid = uid || (user ? user.uid : null); // 1. Lấy Profile từ Firestore

        let profile = null;
        let targetEmail = null;
        try {
          const snap = await getDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${targetUid}`
            )
          );
          if (snap.exists()) {
            profile = snap.data();
            targetEmail =
              profile.email ||
              (user && user.uid === targetUid ? user.email : null);
          } else {
            targetEmail = user && user.uid === targetUid ? user.email : null;
          }
        } catch (e) {
          console.error("openProfileModal get profile error", e);
        } // 2. Định nghĩa các tài khoản đặc biệt cho ảnh
        const SPECIAL_AVATAR_USERS = {
          "quyen2@gmail.com":
            "https://sf-static.upanhlaylink.com/img/image_202510257ffd7d6e7976a9a7c173360632b896ac.jpg",
          "doanbao398@gmail.com":
            "https://sf-static.upanhlaylink.com/img/image_20251025eaa28626a01c0bf6e526a81832e1e498.jpg",
        }; // 3. Xử lý dữ liệu Profile (Ưu tiên DB, thiếu thì "Chờ cập nhật")
        const hoTen = profile && profile.hoTen ? profile.hoTen : "Chờ cập nhật";
        const mans = profile && profile.mans ? profile.mans : "Chờ cập nhật"; // Dùng roleName/departmentNames nếu có, không thì dùng giá trị thô hoặc "Chờ cập nhật"
        const roleText =
          profile && profile.role
            ? typeof roleNames !== "undefined"
              ? roleNames[profile.role] || profile.role
              : profile.role
            : "Chờ cập nhật";
        const deptText =
          profile && profile.phongBan
            ? typeof departmentNames !== "undefined"
              ? departmentNames[profile.phongBan] || profile.phongBan
              : profile.phongBan
            : "Chờ cập nhật";
        const duAn = profile && profile.duAn ? profile.duAn : "Chờ cập nhật";
        const ngaySinh =
          profile && profile.ngaySinh ? profile.ngaySinh : "Chờ cập nhật";
        const gioiTinh =
          profile && profile.gioiTinh ? profile.gioiTinh : "Chờ cập nhật";
        const ngayVaoLam =
          profile && profile.ngayVaoLam ? profile.ngayVaoLam : "Chờ cập nhật"; // 4. Thiết lập Avatar

        let avatarUrl = "";
        if (targetEmail && SPECIAL_AVATAR_USERS[targetEmail]) {
          // Ưu tiên ảnh đặc biệt
          avatarUrl = SPECIAL_AVATAR_USERS[targetEmail];
          $("profile-avatar").classList.remove("hidden");
        } else if (profile && profile.photoURL) {
          // Nếu có ảnh trong DB (photoURL)
          avatarUrl = profile.photoURL;
          $("profile-avatar").classList.remove("hidden");
        } else if (hoTen !== "Chờ cập nhật") {
          // Tạo ảnh chữ cái nếu có tên
          avatarUrl = createAvatarFromInitials(hoTen);
          $("profile-avatar").classList.remove("hidden");
        } else {
          // Ẩn nếu không có dữ liệu gì (hoTen là "Chờ cập nhật")
          $("profile-avatar").classList.add("hidden");
          avatarUrl = "";
        } // 5. Cập nhật DOM

        $("profile-avatar").src = avatarUrl;
        $("profile-name").textContent = `HỌ TÊN: ${hoTen}`;
        $("profile-mans").textContent = mans;
        $("profile-role").textContent = roleText;
        $("profile-dept").textContent = deptText;
        $("profile-project").textContent = duAn;
        $("profile-dob").textContent = ngaySinh;
        $("profile-gender").textContent = gioiTinh;
        $("profile-join").textContent = ngayVaoLam;
        $("profile-perm").textContent = roleText; // Quyền hạn thường là vai trò/chức vụ // show modal

        $("profile-modal").classList.remove("hidden");
      };

      window.closeProfileModal = function () {
        $("profile-modal").classList.add("hidden");
      };
      // ---------------------------
      // EMPLOYEE REGISTER (Leave / OT)
      // ---------------------------
      // (Giữ nguyên)
      window.openEmployeeRegisterModal = function () {
        if (!auth.currentUser)
          return UI.displayMessage(
            "Vui lòng đăng nhập để gửi đăng ký.",
            "error"
          ); // prefill name and mans if available
        (async () => {
          try {
            const uid = auth.currentUser.uid;
            const snap = await getDoc(
              doc(
                db,
                `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
              )
            );
            const p = snap && snap.exists() ? snap.data() : null;
            if (p) {
              $("leave-mans").value = p.mans || "";
              $("leave-name").value = p.hoTen || auth.currentUser.email;
              $("ot-mans").value = p.mans || "";
              $("ot-name").value = p.hoTen || auth.currentUser.email;
            } else {
              $("leave-name").value = auth.currentUser.email;
              $("ot-name").value = auth.currentUser.email;
            }
          } catch (e) {
            console.warn(e);
          }
        })();

        $("employee-register-modal").classList.remove("hidden");
      };

      window.closeEmployeeRegisterModal = function () {
        $("employee-register-modal").classList.add("hidden");
      };

      window.showEmployeeRegisterForm = function (type) {
        $("employee-leave-form").classList.add("hidden");
        $("employee-ot-form").classList.add("hidden"); // Cập nhật style nút tab
        const leaveBtn = document.querySelector(
          "[onclick=\"showEmployeeRegisterForm('leave')\"]"
        );
        const otBtn = document.querySelector(
          "[onclick=\"showEmployeeRegisterForm('ot')\"]"
        );
        if (type === "leave") {
          $("employee-leave-form").classList.remove("hidden");
          leaveBtn.classList.add("bg-indigo-600", "text-white");
          leaveBtn.classList.remove("bg-gray-200", "text-gray-700");
          otBtn.classList.remove("bg-indigo-600", "text-white");
          otBtn.classList.add("bg-gray-200", "text-gray-700");
        } else {
          $("employee-ot-form").classList.remove("hidden");
          otBtn.classList.add("bg-indigo-600", "text-white");
          otBtn.classList.remove("bg-gray-200", "text-gray-700");
          leaveBtn.classList.remove("bg-indigo-600", "text-white");
          leaveBtn.classList.add("bg-gray-200", "text-gray-700");
        }
      };

      window.submitLeaveRequest = async function (e) {
        e.preventDefault();
        if (!auth.currentUser)
          return UI.displayMessage("Vui lòng đăng nhập.", "error");
        const mans = $("leave-mans").value.trim() || "Chờ cập nhật";
        const hoTen = $("leave-name").value.trim() || auth.currentUser.email;
        const ngayBD = $("leave-start").value;
        const ngayKT = $("leave-end").value;
        const lyDo = $("leave-reason").value.trim() || "";
        if (!ngayBD || !ngayKT)
          return UI.displayMessage(
            "Vui lòng chọn ngày bắt đầu và kết thúc.",
            "error"
          );

        try {
          const key = encodeEmailKey(auth.currentUser.email);
          const id = `L_${Date.now()}`;
          await dbSet(dbRef(rtdb, `/DonTu/Nghi/${key}/${id}`), {
            id,
            mans,
            hoTen,
            ngayBatDau: ngayBD,
            ngayKetThuc: ngayKT,
            lyDo,
            trangThai: "Chờ duyệt",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.email,
          });
          UI.displayMessage(
            "Đơn xin nghỉ đã gửi đến Quản lý nhân sự.",
            "success"
          );
          closeEmployeeRegisterModal();
        } catch (e) {
          console.error("submitLeaveRequest error", e);
          UI.displayMessage("Lỗi gửi đơn.", "error");
        }
      };

      window.submitOTRequest = async function (e) {
        e.preventDefault();
        if (!auth.currentUser)
          return UI.displayMessage("Vui lòng đăng nhập.", "error");
        const mans = $("ot-mans").value.trim() || "Chờ cập nhật";
        const hoTen = $("ot-name").value.trim() || auth.currentUser.email;
        const ngay = $("ot-date").value;
        const soGio = parseInt($("ot-hours").value || "0", 10);
        if (!ngay || soGio <= 0)
          return UI.displayMessage("Vui lòng nhập ngày và số giờ.", "error");

        try {
          const key = encodeEmailKey(auth.currentUser.email);
          const id = `OT_${Date.now()}`;
          await dbSet(dbRef(rtdb, `/DonTu/TangCa/${key}/${id}`), {
            id,
            mans,
            hoTen,
            ngay,
            soGio,
            trangThai: "Chờ duyệt",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.email,
          });
          UI.displayMessage(
            "Đơn tăng ca đã gửi đến Quản lý nhân sự.",
            "success"
          );
          closeEmployeeRegisterModal();
        } catch (e) {
          console.error("submitOTRequest error", e);
          UI.displayMessage("Lỗi gửi đơn.", "error");
        }
      };

      // ---------------------------
      // HR MANAGEMENT: open/close & tabs
      // ---------------------------
      // Biến để lưu hàm hủy lắng nghe (unsubscribe function)
      let _hrListUnsubscribe = null;

      window.openHRManagementView = function () {
        if (!auth.currentUser)
          return UI.displayMessage("Vui lòng đăng nhập.", "error"); // only for giamdoc or quanlynhansu
        if (
          !(currentUserRole === "giamdoc" || currentUserRole === "quanlynhansu")
        ) {
          UI.displayMessage(
            "Bạn không có quyền truy cập Quản lý nhân sự.",
            "error"
          );
          return;
        }
        $("hr-management-view").classList.remove("hidden");
        showHRTab("update"); // THAY THẾ loadHRUserList() bằng Realtime Listener
        if (_hrListUnsubscribe === null) {
          _hrListUnsubscribe = setupHRUserListListener();
        }
        loadHRRequests();
        updateHRStatusList();
      };

      window.closeHRManagementView = function () {
        $("hr-management-view").classList.add("hidden"); // HỦY LISTENER KHI ĐÓNG GIAO DIỆN
        if (_hrListUnsubscribe) {
          _hrListUnsubscribe();
          _hrListUnsubscribe = null;
        }
      };

      window.showHRTab = function (tab) {
        const tabs = ["update", "requests", "status", "report"];
        tabs.forEach((t) => {
          $("hr-tab-" + t + (t === "update" ? "" : "-panel")).classList.add(
            "hidden"
          ); // safe hide // show button styles
          const btn = $("hr-tab-" + t);
          if (btn) {
            if (t === tab) {
              btn.classList.remove(
                "bg-gray-100",
                "text-gray-600",
                "hover:bg-gray-200"
              );
              btn.classList.add("bg-indigo-600", "text-white");
            } else {
              btn.classList.add(
                "bg-gray-100",
                "text-gray-600",
                "hover:bg-gray-200"
              );
              btn.classList.remove("bg-indigo-600", "text-white");
            }
          }
        }); // show correct panel
        if (tab === "update")
          $("hr-tab-update-panel").classList.remove("hidden");
        if (tab === "requests")
          $("hr-tab-requests-panel").classList.remove("hidden");
        if (tab === "status")
          $("hr-tab-status-panel").classList.remove("hidden");
        if (tab === "report")
          $("hr-tab-report-panel").classList.remove("hidden");
      };

      // ---------------------------
      // HR: Realtime User List Listener
      // ---------------------------
      let _hrUserListCache = [];

      /**
       * Thiết lập Listener để theo dõi thay đổi danh sách nhân sự trong Firestore
       */
      function setupHRUserListListener() {
        // Đọc Collection user_profiles
        const colRef = collection(
          db,
          `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
        );

        // onSnapshot là hàm trả về một hàm hủy lắng nghe (unsubscribe function)
        const unsubscribe = onSnapshot(
          colRef,
          (snapshot) => {
            const users = [];
            snapshot.forEach((d) =>
              users.push({ uid: d.id, ...(d.data() || {}) })
            );
            _hrUserListCache = users;
            renderHRUserList(users);
            // UI.displayMessage("Danh sách nhân sự đã được cập nhật tự động (Realtime).", "info");
          },
          (error) => {
            console.error("User List Listener error", error);
            const el = $("hr-user-list-body");
            if (el)
              el.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Lỗi tải danh sách tự động: ${error.message}</td></tr>`;
          }
        );

        return unsubscribe;
      }

      function renderHRUserList(users) {
        const body = $("hr-user-list-body");
        if (!body) return;
        if (!Array.isArray(users) || users.length === 0) {
          body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Chưa có người dùng.</td></tr>`;
          return;
        }
        const rows = users
          .map((u) => {
            const mans = u.mans || "Chờ cập nhật";
            const hoten = u.hoTen || "Chờ cập nhật";
            const dept = departmentNames[u.phongBan] || u.phongBan || "";
            const emailCell = u.email || ""; // THÊM NÚT XÓA VÀO CỘT THAO TÁC
            const actionBtn = `
        <div class="flex space-x-2 justify-center">
          <button onclick="openHREditProfileModal('${u.uid}')" class="py-1 px-3 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition-colors">Chỉnh sửa</button>
          <button onclick="hrDeleteProfile('${u.uid}', '${hoten}')" class="py-1 px-3 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors">Xóa</button>
        </div>
    `;
            return `
      <tr>
        <td class="px-6 py-3 text-gray-900">${emailCell}</td>
        <td class="px-6 py-3 text-gray-800">${mans}</td>
        <td class="px-6 py-3 text-gray-800">${hoten}</td>
        <td class="px-6 py-3 text-gray-800">${dept}</td>
        <td class="px-6 py-3 text-center">${actionBtn}</td>
      </tr>
    `;
          })
          .join("");
        body.innerHTML = rows;
      }

      // ---------------------------
      // HR: Xóa hồ sơ (BỔ SUNG LOGIC)
      // ---------------------------
      window.hrDeleteProfile = async function (uid, hoTen) {
        if (
          !confirm(
            `Bạn có chắc chắn muốn xóa hồ sơ của "${hoTen}" (UID: ${uid})? Hành động này không thể hoàn tác.`
          )
        ) {
          return;
        }
        try {
          // 1. Xóa hồ sơ trong public data (Firestore)
          await deleteDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
            )
          ); // 2. (Tùy chọn) Xóa hồ sơ trong private data (Firestore) // Đây là bước thêm vào để đảm bảo sự đồng bộ và sạch sẽ.
          await deleteDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
            )
          );
          UI.displayMessage(
            `Đã xóa hồ sơ của ${hoTen} thành công. Danh sách sẽ tự động cập nhật.`,
            "success"
          ); // Không cần gọi lại render vì Realtime Listener (onSnapshot) sẽ tự động kích hoạt
        } catch (e) {
          console.error("hrDeleteProfile error", e);
          UI.displayMessage(
            "Lỗi xóa hồ sơ. Vui lòng kiểm tra quyền truy cập Firebase.",
            "error"
          );
        }
      };

      // ---------------------------
      // HR: Edit profile modal (prefill & save)
      // ---------------------------
      // (Giữ nguyên)
      window.openHREditProfileModal = async function (uid) {
        const p = _hrUserListCache.find((x) => x.uid === uid) || null;
        if (!p) {
          UI.displayMessage("Không tìm thấy người dùng.", "error");
          return;
        }
        $("edit-uid").value = p.uid;
        $("edit-mans").value = p.mans || "";
        $("edit-name").value = p.hoTen || "";
        $("edit-role").value = p.role || "nhanvien";
        $("edit-dept").value = p.phongBan || "";
        $("edit-project").value = p.duAn || "";
        $("edit-dob").value = p.ngaySinh || "";
        $("edit-gender").value = p.gioiTinh || "";
        $("edit-join").value = p.ngayVaoLam || "";
        $("hr-edit-profile-modal").classList.remove("hidden");
      };

      window.closeHREditProfileModal = function () {
        $("hr-edit-profile-modal").classList.add("hidden");
      };

      window.saveHREditedProfile = async function () {
        const uid = $("edit-uid").value;
        if (!uid) return UI.displayMessage("UID không hợp lệ.", "error");
        const data = {
          mans: $("edit-mans").value.trim() || null,
          hoTen: $("edit-name").value.trim() || null,
          role: $("edit-role").value || null,
          phongBan: $("edit-dept").value.trim() || null,
          duAn: $("edit-project").value.trim() || null,
          ngaySinh: $("edit-dob").value || null,
          gioiTinh: $("edit-gender").value || null,
          ngayVaoLam: $("edit-join").value || null,
          updatedAt: new Date().toISOString(),
        };
        try {
          // write to public profile doc (merge)
          await setDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles/${uid}`
            ),
            data,
            { merge: true }
          ); // also update private profile if exists
          await setDoc(
            doc(
              db,
              `artifacts/${firebaseConfig.projectId}/users/${uid}/user_data/profile`
            ),
            data,
            { merge: true }
          );
          UI.displayMessage("Cập nhật thông tin thành công.", "success");
          closeHREditProfileModal(); // KHÔNG CẦN loadHRUserList() vì Realtime Listener đã lo việc cập nhật
        } catch (e) {
          console.error("saveHREditedProfile error", e);
          UI.displayMessage("Lỗi lưu thông tin.", "error");
        }
      };

      // ---------------------------
      // HR: Load requests (using RTDB reads)
      // ---------------------------
      // (Giữ nguyên)
      async function loadHRRequests() {
        try {
          // load all leave requests
          const leaveSnap = await dbGet(dbRef(rtdb, `/DonTu/Nghi`));
          const leaveHtml = [];
          if (leaveSnap.exists()) {
            const all = leaveSnap.val();
            for (const emailKey in all) {
              const userRequests = all[emailKey];
              for (const id in userRequests) {
                const r = userRequests[id];
                if (!r) continue;
                if (r.trangThai === "Chờ duyệt") {
                  leaveHtml.push(renderLeaveRowHTML(emailKey, id, r));
                }
              }
            }
          }
          $("hr-leave-list").innerHTML = leaveHtml.length
            ? leaveHtml.join("")
            : `<p class="text-center py-6 text-gray-500">Không có đơn xin nghỉ đang chờ duyệt.</p>`; // load OT requests

          const otSnap = await dbGet(dbRef(rtdb, `/DonTu/TangCa`));
          const otHtml = [];
          if (otSnap.exists()) {
            const all = otSnap.val();
            for (const emailKey in all) {
              const userRequests = all[emailKey];
              for (const id in userRequests) {
                const r = userRequests[id];
                if (!r) continue;
                if (r.trangThai === "Chờ duyệt") {
                  otHtml.push(renderOTRowHTML(emailKey, id, r));
                }
              }
            }
          }
          $("hr-ot-list").innerHTML = otHtml.length
            ? otHtml.join("")
            : `<p class="text-center py-6 text-gray-500">Không có đơn tăng ca đang chờ duyệt.</p>`;
        } catch (e) {
          console.error("loadHRRequests error", e);
        }
      }

      function renderLeaveRowHTML(emailKey, id, r) {
        const email = emailKey.replace(/,/g, ".");
        const approveBtn = `<button onclick="hrApproveLeave('${emailKey}','${id}')" class="py-1 px-3 bg-emerald-600 text-white text-xs rounded-lg hover:bg-emerald-700 transition-colors">Duyệt</button>`;
        const rejectBtn = `<button onclick="hrRejectLeave('${emailKey}','${id}')" class="py-1 px-3 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors">Từ chối</button>`;
        return `<div class="p-3 border-b border-red-200 hover:bg-red-100 transition-colors rounded-lg"><div class="flex justify-between items-center"><div><b class="text-red-800">${
          r.hoTen || email
        }</b> (${
          r.mans || "N/A"
        })<div class="text-xs text-gray-500 mt-0.5">🗓️ Từ ${r.ngayBatDau} → ${
          r.ngayKetThuc
        }</div><div class="text-xs mt-1 text-gray-600 truncate max-w-sm">Lý do: ${
          r.lyDo || "N/A"
        }</div></div><div class="space-x-2 flex-shrink-0">${approveBtn}${rejectBtn}</div></div></div>`;
      }

      function renderOTRowHTML(emailKey, id, r) {
        const email = emailKey.replace(/,/g, ".");
        const approveBtn = `<button onclick="hrApproveOT('${emailKey}','${id}')" class="py-1 px-3 bg-emerald-600 text-white text-xs rounded-lg hover:bg-emerald-700 transition-colors">Duyệt</button>`;
        const rejectBtn = `<button onclick="hrRejectOT('${emailKey}','${id}')" class="py-1 px-3 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors">Từ chối</button>`;
        return `<div class="p-3 border-b border-blue-200 hover:bg-blue-100 transition-colors rounded-lg"><div class="flex justify-between items-center"><div><b class="text-blue-800">${
          r.hoTen || email
        }</b> (${
          r.mans || "N/A"
        })<div class="text-xs text-gray-500 mt-0.5">📅 Ngày: ${
          r.ngay
        } | ⏳ Giờ: ${
          r.soGio
        }</div></div><div class="space-x-2 flex-shrink-0">${approveBtn}${rejectBtn}</div></div></div>`;
      }

      // Approve / Reject handlers
      // (Giữ nguyên)
      window.hrApproveLeave = async function (emailKey, id) {
        try {
          const refPath = `/DonTu/Nghi/${emailKey}/${id}`;
          await dbSet(dbRef(rtdb, refPath + "/trangThai"), "Đã duyệt"); // simple set of status field // also set a status record for user (for tracking)
          const email = emailKey.replace(/,/g, "."); // send notification via Firestore
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `L${Date.now().toString().slice(-6)}`,
            tieuDe: "Kết quả duyệt đơn nghỉ",
            noiDung: "Đơn xin nghỉ của bạn đã được duyệt.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email, // if profile stores uid instead use uid
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("Đã duyệt đơn xin nghỉ.", "success"); // refresh requests and status list
          await loadHRRequests();
          await updateHRStatusList();
        } catch (e) {
          console.error("hrApproveLeave error", e);
          UI.displayMessage("Lỗi duyệt đơn.", "error");
        }
      };

      window.hrRejectLeave = async function (emailKey, id) {
        try {
          await dbSet(
            dbRef(rtdb, `/DonTu/Nghi/${emailKey}/${id}/trangThai`),
            "Từ chối"
          );
          const email = emailKey.replace(/,/g, ".");
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `L${Date.now().toString().slice(-6)}`,
            tieuDe: "Kết quả duyệt đơn nghỉ",
            noiDung: "Đơn xin nghỉ của bạn đã bị từ chối.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("Đã từ chối đơn xin nghỉ.", "info");
          await loadHRRequests();
        } catch (e) {
          console.error("hrRejectLeave error", e);
        }
      };

      window.hrApproveOT = async function (emailKey, id) {
        try {
          await dbSet(
            dbRef(rtdb, `/DonTu/TangCa/${emailKey}/${id}/trangThai`),
            "Đã duyệt"
          );
          const email = emailKey.replace(/,/g, ".");
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `OT${Date.now().toString().slice(-6)}`,
            tieuDe: "Kết quả duyệt đơn tăng ca",
            noiDung: "Đơn tăng ca của bạn đã được duyệt.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("Đã duyệt đơn tăng ca.", "success");
          await loadHRRequests();
          await updateHRStatusList();
        } catch (e) {
          console.error("hrApproveOT error", e);
        }
      };

      window.hrRejectOT = async function (emailKey, id) {
        try {
          await dbSet(
            dbRef(rtdb, `/DonTu/TangCa/${emailKey}/${id}/trangThai`),
            "Từ chối"
          );
          const email = emailKey.replace(/,/g, ".");
          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `OT${Date.now().toString().slice(-6)}`,
            tieuDe: "Kết quả duyệt đơn tăng ca",
            noiDung: "Đơn tăng ca của bạn đã bị từ chối.",
            ngayGui: new Date().toISOString().split("T")[0],
            doiTuongNhan: email,
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });
          UI.displayMessage("Đã từ chối đơn tăng ca.", "info");
          await loadHRRequests();
        } catch (e) {
          console.error("hrRejectOT error", e);
        }
      };

      // ---------------------------
      // HR: Update status list (scan RTDB for approved requests)
      // ---------------------------
      // (Giữ nguyên)
      async function updateHRStatusList() {
        try {
          const usersSnap = await getDocs(
            collection(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
            )
          );
          const users = [];
          usersSnap.forEach((d) =>
            users.push({ uid: d.id, ...(d.data() || {}) })
          ); // default status map

          const statusMap = {};
          users.forEach((u) => {
            if ((u.role || "") === "nhanvien")
              statusMap[u.email || `${u.uid}@unknown`] = "Bình thường";
          }); // scan leaves

          const leaveSnap = await dbGet(dbRef(rtdb, `/DonTu/Nghi`));
          if (leaveSnap.exists()) {
            const all = leaveSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "Đã duyệt") {
                  const email = emailKey.replace(/,/g, ".");
                  statusMap[email] = "Đang nghỉ";
                }
              }
            }
          } // scan OT
          const otSnap = await dbGet(dbRef(rtdb, `/DonTu/TangCa`));
          if (otSnap.exists()) {
            const all = otSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "Đã duyệt") {
                  const email = emailKey.replace(/,/g, "."); // If already Dang nghi, keep it; otherwise set Dang tang ca
                  if (statusMap[email] !== "Đang nghỉ")
                    statusMap[email] = "Đang tăng ca";
                }
              }
            }
          }

          const rows = [];
          for (const u of users) {
            if ((u.role || "") !== "nhanvien") continue;
            const email = u.email || "";
            const mans = u.mans || "Chờ cập nhật";
            const hoten = u.hoTen || "Chờ cập nhật";
            const st = statusMap[email] || "Bình thường";
            const statusColor =
              st === "Đang nghỉ"
                ? "bg-red-100 text-red-700"
                : st === "Đang tăng ca"
                ? "bg-blue-100 text-blue-700"
                : "bg-green-100 text-green-700";
            rows.push(`
        <tr>
            <td class="px-6 py-3">${email}</td>
            <td class="px-6 py-3">${mans}</td>
            <td class="px-6 py-3">${hoten}</td>
            <td class="px-6 py-3"><span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">${st}</span></td>
        </tr>
      `);
          }
          const finalRows = rows.length
            ? rows.join("")
            : `<tr><td colspan="4" class="text-center py-6 text-gray-500">Chưa có nhân viên.</td></tr>`; // UI.renderTableRows("hr-status-body", rows.length ? rows : [`<tr><td colspan="4" class="text-center py-6 text-gray-500">Chưa có nhân viên.</td></tr>`]);
          $("hr-status-body").innerHTML = finalRows;
        } catch (e) {
          console.error("updateHRStatusList error", e);
        }
      }

      // ---------------------------
      // HR: Generate report
      // ---------------------------
      // (Giữ nguyên)
      window.hrGenerateReport = async function () {
        try {
          const date =
            $("hr-report-date").value || new Date().toISOString().split("T")[0];
          const title = $("hr-report-title").value || `Báo cáo nhân sự ${date}`; // gather status counts from updateHRStatusList logic but reuse code // Let's reconstruct counts quickly
          const usersSnap = await getDocs(
            collection(
              db,
              `artifacts/${firebaseConfig.projectId}/public/data/user_profiles`
            )
          );
          const users = [];
          usersSnap.forEach((d) =>
            users.push({ uid: d.id, ...(d.data() || {}) })
          );
          let totalNV = 0,
            dangNghi = 0,
            dangOT = 0;
          const statusMap = {}; // default set
          users.forEach((u) => {
            if ((u.role || "") === "nhanvien") {
              totalNV++;
              statusMap[u.email || ""] = "Bình thường";
            }
          });
          const leaveSnap = await dbGet(dbRef(rtdb, `/DonTu/Nghi`));
          if (leaveSnap.exists()) {
            const all = leaveSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "Đã duyệt") {
                  const email = emailKey.replace(/,/g, ".");
                  statusMap[email] = "Đang nghỉ";
                }
              }
            }
          }
          const otSnap = await dbGet(dbRef(rtdb, `/DonTu/TangCa`));
          if (otSnap.exists()) {
            const all = otSnap.val();
            for (const emailKey in all) {
              const arr = all[emailKey];
              for (const id in arr) {
                const item = arr[id];
                if (item && item.trangThai === "Đã duyệt") {
                  const email = emailKey.replace(/,/g, "."); // Only count OT if they are not already on leave
                  if (statusMap[email] !== "Đang nghỉ")
                    statusMap[email] = "Đang tăng ca";
                }
              }
            }
          }
          for (const k in statusMap) {
            if (statusMap[k] === "Đang nghỉ") dangNghi++;
            else if (statusMap[k] === "Đang tăng ca") dangOT++;
          }

          const reportId = `HRRPT_${Date.now()}`;
          await dbSet(dbRef(rtdb, `/BaoCaoNhanSu/${reportId}`), {
            reportId,
            date,
            title,
            totalNV,
            dangNghi,
            dangOT,
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
            createdAt: new Date().toISOString(),
          }); // send notification to giamdoc

          const notifColl = collection(
            db,
            `artifacts/${firebaseConfig.projectId}/public/data/notifications`
          );
          await addDoc(notifColl, {
            matb: `HR${Date.now().toString().slice(-6)}`,
            tieuDe: `Báo cáo nhân sự: ${title}`,
            noiDung: `Tổng NV: ${totalNV}. Đang nghỉ: ${dangNghi}. Đang tăng ca: ${dangOT}. Xem chi tiết trong hệ thống.`,
            ngayGui: date,
            doiTuongNhan: "giamdoc",
            loaiThongBao: "thuongky",
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.email : "system",
          });

          $(
            "hr-report-result"
          ).innerHTML = `<p class="text-base font-medium">Báo cáo đã gửi cho Giám đốc.</p><p class="text-sm mt-1">Tổng NV: <b>${totalNV}</b>, Đang nghỉ: <b>${dangNghi}</b>, Đang tăng ca: <b>${dangOT}</b></p>`;
          UI.displayMessage(
            "Báo cáo đã được tạo và gửi cho Giám đốc.",
            "success"
          );
        } catch (e) {
          console.error("hrGenerateReport error", e);
          UI.displayMessage("Lỗi tạo báo cáo.", "error");
        }
      };

      // ---------------------------
      // INITIALIZE: hook buttons visibility into main UI (optional)
      // ---------------------------
      // (Giữ nguyên)
      (function initHRIntegrationButtons() {
        // try to show profile / register / hr buttons in main UI
        const mainButtonsContainer = $("extra-main-buttons");
        const mainAppView = $("main-app-view");
        if (mainAppView) {
          // insert buttons area if header exists
          const headerArea =
            mainAppView.querySelector(".flex.items-center.gap-3") ||
            mainAppView.querySelector(".flex.items-center") ||
            null;
          if (headerArea && mainButtonsContainer) {
            // show profile & register buttons
            mainButtonsContainer.classList.remove("hidden"); // insert the container into header
            headerArea.insertAdjacentElement("afterend", mainButtonsContainer);
          }
        } // show HR management button if currentUserRole is giamdoc or quanlynhansu
        const observer = () => {
          const hrBtn = $("open-hr-mgmt-btn");
          const profileBtn = $("open-profile-btn");
          const regBtn = $("open-employee-register-btn");
          if (profileBtn) profileBtn.classList.remove("hidden");
          if (regBtn) regBtn.classList.remove("hidden");
          if (hrBtn) {
            if (
              currentUserRole === "giamdoc" ||
              currentUserRole === "quanlynhansu"
            )
              hrBtn.classList.remove("hidden");
            else hrBtn.classList.add("hidden");
          }
        }; // run initially and whenever role changes (we already listenForUserRole triggers currentUserRole)
        observer(); // ensure executed later after auth state changes // no need to rebind; instead rely on listenForUserRole's updates (it adjusts currentUserRole) // call observer periodically a few times to catch updates
        setTimeout(observer, 1000);
        setTimeout(observer, 3000);
      })();
      // xem lg //

      // Dữ liệu mock (Cần thiết cho quá trình phát triển/test khi chưa có Auth và RTDB)
      const mockUserEmail = "p@gmail.com";
      const mockRtdbData = {
        PhieuLuong: {
          // Key này mô phỏng p@gmail.com sau khi mã hóa
          "p@gmail,com": {
            PL_1761254454798: {
              createdAt: "2025-10-23T21:20:54.798Z",
              hours: 56,
              luong_cung: 1344000,
              phu_cap: 100000,
              thuong: 100000,
              total: 1544000,
            },
          },
          "truongphangiabao@gmail,com": {
            PL_1771254454798: {
              createdAt: "2025-11-20T21:20:54.798Z",
              hours: 170,
              luong_cung: 5000000,
              phu_cap: 500000,
              thuong: 200000,
              total: 5700000,
            },
          },
          // Thêm một phiếu lương khác cho tài khoản mock
          // Dữ liệu mock không được dùng key kết thúc bằng _2, mà chỉ là email key
          // Để thử nghiệm, tôi thêm dữ liệu này vào p@gmail,com
          "p@gmail,com": {
            // Đã có
            PL_1761254454798: {
              createdAt: "2025-10-23T21:20:54.798Z",
              hours: 56,
              luong_cung: 1344000,
              phu_cap: 100000,
              thuong: 100000,
              total: 1544000,
            },
            // Thêm phiếu thứ 2 vào cùng key
            PL_177254454798: {
              createdAt: "2025-11-25T10:00:00.000Z",
              hours: 150,
              luong_cung: 4500000,
              phu_cap: 300000,
              thuong: 150000,
              total: 4950000,
            },
          },
        },
      };

      // Hàm Hỗ trợ: Mô phỏng việc lấy dữ liệu từ RTDB
      // Thay đổi: Sử dụng dbGet đã được import nếu có sẵn
      window.dbGetMock = function (ref) {
        // Thay vì kiểm tra 'get' (tên gốc), ta kiểm tra 'dbGet' (tên đã đổi)
        // và kiểm tra rtdb. Nếu có, nó là Realtime Database thật.
        if (typeof dbGet === "function" && ref && typeof rtdb !== "undefined") {
          // Trường hợp này không thể xảy ra trong môi trường Canvas do dbGet cần dùng await và trả về Promise
          // nhưng để logic vẫn chạy ổn, ta giả định window.dbGet sẽ được sử dụng cho cả mock và real.
          // Dòng này được giữ lại từ logic cũ của bạn (có thể đã là một wrapper cho dbGet thật)
          return dbGet(ref);
        }

        // Nếu không, sử dụng Mock Data
        // ref có thể là một đối tượng chứa path: { path: '/PhieuLuong/emailkey' }
        const path = ref.path;

        // Logic tìm kiếm key trong mockRtdbData
        const parts = path.split("/");
        let data = mockRtdbData;

        for (const part of parts) {
          if (part === "") continue;

          if (data[part]) {
            data = data[part];
          } else {
            // Nếu không tìm thấy key, trả về snapshot không tồn tại
            return { exists: () => false };
          }
        }

        // Trả về định dạng giống Firebase Snapshot
        return {
          exists: () => data !== null,
          val: () => data,
          path: path,
        };
      };

      // Hàm Hỗ trợ: Định nghĩa thêm các hàm cần thiết trong đối tượng UI
      if (typeof window.UI === "undefined") window.UI = {};

      // Hàm Hỗ trợ UI: Định dạng ngày từ chuỗi ISO
      if (typeof window.UI.formatDate !== "function") {
        window.UI.formatDate = function (isoString) {
          try {
            const date = new Date(isoString);
            return date.toLocaleDateString("vi-VN");
          } catch (e) {
            return "N/A";
          }
        };
      }

      // Hàm Hỗ trợ UI: Render bảng
      if (typeof window.UI.renderTableRows !== "function") {
        window.UI.renderTableRows = function (tbodyId, rowsArray) {
          const tbody = document.getElementById(tbodyId);
          if (tbody) {
            tbody.innerHTML = rowsArray
              .map((row) => `<tr class="hover:bg-gray-50">${row}</tr>`)
              .join("");
          }
        };
      }

      // Hàm Hỗ trợ UI: Hiển thị/Ẩn view (cần thiết cho open/closeViewSalaryView)
      // Giả định hàm này được sử dụng cho UI/Modal
      window.safeShow = function (id) {
        const el = document.getElementById(id);
        if (el) el.classList.remove("hidden");
      };
      window.safeHide = function (id) {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      };
      window.UI.displayMessage = function (message, type = "info") {
        console.log(`[Message: ${type}] ${message}`);
        // Trong ứng dụng thực tế, bạn sẽ hiển thị modal/toast ở đây.
      };

      /**
       * Mã hóa email để làm key RTDB (thay thế TẤT CẢ dấu chấm '.' bằng dấu phẩy ',')
       */
      window.encodeEmailKey = function (email) {
        // Tương thích với cấu trúc RTDB của bạn (ví dụ: p@gmail,com)
        return (email || "").replace(/\./g, ",");
      };

      // Mở view xem lương cá nhân
      window.openViewSalaryView = function () {
        safeShow("user-salary-view");
        window.loadUserSalarySlips();
      };

      // Đóng view xem lương cá nhân
      window.closeViewSalaryView = function () {
        safeHide("user-salary-view");
      };

      // Tải phiếu lương cá nhân từ RTDB
      window.loadUserSalarySlips = async function () {
        // 1. Lấy thông tin người dùng
        const userEmail =
          auth && auth.currentUser && auth.currentUser.email
            ? auth.currentUser.email
            : mockUserEmail; // Fallback về mock email nếu chưa đăng nhập

        // Xóa bảng cũ và hiển thị trạng thái tải
        UI.renderTableRows("user-salary-body", [
          `<td colspan="7" class="text-center py-4 text-blue-500 font-medium animate-pulse">Đang tải dữ liệu phiếu lương...</td>`,
        ]);

        if (!userEmail) {
          UI.displayMessage(
            "Lỗi: Không tìm thấy thông tin đăng nhập người dùng.",
            "error"
          );
          UI.renderTableRows("user-salary-body", [
            `<td colspan="7" class="text-center py-4 text-red-500">Lỗi: Vui lòng đăng nhập để xem phiếu lương.</td>`,
          ]);
          return;
        }

        const emailKey = window.encodeEmailKey(userEmail);
        const emailDisplayEl = document.getElementById("user-salary-email");
        if (emailDisplayEl) emailDisplayEl.textContent = userEmail;

        console.log(`[Xem Lương] Email đăng nhập: ${userEmail}`);
        console.log(
          `[Xem Lương] Key RTDB cần truy vấn: /PhieuLuong/${emailKey}`
        );

        try {
          let snap;

          // SỬA LỖI: KIỂM TRA dbRef VÀ dbGet (tên đã import) thay vì ref/get (tên gốc)
          if (
            typeof dbRef === "function" &&
            typeof rtdb !== "undefined" &&
            typeof dbGet === "function"
          ) {
            // 2. Truy vấn RTDB THẬT: /PhieuLuong/{email_key}
            const dbRefInstance = dbRef(rtdb, `/PhieuLuong/${emailKey}`);
            snap = await dbGet(dbRefInstance);

            if (!snap.exists()) {
              console.warn(
                `[Xem Lương] Key RTDB /PhieuLuong/${emailKey} không tồn tại dữ liệu thật.`
              );
            }
          } else {
            // 2. Truy vấn MOCK DATA
            console.warn(
              "🚨 Hàm 'dbRef', 'dbGet' hoặc đối tượng 'rtdb' chưa sẵn sàng. Sử dụng dữ liệu mock."
            );
            // Sử dụng hàm mock data helper
            snap = window.dbGetMock({ path: `/PhieuLuong/${emailKey}` });

            if (snap.exists()) {
              UI.displayMessage(
                "Đang dùng dữ liệu thử nghiệm (mock data). Vui lòng đảm bảo `rtdb` và `dbRef` đã được cấu hình nếu muốn dùng dữ liệu thật.",
                "warning"
              );
            }
          }

          // 3. Xử lý kết quả
          const slips = [];
          if (snap && snap.exists && snap.exists()) {
            const allSlips = snap.val();
            for (const slipId in allSlips) {
              // Kiểm tra và đẩy dữ liệu vào mảng
              if (allSlips[slipId] && typeof allSlips[slipId] === "object") {
                slips.push({ slipId: String(slipId), ...allSlips[slipId] });
              } else {
                console.warn(
                  `[Xem Lương] Bỏ qua dữ liệu không hợp lệ cho slipId: ${slipId}`
                );
              }
            }
          }

          // Sắp xếp theo ID phiếu (giả định PL_timestamp) để phiếu mới nhất lên đầu
          slips.sort((a, b) => b.slipId.localeCompare(a.slipId));
          window.renderUserSalarySlips(slips);
        } catch (e) {
          console.error("loadUserSalarySlips error:", e);
          UI.displayMessage(`Lỗi tải phiếu lương: ${e.message}`, "error");
          UI.renderTableRows("user-salary-body", [
            `<td colspan="7" class="text-center py-4 text-red-500">Lỗi tải dữ liệu: ${e.message}</td>`,
          ]);
        }
      };

      // Hiển thị phiếu lương cá nhân ra bảng
      window.renderUserSalarySlips = function (slips) {
        if (slips.length === 0) {
          UI.renderTableRows("user-salary-body", [
            `<td colspan="7" class="text-center py-4 text-gray-500">Bạn chưa có phiếu lương nào được xuất.</td>`,
          ]);
          return;
        }

        // Hàm định dạng tiền tệ VNĐ
        const formatVND = (amount) =>
          (amount || 0).toLocaleString("vi-VN") + " đ";

        const rows = slips.map((slip) => {
          // Đảm bảo tất cả các trường đều là số hoặc 0
          const total = parseFloat(slip.total) || 0;
          const luongCung = parseFloat(slip.luong_cung) || 0;
          const phuCap = parseFloat(slip.phu_cap) || 0;
          const thuong = parseFloat(slip.thuong) || 0;
          const hours = parseFloat(slip.hours) || 0;
          const createdAt = slip.createdAt
            ? UI.formatDate(slip.createdAt)
            : "N/A";

          return `
        <td class="px-4 py-2 text-sm text-gray-900 font-medium">${String(
          slip.slipId
        ).replace("PL_", "#")}</td>
        <td class="px-4 py-2 text-sm text-gray-600">${createdAt}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${hours}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${formatVND(
          luongCung
        )}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${formatVND(
          phuCap
        )}</td>
        <td class="px-4 py-2 text-sm text-gray-700 text-right">${formatVND(
          thuong
        )}</td>
        <td class="px-4 py-2 text-sm text-green-700 font-bold text-right">${formatVND(
          total
        )}</td>
    `;
        });

        UI.renderTableRows("user-salary-body", rows);
      };
    </script>
  </body>
</html>
